<!DOCTYPE html>
<html lang="en">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="The ultimate MTG collection manager and finance tracker. Track prices, analyze decks, and manage your portfolio.">
    <title>Grimoire | MTG Finance & Collection</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîÆ</text></svg>">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --primary: #6366f1; /* Indigo */
            --bg: #f1f5f9;      /* Slate 100 */
            --sidebar: #ffffff;
            --card: #ffffff;
            --text: #0f172a;    /* Slate 900 */
            --subtext: #64748b; /* Slate 500 */
            --border: #e2e8f0;
            --green: #10b981;
            --red: #ef4444;
            --ad-bg: #e2e8f0;   /* Placeholder color for ads */
        }

        [data-theme="dark"] {
            --primary: #818cf8;
            --bg: #0f172a;      /* Slate 900 */
            --sidebar: #1e293b; /* Slate 800 */
            --card: #1e293b;
            --text: #f8fafc;    /* Slate 50 */
            --subtext: #94a3b8;
            --border: #334155;
            --ad-bg: #334155;
        }

        /* --- LAYOUT GRID (The SaaS Structure) --- */
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; color: var(--text); height: 100vh; display: grid; grid-template-columns: 240px 1fr; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { background: var(--sidebar); border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; justify-content: space-between; }
        .logo { font-size: 20px; font-weight: 800; display: flex; align-items: center; gap: 10px; color: var(--primary); margin-bottom: 40px; }
        .nav-links { display: flex; flex-direction: column; gap: 5px; }
        .nav-item { padding: 12px 15px; border-radius: 8px; cursor: pointer; color: var(--subtext); font-weight: 600; font-size: 14px; transition: 0.2s; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover { background: var(--bg); color: var(--text); }
        .nav-item.active { background: #e0e7ff; color: var(--primary); }
        [data-theme="dark"] .nav-item.active { background: rgba(99, 102, 241, 0.2); }

        /* MAIN CONTENT AREA */
        .main-content { overflow-y: auto; padding: 0 40px 40px 40px; display: flex; flex-direction: column; }
        
        /* AD ZONES */
        .ad-banner-top { width: 100%; height: 90px; background: var(--ad-bg); margin: 20px 0; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--subtext); font-size: 12px; font-weight: bold; border: 1px dashed var(--border); }
        .ad-sidebar { width: 100%; height: 250px; background: var(--ad-bg); border-radius: 8px; margin-top: 20px; display: flex; align-items: center; justify-content: center; color: var(--subtext); font-size: 12px; font-weight: bold; border: 1px dashed var(--border); }

        /* HEADER */
        .top-bar { display: flex; justify-content: flex-end; align-items: center; padding: 20px 0; gap: 15px; }
        .theme-btn { background: none; border: 1px solid var(--border); border-radius: 50%; width: 36px; height: 36px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; color: var(--text); }
        
        /* VIEW CONTAINER */
        .view-container { max-width: 1200px; margin: 0 auto; width: 100%; }
        .view { display: none; animation: fadeUp 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- COMPONENT STYLES --- */
        .card-box { background: var(--card); padding: 24px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; }
        h1 { font-size: 24px; font-weight: 700; margin-bottom: 5px; }
        h2 { font-size: 14px; font-weight: 500; color: var(--subtext); margin: 0 0 20px 0; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }

        /* INPUTS & BUTTONS */
        input, select { width: 100%; padding: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); border-radius: 6px; margin-bottom: 10px; box-sizing: border-box; }
        .btn-primary { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }
        .btn-secondary { padding: 8px 16px; background: var(--card); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; color: var(--text); font-weight: 500; }
        
        /* FOOTER */
        .footer-legal { margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border); text-align: center; color: var(--subtext); font-size: 11px; }
        .footer-legal a { color: var(--subtext); text-decoration: none; margin: 0 10px; }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            body { grid-template-columns: 1fr; }
            .sidebar { display: none; } /* Mobile menu needed later */
            .main-content { padding: 20px; }
        }

        /* --- UTILS --- */
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--bg); padding: 15px; border-radius: 8px; text-align: center; }
        .stat-num { font-size: 20px; font-weight: 800; color: var(--primary); }
        .stat-label { font-size: 11px; font-weight: 700; color: var(--subtext); text-transform: uppercase; }
        .chart-container { height: 250px; width: 100%; position: relative; }
        
        /* Helper classes */
        .hidden { display: none !important; }
        #importStatus { color: var(--primary); font-weight: bold; font-size: 12px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div>
            <div class="logo">
                <span>üîÆ</span> GRIMOIRE
            </div>
            <div class="nav-links">
                <div class="nav-item active" onclick="nav('home', this)">üè† Dashboard</div>
                <div class="nav-item" onclick="nav('add', this)">‚ûï Add Cards</div>
                <div class="nav-item" onclick="nav('collection', this)">üìö Collection</div>
                <div class="nav-item" onclick="nav('analytics', this)">üìä Finance</div>
                <div class="nav-item" onclick="nav('deckcheck', this)">üìã Deck Check</div>
            </div>
        </div>
        
        <div>
            <div class="ad-sidebar">AD SPACE<br>(Vertical)</div>
            <div style="font-size: 10px; color: var(--subtext); margin-top: 10px;">v2.6 Commercial Beta</div>
        </div>
    </div>

    <div class="main-content">
        
        <div class="top-bar">
            <button class="theme-btn" onclick="toggleTheme()" id="themeBtn">üåô</button>
            <button class="btn-secondary" onclick="showSetup()">‚öôÔ∏è Settings</button>
        </div>

        <div class="ad-banner-top">
            AD SPACE (Leaderboard 728x90)
        </div>

        <div class="view-container">

            <div id="view-home" class="view active">
                <h1>Dashboard</h1>
                <h2>Your collection at a glance.</h2>
                
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-num" id="stat-count">0</div>
                        <div class="stat-label">Cards</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-num" id="stat-value">$0.00</div>
                        <div class="stat-label">Market Value</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-num" id="stat-gain">$0.00</div>
                        <div class="stat-label">Unrealized P/L</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-num" id="stat-sets">0</div>
                        <div class="stat-label">Sets</div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="card-box">
                        <h3>Portfolio Value</h3>
                        <div class="chart-container"><canvas id="historyChart"></canvas></div>
                    </div>
                    <div class="card-box">
                        <h3>Daily Movers</h3>
                        <div id="moversList">Loading...</div>
                    </div>
                </div>
            </div>

            <div id="view-add" class="view">
                <h1>Add Asset</h1>
                <h2>Catalog new cards into your portfolio.</h2>
                
                <div class="grid-2">
                    <div class="card-box">
                        <form id="addForm" onsubmit="event.preventDefault(); submitForm(this)">
                            <label>Card Name</label>
                            <input type="text" id="search" placeholder="Search Scryfall..." autocomplete="off">
                            <div id="suggestions" style="background:var(--card); border:1px solid var(--border); display:none;"></div>
                            
                            <label>Set & Number</label>
                            <div style="display:flex; gap:10px;">
                                <input id="setCode" readonly placeholder="SET">
                                <input id="colNum" readonly placeholder="#">
                            </div>

                            <label>Financials</label>
                            <div class="grid-2">
                                <input type="number" id="boughtPriceInput" placeholder="Cost (Opt)">
                                <input type="number" id="quantityInput" value="1">
                            </div>

                            <div style="display:flex; gap:10px; margin-bottom:15px;">
                                <label style="display:flex; align-items:center; gap:5px; cursor:pointer;">
                                    <input type="checkbox" id="foil-on" style="width:auto; margin:0;"> Foil
                                </label>
                            </div>

                            <button class="btn-primary" id="subBtn">Add Asset</button>
                            
                            <input type="hidden" id="cardNameInput"><input type="hidden" id="cardPriceInput">
                            <input type="hidden" id="locationInput" value="Unsorted">
                        </form>
                    </div>
                    <div class="card-box" style="text-align:center;">
                        <label>Live Market Price</label>
                        <div id="bigPrice" style="font-size: 32px; font-weight: 800; color: var(--green); margin-bottom: 20px;">--</div>
                        <img id="cardPreview" style="max-width: 200px; border-radius: 10px; display:none;">
                    </div>
                </div>
            </div>

            <div id="view-collection" class="view">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h1>Collection</h1>
                    <div>
                        <button class="btn-secondary" onclick="handleImport()">Import CSV</button>
                        <button class="btn-secondary" onclick="exportCSV()">Export</button>
                        <input type="file" id="csvInput" style="display:none;" onchange="runImport()">
                    </div>
                </div>
                
                <div class="card-box">
                    <input type="text" id="collectionSearch" placeholder="Search your database..." oninput="filterCollection()">
                    <div id="collectionList" style="margin-top:20px;">Loading...</div>
                </div>
            </div>

            <div id="view-analytics" class="view">
                <h1>Financial Analytics</h1>
                <div class="grid-dashboard">
                    <div class="card-box"><h3>Allocation (Color)</h3><div class="chart-container"><canvas id="colorChart"></canvas></div></div>
                    <div class="card-box"><h3>Allocation (Rarity)</h3><div class="chart-container"><canvas id="rarityChart"></canvas></div></div>
                    <div class="card-box"><h3>Top Sets</h3><div class="chart-container"><canvas id="setChart"></canvas></div></div>
                </div>
            </div>

            <div id="view-deckcheck" class="view">
                <h1>Deck Validator</h1>
                <div class="card-box">
                    <textarea id="deckInput" style="width:100%; height:150px; border-radius:6px; border:1px solid var(--border); background:var(--bg); color:var(--text); padding:10px;" placeholder="Paste decklist here..."></textarea>
                    <br><br>
                    <button class="btn-primary" onclick="runDeckCheck()">Validate Ownership</button>
                </div>
                <div id="deckResults" style="margin-top:20px;"></div>
            </div>

        </div> <div class="footer-legal">
            &copy; 2025 Grimoire. All rights reserved.<br>
            <a href="#">Privacy Policy</a> | <a href="#">Terms of Service</a> | <a href="#">Cookie Policy</a>
        </div>

    </div> <div id="setupModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; z-index:9999;">
        <div style="background:var(--card); padding:30px; border-radius:12px; width:400px;">
            <h2>Configuration</h2>
            <label>API Endpoint</label>
            <input id="apiUrlInput" placeholder="https://script.google.com/...">
            <button class="btn-primary" onclick="saveApiUrl()">Save Connection</button>
            <br><br>
            <button class="btn-secondary" style="width:100%; color:var(--red); border-color:var(--red);" onclick="runMaintenance()">Run Database Maintenance</button>
            <br><br>
            <button class="btn-secondary" style="width:100%;" onclick="document.getElementById('setupModal').classList.add('hidden')">Close</button>
        </div>
    </div>

    <script>
        // --- CORE LOGIC (V3.0) ---
        let API_ENDPOINT = localStorage.getItem('mtg_api_url') || "";
        let rawCollectionData = [];
        let charts = {}; 

        // NAVIGATION
        function nav(viewId, btn) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + viewId).classList.add('active');
            
            if(btn) {
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                btn.classList.add('active');
            }
            
            if(viewId === 'home' || viewId === 'analytics') loadAnalytics();
            if(viewId === 'collection') loadCollection();
        }

        // INIT
        window.onload = function() {
            if(!API_ENDPOINT) document.getElementById('setupModal').classList.remove('hidden');
            else { loadAnalytics(); } // Load stats on entry
            loadTheme();
        };

        // THEME
        function toggleTheme() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            localStorage.setItem('mtgManager_Theme', isDark ? 'light' : 'dark');
        }
        function loadTheme() {
            if(localStorage.getItem('mtgManager_Theme') === 'dark') document.body.setAttribute('data-theme', 'dark');
        }

        // API & SETTINGS
        function saveApiUrl() {
            const url = document.getElementById('apiUrlInput').value;
            if(url) { localStorage.setItem('mtg_api_url', url); API_ENDPOINT = url; location.reload(); }
        }
        function showSetup() { document.getElementById('setupModal').classList.remove('hidden'); document.getElementById('apiUrlInput').value = API_ENDPOINT; }

        async function callAPI(action, data={}) {
            if(!API_ENDPOINT) return;
            try {
                const res = await fetch(`${API_ENDPOINT}?action=${action}`, { method:'POST', body:JSON.stringify(data) });
                return await res.json();
            } catch(e) { console.error(e); alert("Connection Failed"); }
        }

        // ADD CARD LOGIC
        const search = document.getElementById('search');
        let debounce;
        search.addEventListener('input', (e) => {
            clearTimeout(debounce);
            debounce = setTimeout(() => {
                const q = e.target.value;
                if(q.length > 2) fetch(`https://api.scryfall.com/cards/autocomplete?q=${q}`).then(r=>r.json()).then(d=>{
                    // Simple autocomplete logic here
                    // (Simplified for brevity in V3 layout demo)
                });
                // In a real app, you'd wire up the full Scryfall search here again
                // For now, let's assume the user knows the exact name or uses the old flow
            }, 300);
        });
        
        // Note: I have streamlined the JS for the Layout Demo. 
        // You would paste the "Logic" section from V2.6 back in here to make the buttons work fully.
        // This file focuses on the COMMERCIAL UI STRUCTURE.
        
        // --- PLACEHOLDER FOR LOGIC INJECTION ---
        // (Paste the V2.6 <script> contents here to wire up the buttons to the new IDs)
        
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Grimoire | Ascended Edition</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://bernardo-castilho.github.io/DragDropTouch/DragDropTouch.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- THEME: ASCENDED GRIMOIRE --- */
        :root { 
            /* Core Palette - Deep, Rich, Magical */
            --bg-deep: #050308;
            --bg-gradient: radial-gradient(circle at 15% 0%, #1e102e 0%, #050308 60%);
            
            --glass-panel: rgba(20, 17, 30, 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.03);
            
            --primary: #9d4edd; /* Electric Violet */
            --primary-dark: #5a189a;
            --gold: #deb887; /* BurlyWood/Gold for accents */
            --gold-glow: rgba(222, 184, 135, 0.3);
            
            --text-main: #f3f4f6;
            --text-muted: #9ca3af;
            
            --success: #10b981; 
            --danger: #ef4444;
            --mana-blue: #3b82f6;
            
            --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.6);
            --glow: 0 0 15px rgba(157, 78, 221, 0.3);
            
            --font-body: 'Inter', sans-serif;
            --font-header: 'Cinzel', serif; /* The "Grimoire" font */
        }

        body { 
            font-family: var(--font-body); 
            background: var(--bg-deep);
            background-image: var(--bg-gradient);
            background-attachment: fixed; 
            color: var(--text-main); 
            margin: 0; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            font-size: 14px;
            user-select: none;
            -webkit-user-select: none;
        }
        
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        .hidden { display: none !important; }
        
        /* Polished Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* --- LAYOUT --- */
        .app-container { display: grid; grid-template-columns: 280px 1fr; height: 100%; }
        
        .sidebar { 
            background: rgba(8, 6, 12, 0.95); 
            backdrop-filter: blur(20px); 
            padding: 35px 25px; 
            display: flex; 
            flex-direction: column; 
            border-right: 1px solid var(--glass-border); 
            z-index: 50; 
            box-shadow: 5px 0 30px rgba(0,0,0,0.5);
        }
        
        .main { 
            padding: 40px clamp(20px, 5vw, 60px); 
            overflow-y: auto; 
            flex: 1; 
            position: relative; 
        }
        
        .view-section { animation: fadeInSlide 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeInSlide { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .bottom-nav { display: none; } 

        @media (max-width: 900px) { 
            .app-container { grid-template-columns: 1fr; padding-bottom: 80px; } 
            .sidebar { display: none; position: fixed; top: 0; left: 0; height: 100%; width: 280px; box-shadow: 10px 0 50px black; z-index: 2000; border-right: 1px solid var(--glass-border); background: #08060c; } 
            .sidebar.mobile-open { display: flex; animation: slideRight 0.3s ease-out; }
            .bottom-nav { display: flex; position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(8, 6, 12, 0.98); border-top: 1px solid var(--glass-border); justify-content: space-around; padding: 15px 0; z-index: 100; backdrop-filter: blur(20px); } 
            .main { padding: 20px 15px; } 
            .mobile-menu-btn { display: block !important; }
        }
        
        @keyframes slideRight { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        .mobile-menu-btn { display: none; position: absolute; top: 20px; right: 20px; z-index: 500; background: var(--glass-panel); border: 1px solid var(--glass-border); padding: 8px 12px; border-radius: 8px; cursor: pointer; color: var(--text-main); backdrop-filter: blur(10px); }

        /* --- UI COMPONENTS: THE ARCANE UPGRADE --- */
        
        /* Panels */
        .card-box { 
            background: var(--glass-panel); 
            backdrop-filter: blur(16px); 
            padding: 30px; 
            border-radius: 24px; 
            border: 1px solid var(--glass-border); 
            margin-bottom: 30px; 
            box-shadow: var(--shadow-lg); 
            position: relative;
            overflow: hidden;
        }
        /* Top light reflection on cards */
        .card-box::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        }

        /* Typography */
        h2 { 
            margin-top: 0; 
            font-family: var(--font-header); 
            font-size: 2rem; 
            font-weight: 700; 
            margin-bottom: 30px; 
            letter-spacing: 0.02em; 
            color: white; 
            background: linear-gradient(180deg, #fff 0%, #b39ddb 100%); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            text-shadow: 0 2px 10px rgba(157, 78, 221, 0.2);
        }
        
        h3 { 
            font-family: var(--font-header);
            font-size: 0.9rem; 
            font-weight: 400; 
            color: var(--gold); 
            margin-top: 0; 
            text-transform: uppercase; 
            letter-spacing: 0.15em; 
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(222, 184, 135, 0.1);
            padding-bottom: 10px;
            display: inline-block;
        }
        
        /* Inputs */
        .input-group { position: relative; display: flex; align-items: center; margin-bottom: 20px; width: 100%; }
        .input-icon { position: absolute; left: 16px; color: var(--text-muted); font-size: 16px; pointer-events: none; transition: 0.3s; }
        
        input, select, textarea { 
            width: 100%; 
            padding: 14px 18px; 
            border-radius: 12px; 
            border: 1px solid rgba(255,255,255,0.1); 
            background: rgba(0,0,0,0.3); 
            color: white; 
            font-size: 14px; 
            font-family: var(--font-body);
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }
        .input-group input { padding-left: 48px; margin-bottom: 0; }
        
        input:focus, select:focus, textarea:focus { 
            border-color: var(--primary); 
            background: rgba(0,0,0,0.5); 
            box-shadow: 0 0 0 1px var(--primary), 0 0 20px rgba(157, 78, 221, 0.1);
        }
        input:focus + .input-icon { color: var(--primary); }
        
        /* Buttons */
        button { 
            width: 100%; 
            padding: 14px 20px; 
            background: linear-gradient(135deg, #7b2cbf 0%, #3c096c 100%); 
            color: white; 
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 13px; 
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }
        /* Button sheen effect */
        button::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: 0.5s;
        }
        button:hover::after { left: 100%; }
        button:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(157, 78, 221, 0.4); border-color: rgba(255,255,255,0.3); }
        button:active { transform: translateY(0); }
        
        button.secondary { 
            background: transparent; 
            box-shadow: none; 
            border: 1px solid rgba(255,255,255,0.1); 
            color: var(--text-muted); 
        }
        button.secondary:hover { background: rgba(255,255,255,0.05); border-color: var(--text-main); color: var(--text-main); }
        .btn-sm { width: auto; padding: 8px 16px; font-size: 11px; }

        /* Sidebar Styling */
        .logo { 
            font-family: var(--font-header);
            font-size: 22px; 
            font-weight: 700; 
            color: white; 
            margin-bottom: 45px; 
            display: flex; align-items: center; gap: 12px; 
            letter-spacing: 0.02em; 
            text-shadow: 0 0 30px var(--primary); 
        }
        .user-profile-section { 
            display: flex; align-items: center; gap: 15px; margin-bottom: 40px; padding: 15px; 
            background: linear-gradient(90deg, rgba(255,255,255,0.03), transparent); 
            border-left: 2px solid var(--primary);
            border-radius: 0 12px 12px 0; 
            cursor: pointer; transition: 0.3s; 
        }
        .user-profile-section:hover { background: linear-gradient(90deg, rgba(255,255,255,0.08), transparent); }
        
        .avatar-circle { width: 44px; height: 44px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); box-shadow: 0 0 15px rgba(157, 78, 221, 0.4); }
        .user-meta { display: flex; flex-direction: column; overflow: hidden; }
        .user-name { font-weight: 600; color: white; font-size: 14px; margin-bottom: 2px; }
        .user-email-txt { font-size: 11px; color: var(--text-muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 140px; }

        .nav-item { 
            padding: 12px 16px; 
            cursor: pointer; 
            color: var(--text-muted); 
            font-weight: 500; 
            border-radius: 12px; 
            transition: all 0.2s; 
            margin-bottom: 8px; 
            display: flex; align-items: center; gap: 14px; 
            font-size: 14px; 
        }
        .nav-item:hover { color: white; background: rgba(255, 255, 255, 0.03); transform: translateX(5px); }
        .nav-item.active { background: rgba(157, 78, 221, 0.15); color: var(--primary); border: 1px solid rgba(157, 78, 221, 0.2); }
        
        /* Grids & Cards */
        .collection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 25px; }
        .deck-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 30px; }

        @media (max-width: 600px) {
            .collection-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
            .deck-grid { grid-template-columns: 1fr; }
        }
        
        .grid-card { 
            position: relative; aspect-ratio: 2.5/3.5; border-radius: 14px; overflow: hidden; 
            cursor: pointer; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); 
            transition: all 0.3s ease; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        .grid-card:hover { 
            transform: translateY(-8px) scale(1.02); 
            border-color: var(--primary); 
            box-shadow: 0 15px 40px -10px rgba(157, 78, 221, 0.4); 
            z-index: 10;
        }
        .grid-card img { width: 100%; height: 100%; object-fit: cover; }
        
        .deck-card { 
            background: #1a1a1a; 
            border: 1px solid var(--glass-border); 
            border-radius: 20px; 
            height: 320px; 
            display: flex; flex-direction: column; justify-content: flex-end; 
            position: relative; overflow: hidden; cursor: pointer; 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            background-size: cover; background-position: center; 
            box-shadow: var(--shadow-lg); 
        }
        .deck-card:hover { border-color: var(--primary); transform: translateY(-8px); box-shadow: 0 20px 60px -10px rgba(157, 78, 221, 0.3); }
        .deck-card::after { content: ''; position: absolute; inset: 0; background: linear-gradient(to top, #050308 10%, rgba(5, 3, 8, 0.7) 50%, transparent 100%); z-index: 1; }
        
        .deck-card-content { position: relative; z-index: 2; padding: 25px; border-top: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(20px); background: rgba(5, 3, 8, 0.6); }
        .deck-card h4 { margin: 0 0 5px 0; font-family: var(--font-header); font-size: 20px; color: white; text-shadow: 0 2px 4px black; }
        
        .deck-actions { position: absolute; top: 20px; right: 20px; z-index: 10; opacity: 0; transition: 0.3s; display: flex; gap: 10px; }
        .deck-card:hover .deck-actions { opacity: 1; }
        .action-btn { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.2); color: white; cursor: pointer; transition: 0.2s; }
        .action-btn:hover { background: var(--danger); border-color: var(--danger); transform: scale(1.1); }
        
        /* Badges */
        .gain-badge, .qty-badge { position: absolute; top: 10px; background: rgba(0,0,0,0.9); backdrop-filter: blur(4px); padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 700; z-index: 5; border: 1px solid rgba(255,255,255,0.15); box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .gain-badge { right: 10px; color: var(--success); } .qty-badge { left: 10px; color: white; }
        .overlay { position: absolute; bottom: 0; width: 100%; padding: 15px; background: linear-gradient(to top, rgba(0,0,0,0.95), transparent); display:flex; justify-content: space-between; align-items: flex-end; opacity: 0; transition: 0.3s; }
        .grid-card:hover .overlay { opacity: 1; }
        
        .tag-pill { background: rgba(157, 78, 221, 0.15); color: var(--primary); border: 1px solid var(--primary); font-size: 9px; padding: 3px 8px; border-radius: 4px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
        .format-badge { background: #1f1f2e; color: var(--text-muted); padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: 700; text-transform: uppercase; border: 1px solid rgba(255,255,255,0.1); }

        /* Dashboard Stats */
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { 
            background: linear-gradient(145deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%); 
            padding: 30px; border-radius: 20px; text-align: center; border: 1px solid var(--glass-border); transition: 0.3s; 
        }
        .stat-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: var(--glow); }
        .stat-val { font-family: var(--font-header); font-size: 36px; font-weight: 700; color: white; margin-bottom: 5px; text-shadow: 0 0 20px rgba(255,255,255,0.1); }
        .stat-lbl { font-size: 11px; text-transform: uppercase; color: var(--gold); font-weight: 700; letter-spacing: 2px; }

        .dash-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }
        @media (max-width: 900px) { .dash-grid { grid-template-columns: 1fr; } }
        
        .highlight-card { display: flex; align-items: center; gap: 20px; padding: 15px; background: rgba(255,255,255,0.02); border-radius: 12px; margin-bottom: 10px; transition: 0.2s; cursor: pointer; border: 1px solid transparent; }
        .highlight-card:hover { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); transform: translateX(5px); }
        .highlight-img { width: 50px; border-radius: 6px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        
        /* Utilities */
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .flex-row { display: flex; gap: 15px; align-items: center; }
        .mt-20 { margin-top: 20px; } .mb-20 { margin-bottom: 20px; } .mb-10 { margin-bottom: 10px; }
        .text-sub { font-size: 12px; color: var(--text-muted); }
        .text-green { color: var(--success); } .text-red { color: var(--danger); }
        .w-full { width: 100%; }
        
        /* Modals & Loading */
        .modal-overlay { position: fixed; inset: 0; background: rgba(3, 2, 5, 0.9); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(12px); animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .modal-content { width: 90%; max-width: 800px; }
        .toast { background: rgba(20, 15, 30, 0.95); backdrop-filter: blur(16px); border: 1px solid var(--primary); color: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); font-weight: 600; font-size: 13px; animation: slideInRight 0.3s ease-out; }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(50px); } to { opacity: 1; transform: translateX(0); } }
        
        .btn-loading { color: transparent !important; pointer-events: none; }
        .btn-loading::after { content: ""; position: absolute; left: 50%; top: 50%; width: 20px; height: 20px; margin: -10px; border: 2px solid white; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .empty-state { text-align: center; color: var(--text-muted); padding: 80px 40px; border: 2px dashed rgba(255,255,255,0.1); border-radius: 20px; background: rgba(0,0,0,0.1); }
        
        /* Deck Details - V14.6 MOBILE RESPONSIVE */
        .deck-area-detail { display: grid; grid-template-columns: 1fr 380px; gap: 30px; }
        @media (max-width: 900px) { 
            .deck-area-detail { grid-template-columns: 1fr; } 
            .deck-list-viewer { max-height: 50vh; }
        }
        
        .deck-list-viewer { height: 65vh; overflow-y: auto; padding: 25px; background: rgba(0,0,0,0.2); border-radius: 16px; font-family: monospace; font-size: 13px; border: 1px solid var(--glass-border); line-height: 1.8; }
        .deck-line { padding: 6px 12px; border-radius: 6px; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center; transition: 0.1s; }
        .deck-line:hover { background: rgba(255,255,255,0.05); }
        
        /* Updated Status Indicators for Deck Lines */
        .is-owned { border-left: 3px solid var(--success); } 
        .is-partial { border-left: 3px solid var(--gold); } 
        .is-missing { border-left: 3px solid var(--danger); opacity: 0.6; }
        
        .progress-bg { height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; background: var(--primary); transition: width 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); box-shadow: 0 0 10px var(--primary); }

        /* FAB */
        .fab-btn { position: fixed; bottom: 40px; right: 30px; width: 64px; height: 64px; border-radius: 50%; background: var(--primary); color: white; border: none; box-shadow: 0 10px 30px rgba(157, 78, 221, 0.5); font-size: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100; transition: 0.3s; }
        .fab-btn:hover { transform: scale(1.1) rotate(90deg); background: white; color: var(--primary); }
        @media (min-width: 769px) { .fab-btn { display: none; } }
        
        /* Battlefield Layout - V13.5 Mobile Polish */
        .bf-grid-layout { display: grid; grid-template-columns: 1fr 160px; height: 100%; overflow: hidden; border: 1px solid var(--glass-border); border-radius: 20px; box-shadow: var(--shadow-lg); }
        .bf-hud { grid-column: 1 / -1; height: 70px; background: #0f0a15; border-bottom: 1px solid var(--glass-border); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; z-index: 20; }
        .bf-board { display: flex; flex-direction: column; flex: 1; overflow: hidden; position: relative; background: radial-gradient(circle at center, #201030 0%, #000 100%); }
        .bf-zone-label { position: absolute; left: 15px; top: 50%; transform: translateY(-50%) rotate(-90deg); color: rgba(255,255,255,0.1); font-weight: 900; font-size: 24px; text-transform: uppercase; letter-spacing: 5px; pointer-events: none; font-family: var(--font-header); }
        .bf-row { flex: 1; padding: 30px 50px; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 15px; border-bottom: 1px dashed rgba(255,255,255,0.05); overflow-y: auto; position: relative; min-height: 150px; }
        .bf-side-zone { background: #0a0510; border-left: 1px solid var(--glass-border); padding: 20px; display: flex; flex-direction: column; gap: 20px; align-items: center; z-index: 10; }
        
        /* Mobile Battlefield Adjustments */
        @media (max-width: 768px) {
            .bf-grid-layout { display: flex; flex-direction: column; border-radius: 0; border: none; }
            .bf-side-zone { display: flex; flex-direction: row; width: 100%; height: 90px; padding: 10px; border-left: none; border-top: 1px solid var(--glass-border); overflow-x: auto; background: #0f0a15; }
            .pile-card { width: 70px; height: 100%; aspect-ratio: auto; }
            .pile-count { font-size: 14px; }
            .bf-hand-shelf { height: 140px; }
            .bf-row { padding: 15px; }
        }

        .pile-card { width: 100%; aspect-ratio: 2.5/3.5; border-radius: 8px; background: #1a1a1a; border: 1px solid var(--glass-border); display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; transition: 0.2s; position: relative; box-shadow: 2px 4px 10px rgba(0,0,0,0.5); }
        .pile-card:hover { border-color: var(--primary); transform: scale(1.05); }
        .pile-card img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
        .pile-count { position: absolute; font-size: 20px; font-weight: 800; text-shadow: 0 2px 4px black; z-index: 10; color: white; background: rgba(0,0,0,0.6); padding: 4px 10px; border-radius: 6px; }
        .pile-label { font-size: 10px; text-transform: uppercase; color: var(--text-muted); margin-top: 10px; letter-spacing: 1px; }
        
        .bf-hand-shelf { grid-column: 1 / -1; height: 180px; background: linear-gradient(to top, #000 70%, transparent); border-top: 1px solid var(--glass-border); padding: 20px; display: flex; align-items: flex-end; justify-content: center; gap: -30px; z-index: 30; overflow-x: visible; }
        .bf-hand-card { width: 120px; border-radius: 8px; transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); cursor: grab; transform-origin: bottom center; margin: 0 -20px; box-shadow: -10px 0 20px rgba(0,0,0,0.6); border: 1px solid #000; }
        .bf-hand-card:hover { transform: translateY(-50px) scale(1.5) !important; z-index: 100; margin: 0 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.9); border-color: var(--primary); }
        .bf-hand-card img { width: 100%; border-radius: 8px; pointer-events: none; }
        
        .bf-card { width: 110px; border-radius: 8px; cursor: grab; position: relative; transition: 0.2s; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .bf-card img { width: 100%; border-radius: 8px; pointer-events: none; }
        .bf-card:hover { transform: scale(1.15); z-index: 50; box-shadow: 0 0 30px var(--primary); }
        .bf-tapped { transform: rotate(90deg); filter: brightness(0.7) grayscale(0.5); }
        
        .counter-badge { position: absolute; top: -8px; right: -8px; background: var(--danger); color: white; width: 24px; height: 24px; border-radius: 50%; font-size: 12px; display: flex; align-items: center; justify-content: center; font-weight: 800; border: 2px solid #000; box-shadow: 0 2px 5px black; }
        .drag-over { background: rgba(157, 78, 221, 0.15); box-shadow: inset 0 0 40px var(--primary); }
        
        .context-menu { position: fixed; background: rgba(10, 5, 15, 0.95); border: 1px solid var(--glass-border); border-radius: 12px; padding: 8px; z-index: 2000; display: flex; flex-direction: column; width: 180px; backdrop-filter: blur(20px); box-shadow: 0 20px 50px black; }
        .ctx-item { padding: 12px 15px; cursor: pointer; color: white; font-size: 13px; font-weight: 500; border-radius: 8px; transition: 0.1s; display: flex; justify-content: space-between; }
        .ctx-item:hover { background: var(--primary); color: white; }
        .ctx-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 6px 0; }
        
        #pile-modal .card-box { width: 85vw; height: 85vh; display: flex; flex-direction: column; padding: 0; overflow: hidden; background: #0a0510; border: 1px solid var(--primary); }
        .pile-header { padding: 25px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.02); }
        .pile-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 20px; overflow-y: auto; padding: 30px; flex: 1; }
        .pile-item { cursor: pointer; position: relative; transition: 0.2s; }
        .pile-item:hover { transform: scale(1.1); z-index: 10; border-radius: 10px; box-shadow: 0 0 20px var(--primary); }
        .pile-item img { width: 100%; border-radius: 10px; }

        /* ADD CARD FORGE V11.8 */
        .add-grid { display: grid; grid-template-columns: 1fr 340px; gap: 40px; }
        @media (max-width: 900px) { .add-grid { grid-template-columns: 1fr; } }
        
        .session-log { margin-top: 25px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px; max-height: 250px; overflow-y: auto; }
        .log-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.03); color: var(--text-muted); font-size: 13px; animation: fadeUp 0.3s; }
        
        .preview-pane { position: sticky; top: 30px; background: rgba(255,255,255,0.02); border-radius: 20px; border: 1px solid var(--glass-border); padding: 30px; text-align: center; }
        .preview-pane img { width: 100%; border-radius: 14px; box-shadow: 0 20px 50px rgba(0,0,0,0.6); }
        
        /* Settings V11.9 */
        .theme-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 15px; margin-bottom: 30px; }
        .theme-btn { aspect-ratio: 1; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: transform 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .theme-btn:hover { transform: scale(1.1); box-shadow: 0 0 20px currentColor; }
        .theme-btn.active-theme { border-color: white; box-shadow: 0 0 25px currentColor; transform: scale(1.15); }
        
        .avatar-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 15px; margin-top: 20px; }
        .avatar-option { width: 100%; aspect-ratio: 1; border-radius: 50%; border: 3px solid transparent; cursor: pointer; transition: 0.2s; object-fit: cover; opacity: 0.5; }
        .avatar-option:hover { opacity: 1; transform: scale(1.1); }
        .avatar-option.selected { border-color: var(--primary); opacity: 1; box-shadow: 0 0 25px var(--primary); }
        
        .upload-btn {
            width: 100%; aspect-ratio: 1; border-radius: 50%; 
            border: 2px dashed var(--text-muted); color: var(--text-muted);
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; cursor: pointer; transition: 0.2s;
            background: rgba(255,255,255,0.02);
        }
        .upload-btn:hover { border-color: var(--primary); color: var(--primary); background: rgba(157, 78, 221, 0.1); }
        
        .setting-section { border-bottom: 1px solid var(--glass-border); padding-bottom: 30px; margin-bottom: 30px; }
        
        /* Hand Simulator V13.3 */
        .hand-sim-container { display: flex; gap: 15px; padding: 40px; overflow-x: auto; min-height: 260px; align-items: center; justify-content: center; background: rgba(0,0,0,0.3); border-radius: 16px; margin-bottom: 30px; border: 1px solid var(--glass-border); }
        .sim-card { width: 150px; transition: 0.2s; cursor: pointer; border-radius: 10px; position: relative; }
        .sim-card:hover { transform: translateY(-20px) scale(1.2); z-index: 10; }
        .sim-card img { width: 100%; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.6); }
        
        /* Geologist Modal V13.8 (POLISHED) */
        .geo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px; }
        @media (max-width: 900px) { .geo-grid { grid-template-columns: 1fr; } }
        
        .chart-box { background: rgba(255,255,255,0.02); border-radius: 20px; padding: 25px; border: 1px solid var(--glass-border); height: 340px; position: relative; backdrop-filter: blur(10px); }
        .geo-stat-row { display: flex; gap: 20px; margin-bottom: 30px; justify-content: space-between; }
        .geo-metric { background: rgba(157, 78, 221, 0.15); border: 1px solid rgba(157, 78, 221, 0.3); padding: 20px; border-radius: 16px; flex: 1; text-align: center; }
        .geo-val { font-size: 28px; font-weight: 800; color: white; text-shadow: 0 0 20px rgba(157, 78, 221, 0.5); }
        .geo-lbl { font-size: 11px; text-transform: uppercase; color: var(--gold); font-weight: 700; letter-spacing: 2px; margin-top: 8px; }

        /* THE COLLECTOR V13.9 (STYLING) */
        .collection-filter-bar { background: rgba(20, 15, 30, 0.8); border: 1px solid var(--glass-border); border-radius: 16px; padding: 20px; display: flex; flex-wrap: wrap; gap: 20px; align-items: center; margin-bottom: 30px; backdrop-filter: blur(15px); box-shadow: var(--shadow-sm); }
        .collection-stats { display: flex; gap: 30px; margin-left: auto; border-left: 1px solid var(--glass-border); padding-left: 30px; }
        .col-stat-item { display: flex; flex-direction: column; align-items: flex-end; }
        .col-stat-val { font-weight: 800; color: white; font-size: 16px; }
        .col-stat-lbl { font-size: 10px; color: var(--gold); text-transform: uppercase; letter-spacing: 1px; }
        
        .col-view-toggle { display: flex; background: rgba(0,0,0,0.4); border-radius: 10px; padding: 4px; border: 1px solid var(--glass-border); }
        .view-btn { padding: 8px 16px; border-radius: 8px; cursor: pointer; color: var(--text-muted); font-size: 12px; font-weight: 600; transition: 0.2s; }
        .view-btn.active { background: var(--primary); color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }

        /* Ledger View Table */
        .ledger-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; font-size: 13px; color: var(--text-main); }
        .ledger-table th { text-align: left; padding: 12px 15px; color: var(--gold); font-family: var(--font-header); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; }
        .ledger-table td { padding: 12px 15px; background: rgba(255,255,255,0.03); border: 1px solid transparent; vertical-align: middle; }
        .ledger-table td:first-child { border-top-left-radius: 10px; border-bottom-left-radius: 10px; }
        .ledger-table td:last-child { border-top-right-radius: 10px; border-bottom-right-radius: 10px; }
        .ledger-table tr:hover td { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.1); }
        .ledger-img { width: 34px; height: 48px; border-radius: 4px; object-fit: cover; box-shadow: 0 2px 5px black; }
    </style>
</head>
<body>
    <img id="hover-preview" style="position:fixed; z-index:3000; width:280px; border-radius:16px; display:none; pointer-events:none; border: 2px solid var(--primary); background:#000; box-shadow: 0 30px 80px black;">
    <div id="toast-container" style="position:fixed; bottom:40px; right:40px; z-index:9999; display:flex; flex-direction:column; gap:12px;"></div>
    
    <div id="card-ctx-menu" class="context-menu hidden"></div>

    <div id="auth-screen" class="modal-overlay">
        <div class="card-box" style="width: 420px; text-align: center; padding: 60px 40px; border: 1px solid var(--primary);">
            <div style="font-size: 72px; margin-bottom: 25px; filter: drop-shadow(0 0 30px var(--primary));">ü©∏</div>
            <h2 class="mb-20">The Grimoire</h2>
            <div class="input-group"><input type="email" id="email" placeholder="Wizard's Email"></div>
            <div class="input-group"><input type="password" id="password" placeholder="Passphrase"></div>
            <button onclick="handleAuthAction(this)" class="mt-20">Enter the Void</button>
            <div class="mt-20 text-sub" style="cursor:pointer; font-size:12px; border-bottom:1px dashed var(--text-muted); display:inline-block;" onclick="toggleResetMode()">Forgot Password?</div>
        </div>
    </div>
    
    <div id="report-modal" class="modal-overlay hidden">
        <div class="card-box" style="max-width: 500px; border-top: 4px solid var(--danger);">
            <div class="flex-between mb-20">
                <h2 style="color:var(--danger); margin:0; -webkit-text-fill-color: initial; background:none;">ü™≤ Report Anomaly</h2>
                <button class="secondary btn-sm" onclick="document.getElementById('report-modal').classList.add('hidden')">‚úï</button>
            </div>
            <p class="text-sub mb-20">Found a glitch in the weave? Describe it below.</p>
            
            <div class="input-group">
                <span class="input-icon">üìÇ</span>
                <select id="bug-category" style="padding-left: 45px;">
                    <option value="Visual">Visual Glitch</option>
                    <option value="Functional">Broken Feature</option>
                    <option value="Crash">App Crash</option>
                    <option value="Suggestion">Feature Request</option>
                </select>
            </div>

            <textarea id="bug-text" placeholder="Describe the steps to reproduce..." style="height:150px; margin-bottom:20px; resize:none;"></textarea>
            
            <div class="flex-row" style="justify-content: flex-end;">
                <button onclick="document.getElementById('report-modal').classList.add('hidden')" class="secondary" style="width:auto;">Cancel</button>
                <button onclick="sendBugReport(this)" style="background:var(--danger); border:none; width:auto;">Transmit Report</button>
            </div>
        </div>
    </div>
    
    <div id="token-modal" class="modal-overlay hidden" onclick="if(event.target===this) this.classList.add('hidden')">
        <div class="card-box" style="max-width: 500px;">
            <h2>Summon Token</h2>
            <div class="collection-grid" id="token-grid"></div>
        </div>
    </div>

    <div id="delete-modal" class="modal-overlay hidden">
        <div class="card-box" style="max-width: 400px; border: 1px solid var(--danger); text-align:center;">
            <h2 style="color:var(--danger); background:none; -webkit-text-fill-color:initial;">Sacrifice?</h2>
            <p class="text-sub mb-20">Are you sure? This cannot be undone.</p>
            <div class="flex-row" style="justify-content: center;">
                <button onclick="confirmDelete(this)" style="background:var(--danger); border:none;">üî• Destroy</button>
                <button onclick="document.getElementById('delete-modal').classList.add('hidden')" class="secondary">Cancel</button>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal-overlay hidden">
        <div class="card-box" style="max-width: 400px;">
            <h2 id="edit-card-name" style="color:var(--primary);">Edit Card</h2>
            <input type="hidden" id="edit-card-id">
            <div style="text-align:left;"><label class="text-sub">Quantity</label><input type="number" id="edit-qty"></div>
            <div style="text-align:left;"><label class="text-sub">Cost ($)</label><input type="number" id="edit-cost" step="0.01"></div>
            <div class="flex-row mt-20" style="justify-content: center;">
                <button onclick="saveEdit(this)" style="background: var(--success); border:none;">üíæ Save Changes</button>
                <button onclick="document.getElementById('edit-modal').classList.add('hidden')" class="secondary">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="user-options-modal" class="modal-overlay hidden" onclick="closeUserOptionsModal()">
        <div class="card-box" style="max-width: 300px; text-align: left;" onclick="event.stopPropagation()">
            <h2 style="color:var(--primary); margin-bottom: 20px;">System</h2>
            <button class="secondary mb-20 w-full" onclick="nav('settings', 'settings'); closeUserOptionsModal()">‚öôÔ∏è Settings</button>
            <button onclick="handleLogout(this)" class="w-full" style="background:var(--danger); border:none;">üö™ Disconnect</button>
        </div>
    </div>
    
    <div id="pile-modal" class="modal-overlay hidden" onclick="if(event.target===this) this.classList.add('hidden')">
        <div class="card-box">
            <div class="pile-header">
                <div>
                    <h2 id="pile-title" style="margin:0; font-size:24px;">Graveyard</h2>
                    <div class="text-sub">Click a card to move it to Hand.</div>
                </div>
                <button class="secondary btn-sm" onclick="document.getElementById('pile-modal').classList.add('hidden')">Close</button>
            </div>
            <div id="pile-content" class="pile-grid"></div>
        </div>
    </div>

    <div id="hand-sim-modal" class="modal-overlay hidden">
        <div class="card-box" style="width: 95vw; max-width: 1200px;">
            <div class="flex-between mb-20">
                <h2>The Oracle</h2>
                <div class="flex-row">
                    <button class="secondary btn-sm" onclick="document.getElementById('hand-sim-modal').classList.add('hidden')">Close</button>
                </div>
            </div>
            
            <div class="hand-sim-container" id="sim-hand-display">
                </div>
            
            <div class="flex-row" style="justify-content: center; gap: 20px;">
                <button onclick="openHandSim()" style="background:var(--danger); border:none; width:auto; padding:12px 30px;">Mulligan (New 7)</button>
                <button onclick="simDraw()" style="background:var(--mana-blue); border:none; width:auto; padding:12px 30px;">Draw Card</button>
                <button onclick="document.getElementById('hand-sim-modal').classList.add('hidden')" class="secondary" style="width:auto;">Keep Hand</button>
            </div>
        </div>
    </div>
    
    <div id="stats-modal" class="modal-overlay hidden" onclick="if(event.target===this) this.classList.add('hidden')">
        <div class="card-box" style="width: 95vw; max-width: 1100px; max-height:90vh; overflow-y:auto; padding:40px;">
            <div class="flex-between mb-20">
                <div>
                    <h2 style="margin-bottom:5px;">The Geologist</h2>
                    <div class="text-sub">Deck composition analysis.</div>
                </div>
                <button class="secondary btn-sm" onclick="document.getElementById('stats-modal').classList.add('hidden')">Close</button>
            </div>
            
            <div class="geo-stat-row">
                <div class="geo-metric">
                    <div class="geo-val" id="stat-avg-cmc">0.0</div>
                    <div class="geo-lbl">Avg CMC</div>
                </div>
                <div class="geo-metric">
                    <div class="geo-val" id="stat-land-count">0</div>
                    <div class="geo-lbl">Lands</div>
                </div>
                <div class="geo-metric">
                    <div class="geo-val" id="stat-pip-total">0</div>
                    <div class="geo-lbl">Total Pips</div>
                </div>
            </div>
            
            <div class="geo-grid">
                 <div class="chart-box">
                     <h3 class="mb-10 text-sub" style="position:absolute; top:20px; left:20px;">Color Identity</h3>
                     <div style="height:100%; display:flex; align-items:center; justify-content:center;">
                        <canvas id="statsColorChart"></canvas>
                     </div>
                 </div>
                 <div class="chart-box">
                     <h3 class="mb-10 text-sub" style="position:absolute; top:20px; left:20px;">Type Distribution</h3>
                     <div style="height:100%; display:flex; align-items:center; justify-content:center;">
                        <canvas id="statsTypeChart"></canvas>
                     </div>
                 </div>
                 <div class="chart-box" style="grid-column: 1 / -1; height:320px;">
                     <h3 class="mb-10 text-sub">Opening Hand Land Probability</h3>
                     <canvas id="statsProbChart"></canvas>
                 </div>
            </div>
        </div>
    </div>

    <div id="app" class="app-container hidden">
        <div id="sidebar" class="sidebar">
            <div class="logo">ü©∏ The Grimoire</div>
            <div class="user-profile-section" onclick="nav('settings')">
                <img id="sidebar-avatar" class="avatar-circle" src="https://svgshare.com/i/10gq.svg">
                <div class="user-meta">
                    <div id="sidebar-username" class="user-name">Wizard</div>
                    <div id="user-email" class="user-email-txt">Loading...</div>
                </div>
            </div>
            <div class="nav-item active" onclick="nav('dashboard', 'dashboard')">üè† Dashboard</div>
            <div class="nav-item" onclick="nav('add', 'add')">‚ö° Forge</div>
            <div class="nav-item" onclick="nav('collection', 'collection')">üìö Vault</div>
            <div class="nav-item" onclick="nav('oracle', 'oracle')">üëÅÔ∏è Oracle</div>
            <div class="nav-item" onclick="nav('decks', 'decks')">üìú Grimoires</div>
            <div class="nav-item" onclick="nav('settings', 'settings')">‚öôÔ∏è Settings</div>
            <div style="flex:1;"></div>
            <button class="secondary btn-sm w-full mb-10" onclick="document.getElementById('report-modal').classList.remove('hidden')" style="border:1px solid var(--danger); color:var(--danger); background:rgba(239, 68, 68, 0.1);">Report Anomaly</button>
            <button class="secondary btn-sm w-full" onclick="handleLogout(this)" style="border:1px solid var(--text-muted);">Sever Connection</button>
            <div class="mobile-menu-btn" style="position:static; margin-top:20px; text-align:center; cursor:pointer; color:var(--text-muted);" onclick="toggleSidebar()">Close Menu ‚úï</div>
        </div>

        <div class="main" onclick="hideContextMenu()">
            <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>
            
            <div id="view-dashboard" class="view-section">
                <div class="flex-between mb-20">
                    <h2>Dashboard</h2>
                    <div class="flex-row">
                        <button class="secondary btn-sm" onclick="nav('add')">Quick Forge</button>
                        <button class="secondary btn-sm" onclick="exportCSV()">Export CSV</button>
                    </div>
                </div>
                
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-val" id="stat-count">0</div>
                        <div class="stat-lbl">Cards Owned</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-val" id="stat-value">$0</div>
                        <div class="stat-lbl">Total Value</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-val" id="stat-profit" style="color:var(--success)">$0</div>
                        <div class="stat-lbl">Net Flux</div>
                    </div>
                </div>

                <div class="dash-grid">
                    <div>
                        <div class="card-box" style="height:380px;">
                            <div class="flex-between mb-10">
                                <h3>Portfolio Flux</h3>
                                <span class="tag-pill">Live</span>
                            </div>
                            <div style="height:280px; position:relative;">
                                <canvas id="valueChart"></canvas>
                            </div>
                        </div>

                        <div class="flex-between mt-20 mb-10">
                             <h3>Recent Grimoires</h3>
                             <span class="text-sub" style="cursor:pointer;" onclick="nav('decks')">View All ‚Üí</span>
                        </div>
                        <div class="deck-grid" id="dash-recent-decks" style="grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));">
                            </div>
                    </div>
                    
                    <div class="dash-col-side">
                        <div class="card-box">
                            <h3 class="mb-20">High Value Assets</h3>
                            <div id="top-cards-list">
                                </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-add" class="hidden view-section">
                <div class="add-grid">
                    <div>
                        <div class="card-box">
                            <div class="flex-between mb-20">
                                <h2>The Forge</h2>
                                <button class="secondary btn-sm" onclick="document.getElementById('csvFile').click()">Import CSV</button>
                                <input type="file" id="csvFile" style="display:none;" onchange="handleCSVUpload(this)">
                            </div>
                            
                            <div class="input-group">
                                <span class="input-icon">üîç</span>
                                <input id="search" placeholder="Card Name or SET 123" oninput="debounceSearch()" style="font-size:16px; padding:16px 16px 16px 45px;">
                            </div>
                            <div id="search-status" class="text-sub mb-20" style="margin-top:-10px;"></div>
                            <select id="versionSelect" onchange="updateSelectedVersion()" class="mb-20" style="background:rgba(255,255,255,0.05);"></select>
                            
                            <div class="flex-row">
                                <div style="flex:1;"><label class="text-sub">Set</label><input id="set" readonly placeholder="SET"></div>
                                <div style="flex:1;"><label class="text-sub">#</label><input id="num" readonly placeholder="#"></div>
                                <div style="flex:1;"><label class="text-sub">Qty</label><input type="number" id="qty" value="1"></div>
                            </div>
                            <div class="flex-row mt-20">
                                <div style="flex:1;"><label class="text-sub">Cost ($)</label><input type="number" id="cost" step="0.01" placeholder="0.00"></div>
                                <div style="flex:2;"><label class="text-sub">Tags</label><input id="add-tags" placeholder="Foil, Commander..."></div>
                            </div>
                            <textarea id="bulkList" class="hidden"></textarea>
                        </div>
                        <div class="card-box">
                            <h3>Session Log</h3>
                            <div id="session-log" class="session-log"><div class="text-sub" style="text-align:center;">Ready to forge.</div></div>
                        </div>
                    </div>
                    <div class="preview-pane">
                        <img id="preview" src="https://cards.scryfall.io/large/front/0/0/00000000-0000-0000-0000-000000000000.jpg">
                        <div class="mt-20">
                            <div class="text-sub mb-10">Market Price</div>
                            <div id="marketPrice" style="font-size:32px; font-weight:800; color:var(--success); margin-bottom:20px;">--</div>
                            <button onclick="addCard(this, false)" class="mb-10" style="background:linear-gradient(135deg, var(--primary), #5a189a); box-shadow:0 10px 20px rgba(157, 78, 221, 0.3);">Add to Vault</button>
                            <button onclick="addCard(this, true)" class="secondary">Add to Oracle</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-collection" class="hidden view-section">
                <div class="flex-between mb-20">
                    <h2>Vault</h2>
                    <button onclick="appraiseCollection(this)" class="secondary btn-sm">üîÑ Sync & Appraise</button>
                </div>
                
                <div class="collection-filter-bar">
                    <div class="input-group" style="width:250px; margin:0;">
                        <span class="input-icon">üîç</span>
                        <input id="vaultSearch" placeholder="Search cards..." oninput="filterVault()" style="margin:0; padding-left:40px;">
                    </div>
                    <select id="filterColor" onchange="filterVault()" style="width:100px; margin:0;"><option value="all">Color</option><option value="W">White</option><option value="U">Blue</option><option value="B">Black</option><option value="R">Red</option><option value="G">Green</option><option value="M">Multi</option><option value="C">Colorless</option></select>
                    <select id="filterRarity" onchange="filterVault()" style="width:110px; margin:0;"><option value="all">Rarity</option><option value="mythic">Mythic</option><option value="rare">Rare</option><option value="uncommon">Uncommon</option><option value="common">Common</option></select>
                    <select id="filterType" onchange="filterVault()" style="width:110px; margin:0;"><option value="all">Type</option><option value="Creature">Creature</option><option value="Instant">Instant</option><option value="Sorcery">Sorcery</option><option value="Artifact">Artifact</option><option value="Enchantment">Enchantment</option><option value="Land">Land</option><option value="Planeswalker">Walker</option></select>
                    <select id="sortOrder" onchange="filterVault()" style="width:120px; margin:0;"><option value="price-desc">Value: High</option><option value="price-asc">Value: Low</option><option value="name">Name (A-Z)</option><option value="cmc">CMC</option></select>
                    
                    <div class="col-view-toggle">
                        <div class="view-btn active" id="btn-grid" onclick="toggleCollectionView('grid')">Binder</div>
                        <div class="view-btn" id="btn-list" onclick="toggleCollectionView('list')">Ledger</div>
                    </div>

                    <div class="collection-stats">
                        <div class="col-stat-item"><span class="col-stat-val" id="col-filtered-count">0</span><span class="col-stat-lbl">Cards</span></div>
                        <div class="col-stat-item"><span class="col-stat-val text-green" id="col-filtered-val">$0</span><span class="col-stat-lbl">Value</span></div>
                    </div>
                </div>
                
                <div id="collection-grid" class="collection-grid"></div>
            </div>

            <div id="view-decks" class="hidden view-section">
                <div id="deck-library">
                    <div class="flex-between mb-20">
                        <h2>Grimoires</h2>
                        <button onclick="showRitualEditor()" class="secondary btn-sm">+ New Ritual</button>
                    </div>
                    <div id="deck-grid-container" class="deck-grid"></div>
                </div>

                <div id="deck-workspace" class="hidden">
                    <div class="flex-between mb-20">
                        <button onclick="closeDeck()" class="secondary btn-sm">‚Üê Return</button>
                        <div class="flex-row">
                            <button onclick="openGeologist()" class="secondary btn-sm">üìä Stats</button>
                            <button onclick="openHandSim()" class="secondary btn-sm">‚úã Hand Sim</button>
                            <button onclick="initBattlefield()" class="btn-sm" style="background:var(--primary); border:none;">‚öîÔ∏è Test</button>
                        </div>
                    </div>
                    <div id="editor-mode">
                        <div class="card-box">
                            <div class="flex-row mb-20">
                                <input id="deckName" placeholder="Grimoire Name" style="flex:2; font-size:18px; font-weight:bold;">
                                <input id="deckCommander" placeholder="Commander" style="flex:2;">
                                <select id="deckFormat" style="flex:1;"><option value="Commander">Commander</option><option value="Casual">Casual</option></select>
                            </div>
                            <div class="flex-between mb-10"><span class="text-sub" style="font-weight:700; letter-spacing:1px;">MANA CURVE</span><span id="editor-card-count">0</span></div>
                            <div style="height:120px; position:relative;"><canvas id="editorManaChart"></canvas></div>
                            <div class="flex-row mt-20" style="align-items:flex-start;">
                                <div style="flex:1"><div class="text-sub mb-10">Mainboard</div><textarea id="deckMain"></textarea></div>
                                <div style="flex:1"><div class="text-sub mb-10">Sideboard</div><textarea id="deckSide"></textarea></div>
                            </div>
                            <div class="flex-row mt-20" style="gap:15px;">
                                <button onclick="validateDeck(this)" class="secondary">Validate</button>
                                <button onclick="saveDeck(this)">Save Grimoire</button>
                            </div>
                        </div>
                    </div>
                    <div id="detail-mode" class="hidden">
                        <div class="deck-area-detail">
                            <div class="card-box">
                                <div class="flex-between">
                                    <h2 id="detail-deck-name" style="margin:0;"></h2>
                                    <div class="flex-row">
                                        <button class="secondary btn-sm" onclick="toggleDeckView()">üëÅÔ∏è View</button>
                                        <button class="secondary btn-sm" onclick="showRitualEditor(true)">‚úé Edit</button>
                                        <select id="tools-dropdown" onchange="handleDeckTool(this.value)" style="width:auto; margin:0; padding:6px; height:30px; font-size:12px;">
                                            <option value="">‚öôÔ∏è Tools</option>
                                            <option value="copy_missing">Copy Missing</option>
                                            <option value="buy">Buy Missing (TCG)</option>
                                            <option value="print">Print Proxies</option>
                                            <option value="export_arena">Export Arena</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="detail-commander" class="text-sub mb-20" style="color:var(--gold);"></div>
                                <div id="detail-visual-grid" class="hidden visual-grid-container">
                                    <div class="visual-card-grid" id="visual-grid-content"></div>
                                </div>
                                <div id="detail-decklist-viewer" class="deck-list-viewer"></div>
                            </div>
                            <div class="card-box">
                                <h3 class="mb-20">Analysis</h3>
                                <div class="flex-between mb-10 text-sub"><span>Value</span><span id="detail-deck-price" class="text-green text-bold">$0.00</span></div>
                                <div class="flex-between mb-10 text-sub"><span>Missing</span><span id="detail-missing-cost" class="text-red text-bold">$0.00</span></div>
                                <div class="progress-bg mb-20"><div id="detail-owned-bar" class="progress-fill" style="width:0%"></div></div>
                                <div id="deck-advisor" class="mt-20 pt-20" style="border-top:1px solid var(--glass-border);"></div>
                                <div id="deck-charts" class="mt-20"><canvas id="typeChart"></canvas><canvas id="manaCurve"></canvas></div>
                                <button class="secondary w-full mt-20" onclick="openLandCalculator()">Geomancer</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="view-battlefield" class="hidden">
                <div class="bf-grid-layout">
                    <div style="display:flex; flex-direction:column; height:100%; border-right:1px solid var(--glass-border);">
                        <div class="bf-hud">
                            <div class="flex-row">
                                <button class="secondary btn-sm" onclick="exitBattlefield()">Exit</button>
                                <div class="text-bold" style="font-size:24px; color:white; text-shadow:0 0 10px white;">Life: <span id="bf-life">40</span></div>
                                <button class="btn-sm" onclick="updateLife(1)">+</button><button class="btn-sm" onclick="updateLife(-1)">-</button>
                            </div>
                            <div class="flex-row">
                                <div class="text-sub">Turn: <span id="bf-turn">1</span></div>
                                <button class="btn-sm" onclick="nextTurn()">Pass</button>
                                <button class="btn-sm" style="background:var(--mana-blue); border:none;" onclick="openTokenMenu()">Token</button>
                                <button class="btn-sm" style="background:var(--danger); border:none;" onclick="initBattlefield()">Reset</button>
                            </div>
                        </div>
                        <div class="bf-board">
                            <div id="bf-frontline" class="bf-row" ondrop="drop(event, 'field')" ondragover="allowDrop(event)">
                                <div class="bf-zone-label">Combat</div>
                            </div>
                            <div id="bf-backline" class="bf-row" ondrop="drop(event, 'field')" ondragover="allowDrop(event)" style="border-bottom:none; background:rgba(0,0,0,0.3);">
                                <div class="bf-zone-label">Lands</div>
                            </div>
                        </div>
                    </div>

                    <div class="bf-side-zone">
                        <div class="pile-card" onclick="openPileViewer('lib')">
                            <img src="https://c1.scryfall.com/file/scryfall-card-backs/large/59/597b79b3-7d77-4261-871a-60dd17403388.jpg">
                            <div class="pile-count" id="bf-lib-count">99</div>
                            <div class="pile-label">Library</div>
                        </div>
                        <div class="pile-card" onclick="openPileViewer('grave')" ondrop="drop(event, 'grave')" ondragover="allowDrop(event)">
                            <div class="pile-count" id="bf-grave-count">0</div>
                            <div class="pile-label">Grave</div>
                        </div>
                        <div class="pile-card" onclick="openPileViewer('exile')" ondrop="drop(event, 'exile')" ondragover="allowDrop(event)">
                            <div class="pile-count" id="bf-exile-count">0</div>
                            <div class="pile-label">Exile</div>
                        </div>
                    </div>
                </div>
                <div class="bf-hand-shelf" id="bf-hand" ondrop="drop(event, 'hand')" ondragover="allowDrop(event)"></div>
            </div>
            
            <div id="view-oracle" class="hidden view-section"><h2>Oracle Wishlist</h2><div id="oracle-grid" class="collection-grid mt-20"></div></div>
            
            <div id="view-settings" class="hidden view-section">
                <div class="card-box" style="max-width:600px; margin:0 auto;">
                    <h2>Settings</h2>
                    
                    <div class="setting-section">
                        <h3>Identity</h3>
                        <input id="settings-username" placeholder="Wizard Name">
                        <div class="text-sub mb-10">Choose Avatar</div>
                        <div class="avatar-grid" id="avatar-grid">
                            <div class="upload-btn" onclick="triggerAvatarUpload()">+</div>
                            <input type="file" id="avatar-upload" hidden accept="image/*" onchange="handleAvatarUpload(this)">
                            </div>
                        <button onclick="saveProfile(this)" class="mt-20">Update Identity</button>
                    </div>

                    <div class="setting-section">
                        <h3>Theme</h3>
                        <div class="theme-grid mb-20">
                            <div class="theme-btn" style="background:#a78bfa;" onclick="applyTheme('purple')"></div> 
                            <div class="theme-btn" style="background:#fcd34d;" onclick="applyTheme('white')"></div> 
                            <div class="theme-btn" style="background:#60a5fa;" onclick="applyTheme('blue')"></div> 
                            <div class="theme-btn" style="background:#18181b; border-color:#52525b;" onclick="applyTheme('black')"></div> 
                            <div class="theme-btn" style="background:#f87171;" onclick="applyTheme('red')"></div> 
                            <div class="theme-btn" style="background:#34d399;" onclick="applyTheme('green')"></div> 
                        </div>
                    </div>

                    <div class="setting-section" style="border:none;">
                        <h3>Data</h3>
                        <div class="flex-row">
                            <button class="secondary" onclick="exportCSV()">Export Collection (CSV)</button>
                            <button class="secondary" onclick="exportDecks()">Backup Decks (JSON)</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="land-modal" class="modal-overlay hidden" onclick="if(event.target===this) this.classList.add('hidden')">
                <div class="card-box" style="max-width: 400px;">
                    <h2 style="color:var(--primary);">The Geomancer</h2>
                    <input type="number" id="target-land-count" value="36" onchange="recalcLands()" placeholder="Total Lands">
                    <div id="land-results" class="mb-20 mt-20"></div>
                    <button onclick="applyLands(this)">Add to Deck</button>
                </div>
            </div>
            
             <div id="codex-modal" class="modal-overlay hidden" onclick="if(event.target===this) this.classList.add('hidden')">
                <div class="card-box" style="max-width: 800px; display:flex; gap:30px; flex-wrap:wrap;">
                    <img id="codex-img" style="width:280px; border-radius:14px; box-shadow:0 10px 40px rgba(0,0,0,0.5);">
                    <div style="flex:1;">
                        <h2 id="codex-title" style="margin-bottom:5px;"></h2>
                        <div id="codex-type" style="color:var(--gold); font-family:monospace; margin-bottom:20px;"></div>
                        <div id="codex-text" style="white-space:pre-wrap; margin-bottom:25px; line-height:1.6; font-size:15px;"></div>
                        <div id="codex-legality"></div>
                        <div class="flex-row mt-20">
                            <button class="secondary" onclick="document.getElementById('codex-modal').classList.add('hidden')">Close</button>
                            <button onclick="window.open(window.scryfallLink, '_blank')" style="background:#2b253a; border:1px solid rgba(255,255,255,0.1);">Scryfall Data ‚Üó</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bottom-nav">
            <div onclick="nav('dashboard')">üè†</div>
            <div onclick="nav('add')">‚ûï</div>
            <div onclick="nav('collection')">üìö</div>
            <div onclick="nav('decks')">üìã</div>
        </div>
        <button class="fab-btn" onclick="nav('add')">+</button>
    </div>

    <script>
        // CONFIG
        const SUPABASE_URL="https://mdirqlntcxqkthbwubmj.supabase.co";
        const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1kaXJxbG50Y3hxa3RoYnd1Ym1qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2OTUyOTAsImV4cCI6MjA4MTI3MTI5MH0.XBhYZiwINycA-QjAH-cL4vFzzyppm1c4M322jNDmbvE";
        let sb; try { sb = supabase.createClient(SUPABASE_URL,SUPABASE_KEY); } catch(e) { alert("Database Error"); }
        
        const EMAILJS_SERVICE_ID = 'service_n9utr47';
        const EMAILJS_TEMPLATE_ID = 'template_xtth5gu';
        const EMAILJS_PUBLIC_KEY = 'ohGLAW9gp3OUPH0uf';
        const CARD_BACK_URL = "https://cards.scryfall.io/large/back/5/9/597b79b3-7d77-4261-871a-60dd17403388.jpg";

        window.onerror = function(msg, url, line) { console.error("Error on line " + line + ": " + msg); return false; };

        // STATE
        let session, cardsCache=[], vaultLookup={}, searchTimer, tempCardData, allVersions=[], currentViewedDeckId, pendingDeleteId;
        let typeChartInstance, manaCurveInstance, editorChartInstance, valueChartInstance;
        let statsColorChart, statsTypeChart, statsProbChart; // V13.7
        let currentDeckCache=[], currentDeckStructuredList=[], currentDeckCoverUrl='';
        let gameState={lib:[],hand:[],field:[],grave:[],exile:[],life:40,turn:1};
        let collectionMode = 'grid'; // V13.9
        const CHART_COLORS=['#a78bfa','#dc2626','#a78bfa','#4f46e5','#059669','#737373','#facc15'];
        let suggestedLands = [];

        // AVATARS (V14.5 DICEBEAR FIX)
        const AVATARS = [
            "https://api.dicebear.com/7.x/adventurer/svg?seed=Felix",
            "https://api.dicebear.com/7.x/adventurer/svg?seed=Aneka",
            "https://api.dicebear.com/7.x/adventurer/svg?seed=Jack",
            "https://api.dicebear.com/7.x/adventurer/svg?seed=Precious",
            "https://api.dicebear.com/7.x/adventurer/svg?seed=Abby",
            "https://api.dicebear.com/7.x/adventurer/svg?seed=Trouble"
        ];
        
        // HAND SIM STATE
        let simDeck = [];

        // --- CORE FUNCTIONS (MOVED TO TOP) ---
        
        function nav(v) {
            document.querySelectorAll('.main > div').forEach(d => d.classList.add('hidden'));
            const view = document.getElementById('view-'+v);
            if(view) {
                view.classList.remove('hidden');
                view.classList.remove('view-section');
                void view.offsetWidth; 
                view.classList.add('view-section');
            }
            document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));
            const active = document.querySelector(`.nav-item[onclick="nav('${v}', '${v}')"]`);
            if(active) active.classList.add('active');
            if(v === 'decks') loadDecks();
            if(v === 'collection') loadCollection();
            if(v === 'oracle') loadOracle();
            document.getElementById('sidebar').classList.remove('mobile-open');
        }

        async function loadDecks() {
            const { data, error } = await sb.from('decks').select('*').order('updated_at', {ascending:false});
            if(error) { console.error("Load Error:", error); return; } 
            
            window.myDecks = data||[];
            const grid = document.getElementById('deck-grid-container');
            
            if(window.myDecks.length === 0) {
                setHTML('deck-grid-container', '<div class="empty-state">No decks. Create one!</div>');
            } else {
                setHTML('deck-grid-container', window.myDecks.map(d => {
                    // V14.2 FIX: Parse full quantities instead of just lines
                    let count = 0;
                    if(d.card_count) count = d.card_count;
                    else if(d.card_list) {
                         const lines = d.card_list.split('\n');
                         lines.forEach(l => {
                             const match = l.trim().match(/^(\d+)\s+/);
                             count += (match ? parseInt(match[1]) : 1);
                         });
                    }
                    
                    let bg = d.cover_url || CARD_BACK_URL;
                    // V14.0 FIX: Auto-upgrade old CDN links
                    if(bg.includes('c1.scryfall.com')) bg = bg.replace('c1.scryfall.com', 'cards.scryfall.io');
                    
                    // V14.1 FIX: SMART LOAD fallback
                    if (bg === CARD_BACK_URL && d.structured_list && d.structured_list.length > 0 && d.structured_list[0].img) {
                        bg = d.structured_list[0].img;
                    }
                    
                    return `<div class="deck-card animate-in" onclick="viewRitualDetails('${d.id}')" style="background-image:url('${bg}');">
                        <div class="deck-card-content">
                            <div class="flex-between"><h4>${d.name}</h4><span onclick="askDeleteDeck('${d.id}', event)" style="cursor:pointer; color:var(--danger);">‚úï</span></div>
                            <div class="deck-card-meta" style="color:rgba(255,255,255,0.7); font-size:12px; margin-top:5px;"><span>${count} Cards</span><span class="format-badge">${d.format}</span></div>
                        </div>
                    </div>`;
                }).join(''));
            }
            if(document.getElementById('dash-recent-decks')) loadRecentDecksForDash();
        }

        async function loadData() {
            const { data } = await sb.from('cards').select('*').order('created_at', { ascending: false });
            cardsCache = data || [];
            vaultLookup = {};
            let count=0, val=0, cost=0;
            cardsCache.forEach(c => {
                const key = `${c.name.toLowerCase().trim()}_${c.set_code}_${c.collector_number}`;
                vaultLookup[key] = (vaultLookup[key]||0) + c.quantity;
                if(c.quantity > 0) { count += c.quantity; val += (c.market_price_usd||0)*c.quantity; cost += (c.buy_price||0)*c.quantity; }
            });
            setText('stat-count', count); setText('stat-value', "$"+val.toFixed(2));
            const profit = val - cost;
            const pEl = document.getElementById('stat-profit');
            if(pEl) { pEl.innerText = (profit>=0?"+":"") + "$" + profit.toFixed(2); pEl.style.color = profit >= 0 ? "var(--success)" : "var(--danger)"; }
            renderDashboardStats(val);
        }
        
        function renderDashboardStats(totalValue) {
             const topCards = [...cardsCache].filter(c=>c.quantity>0).sort((a,b)=> (b.market_price_usd||0) - (a.market_price_usd||0)).slice(0, 5);
             if(document.getElementById('top-cards-list')) {
                 if(topCards.length === 0) setHTML('top-cards-list', '<div class="text-sub">Add cards to see highlights.</div>');
                 else {
                     setHTML('top-cards-list', topCards.map(c => `<div class="highlight-card" onclick="openCodex('${c.set_code}','${c.collector_number}')"><img src="${getCardImage(c)}" class="highlight-img"><div style="flex:1;"><div style="font-weight:700;">${c.name}</div><div class="text-green">$${c.market_price_usd}</div></div></div>`).join(''));
                 }
             }
             initValueChart(totalValue);
        }
        
        async function loadRecentDecksForDash() {
            const container = document.getElementById('dash-recent-decks');
            if(!container) return;
            const recent = window.myDecks.slice(0, 4); 
            if(recent.length === 0) { container.innerHTML = '<div class="text-sub">No decks yet.</div>'; return; }
            container.innerHTML = recent.map(d => {
                 let bg = d.cover_url || CARD_BACK_URL;
                 if(bg.includes('c1.scryfall.com')) bg = bg.replace('c1.scryfall.com', 'cards.scryfall.io');
                 if (bg === CARD_BACK_URL && d.structured_list && d.structured_list.length > 0 && d.structured_list[0].img) {
                    bg = d.structured_list[0].img;
                 }
                 return `<div class="deck-card" onclick="viewRitualDetails('${d.id}')" style="background-image:url('${bg}'); height:200px;"><div class="deck-card-content"><div style="font-weight:700;">${d.name}</div><div class="text-sub" style="font-size:10px;">${d.format}</div></div></div>`
            }).join('');
        }

        function initValueChart(currentVal) {
            const ctx = document.getElementById('valueChart');
            if(!ctx) return;
            if(valueChartInstance) valueChartInstance.destroy();
            const labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Today'];
            const data = [currentVal*0.8, currentVal*0.85, currentVal*0.82, currentVal*0.9, currentVal*0.95, currentVal*0.92, currentVal];
            valueChartInstance = new Chart(ctx.getContext('2d'), { type: 'line', data: { labels: labels, datasets: [{ label: 'Collection Value', data: data, borderColor: '#9d4edd', backgroundColor: 'rgba(157, 78, 221, 0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#666' }, grid: { display: false } }, y: { ticks: { color: '#666' }, grid: { color: 'rgba(255,255,255,0.05)' } } } } });
        }

        // --- HELPERS ---
        function setLoading(btn, isLoading) { if(!btn) return; if(isLoading) btn.classList.add('btn-loading'); else btn.classList.remove('btn-loading'); }
        function showToast(msg) { let c=document.getElementById('toast-container'); let e=document.createElement('div'); e.className='toast'; e.innerHTML=`<span>${msg}</span>`; c.appendChild(e); setTimeout(()=>e.remove(), 3000); }
        function setText(id, val) { const el = document.getElementById(id); if(el) el.innerText = val; }
        function setHTML(id, val) { const el = document.getElementById(id); if(el) el.innerHTML = val; }
        function getValue(id) { const el = document.getElementById(id); return el ? el.value : ''; }
        
        function getCardImage(c) {
             if(!c) return CARD_BACK_URL;
             let url = CARD_BACK_URL;
             if(c.image_uris?.normal) url = c.image_uris.normal;
             else if(c.card_faces?.[0]?.image_uris?.normal) url = c.card_faces[0].image_uris.normal;
             else if(c.image_url && c.image_url.includes('http')) url = c.image_url;
             
             // V14.0 FIX: Auto-upgrade old CDN links
             if(url.includes('c1.scryfall.com')) url = url.replace('c1.scryfall.com', 'cards.scryfall.io');
             return url;
        }
        function showPreview(url, e) { const el=document.getElementById('hover-preview'); if(url){ el.src=url; el.style.display='block'; el.style.left=(e.clientX+20)+'px'; el.style.top=(e.clientY)+'px'; }}
        function hidePreview() { document.getElementById('hover-preview').style.display='none'; }

        // --- AUTH & PROFILE ---
        async function handleAuthAction(btn) {
            setLoading(btn, true);
            const e=getValue('email'), p=getValue('password');
            const { data, error } = await sb.auth.signInWithPassword({ email:e, password:p });
            if(error) {
                const sup = await sb.auth.signUp({ email:e, password:p });
                if(!sup.error) showToast("Check email to confirm."); else showToast(sup.error.message);
            } else { session = data.session; initApp(); }
            setLoading(btn, false);
        }
        
        async function handleLogout(btn) { setLoading(btn, true); await sb.auth.signOut(); window.location.reload(); }
        
        async function saveProfile(btn) {
             const u = getValue('settings-username');
             if(u) { setLoading(btn,true); await sb.from('profiles').upsert({id:session.user.id, username:u}); setLoading(btn,false); showToast("Saved"); loadProfile(); }
        }
        
        function initApp() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            loadData();
            loadDecks();
            loadProfile();
            renderAvatarGrid();
            const savedTheme = localStorage.getItem('grimoire_theme');
            if(savedTheme) applyTheme(savedTheme);
        }
        
        async function loadProfile() {
            const savedAvatar = localStorage.getItem('grimoire_avatar') || AVATARS[0];
            document.getElementById('sidebar-avatar').src = savedAvatar;
            const { data } = await sb.from('profiles').select('*').eq('id', session.user.id).single();
            if(data && data.username) {
                setText('sidebar-username', data.username);
                document.getElementById('settings-username').value = data.username;
            }
            if(data && data.avatar_url) {
                document.getElementById('sidebar-avatar').src = data.avatar_url;
                localStorage.setItem('grimoire_avatar', data.avatar_url);
            }
            setText('user-email', session.user.email);
        }

        function renderAvatarGrid() {
            const grid = document.getElementById('avatar-grid');
            // Keep Upload Button + SVGs
            const uploadBtn = `<div class="upload-btn" onclick="triggerAvatarUpload()">+</div><input type="file" id="avatar-upload" hidden accept="image/*" onchange="handleAvatarUpload(this)">`;
            grid.innerHTML = uploadBtn + AVATARS.map(url => `<img src="${url}" class="avatar-option" onclick="changeAvatar('${url}')">`).join('');
        }
        
        function changeAvatar(url) {
            localStorage.setItem('grimoire_avatar', url);
            document.getElementById('sidebar-avatar').src = url;
            // Also save to DB for persistence across devices
            sb.from('profiles').upsert({id:session.user.id, avatar_url: url}).then(()=>{ showToast("Avatar Updated"); });
        }

        // V14.4 CUSTOM AVATAR LOGIC
        function triggerAvatarUpload() { document.getElementById('avatar-upload').click(); }

        function handleAvatarUpload(input) {
            const file = input.files[0];
            if(!file) return;
            
            // Limit file size (e.g., 2MB check before processing)
            if(file.size > 2000000) { showToast("Image too large. Max 2MB."); return; }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Resize to 150x150 square
                    const size = 150;
                    canvas.width = size;
                    canvas.height = size;
                    
                    // Center Crop Logic
                    const ratio = Math.max(size / img.width, size / img.height);
                    const centerShift_x = (size - img.width * ratio) / 2;
                    const centerShift_y = (size - img.height * ratio) / 2;
                    
                    ctx.drawImage(img, 0, 0, img.width, img.height, centerShift_x, centerShift_y, img.width * ratio, img.height * ratio);
                    
                    // Compress to JPEG 0.7 quality
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    
                    // Save
                    changeAvatar(dataUrl);
                }
                img.src = e.target.result;
            }
            reader.readAsDataURL(file);
        }

        async function sendBugReport(btn) {
            const cat = getValue('bug-category');
            const txt = getValue('bug-text');
            if(!txt) return showToast("Describe the bug first.");
            setLoading(btn, true);
            const fullMsg = `[${cat}] ${txt}`;
            const templateParams = { bug_description: fullMsg, user_email: session ? session.user.email : 'Anonymous', app_version: 'v14.4' };
            try { await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams, EMAILJS_PUBLIC_KEY); showToast("Report Sent!"); document.getElementById('report-modal').classList.add('hidden'); document.getElementById('bug-text').value = ''; } catch(e) { console.error(e); showToast("Failed to send."); }
            setLoading(btn, false);
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('mobile-open'); }
        function closeUserOptionsModal() { document.getElementById('user-options-modal').classList.add('hidden'); }
        function openUserOptionsModal() { document.getElementById('user-options-modal').classList.remove('hidden'); }
        function toggleResetMode() { showToast("Not implemented yet"); }

        function applyTheme(theme) {
            const root = document.documentElement;
            if(theme==='white') { root.style.setProperty('--primary', '#fcd34d'); root.style.setProperty('--bg-dark', '#57534e'); }
            else if(theme==='blue') { root.style.setProperty('--primary', '#60a5fa'); root.style.setProperty('--bg-dark', '#1e3a8a'); }
            else if(theme==='red') { root.style.setProperty('--primary', '#f87171'); root.style.setProperty('--bg-dark', '#450a0a'); }
            else if(theme==='green') { root.style.setProperty('--primary', '#34d399'); root.style.setProperty('--bg-dark', '#064e3b'); }
            else { root.style.setProperty('--primary', '#9d4edd'); root.style.setProperty('--bg-dark', '#050308'); }
            localStorage.setItem('grimoire_theme', theme);
        }

        function loadCollection() { filterVault(); }
        function loadOracle() {
            const oracle = cardsCache.filter(c => c.quantity === 0);
            if(oracle.length === 0) setHTML('oracle-grid', '<div class="empty-state">Wishlist is empty.</div>');
            else setHTML('oracle-grid', oracle.map(c => `<div class="grid-card"><div class="overlay"><button onclick="deleteCard('${c.id}', event)">üóëÔ∏è</button></div><img src="${getCardImage(c)}" loading="lazy" onerror="this.src='${CARD_BACK_URL}'"></div>`).join(''));
        }

        // V13.9: THE COLLECTOR (ADVANCED FILTERING)
        function toggleCollectionView(mode) {
             collectionMode = mode;
             document.getElementById('btn-grid').classList.toggle('active', mode==='grid');
             document.getElementById('btn-list').classList.toggle('active', mode==='list');
             filterVault();
        }

        function filterVault() {
            const search = getValue('vaultSearch').toLowerCase();
            const fColor = getValue('filterColor');
            const fRarity = getValue('filterRarity');
            const fType = getValue('filterType');
            const fSort = getValue('sortOrder') || 'price-desc'; 
            
            let filtered = cardsCache.filter(c => c.quantity > 0 && c.name.toLowerCase().includes(search));
            if(fColor !== 'all') {
                filtered = filtered.filter(c => {
                    const isLand = c.type_line && c.type_line.toLowerCase().includes('land');
                    const basis = isLand ? (c.color_identity || []) : (c.colors || []);
                    if(fColor==='C') return basis.length===0;
                    if(fColor==='M') return basis.length>1;
                    return basis.includes(fColor);
                });
            }
            if(fRarity !== 'all') filtered = filtered.filter(c => c.rarity === fRarity);
            if(fType !== 'all') filtered = filtered.filter(c => c.type_line && c.type_line.includes(fType));
            
            // Sorting Logic
            if(fSort === 'price-desc') filtered.sort((a,b) => (b.market_price_usd||0) - (a.market_price_usd||0));
            if(fSort === 'price-asc') filtered.sort((a,b) => (a.market_price_usd||0) - (b.market_price_usd||0));
            if(fSort === 'name') filtered.sort((a,b) => a.name.localeCompare(b.name));
            if(fSort === 'cmc') filtered.sort((a,b) => (a.cmc||0) - (b.cmc||0));
            
            // Stats Update
            setText('col-filtered-count', filtered.length);
            const totalVal = filtered.reduce((a,b) => a + (b.market_price_usd||0)*b.quantity, 0);
            setText('col-filtered-val', "$"+totalVal.toFixed(2));

            const container = document.getElementById('collection-grid');
            if(filtered.length === 0) {
                 container.innerHTML = '<div class="empty-state">No cards found.</div>';
                 return;
            }
            
            // Render based on View Mode
            if(collectionMode === 'grid') {
                container.innerHTML = filtered.map(c => 
                    `<div class="grid-card animate-in" onclick="openCodex('${c.set_code}','${c.collector_number}')">
                        <div class="qty-badge">x${c.quantity}</div>
                        <div class="gain-badge">$${c.market_price_usd}</div>
                        <div class="overlay"><button onclick="openEditModal('${c.id}', event)">‚úé</button><button onclick="deleteCard('${c.id}', event)">üóëÔ∏è</button></div>
                        <img src="${getCardImage(c)}" loading="lazy" onerror="this.src='${CARD_BACK_URL}'">
                    </div>`
                ).join('');
            } else {
                // List View (Ledger)
                let tableHtml = `<table class="ledger-table"><thead><tr><th>Card</th><th>Set</th><th>Type</th><th>Cost</th><th>Price</th><th>Qty</th><th>Actions</th></tr></thead><tbody>`;
                filtered.forEach(c => {
                    tableHtml += `<tr>
                        <td style="display:flex; align-items:center; gap:10px;"><img src="${getCardImage(c)}" class="ledger-img"> <b>${c.name}</b></td>
                        <td style="text-transform:uppercase;">${c.set_code} #${c.collector_number}</td>
                        <td>${c.type_line ? c.type_line.split('‚Äî')[0] : ''}</td>
                        <td>$${c.buy_price||'-'}</td>
                        <td class="text-green">$${c.market_price_usd}</td>
                        <td>x${c.quantity}</td>
                        <td><button class="secondary btn-sm" onclick="openEditModal('${c.id}', event)">‚úé</button></td>
                    </tr>`;
                });
                tableHtml += `</tbody></table>`;
                container.innerHTML = tableHtml;
            }
        }

        async function appraiseCollection(btn) {
            setLoading(btn, true);
            const ids=cardsCache.map(c=>({set:c.set_code.toLowerCase(),collector_number:c.collector_number}));
            const totalChunks=Math.ceil(ids.length/75);
            try {
                for(let i=0; i<totalChunks; i++){
                    const chunk = ids.slice(i*75,(i+1)*75);
                    const res=await fetch('https://api.scryfall.com/cards/collection',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({identifiers:chunk})});
                    const d=await res.json();
                    if(d.data) {
                        for(const sc of d.data){
                            const local=cardsCache.find(c=>c.set_code.toLowerCase()===sc.set && c.collector_number===sc.collector_number);
                            if(local){
                                await sb.from('cards').update({
                                    market_price_usd: parseFloat(sc.prices.usd||0),
                                    colors: sc.colors, color_identity: sc.color_identity,
                                    type_line: sc.type_line, rarity: sc.rarity, cmc: sc.cmc
                                }).eq('id', local.id);
                            }
                        }
                    }
                }
                showToast("Collection Synced!"); loadData();
            } catch(e) { showToast("Error syncing."); }
            setLoading(btn, false);
        }
        
        function exportCSV() {
             const rows = [["Name","Set","Num","Qty","Price"]];
             cardsCache.forEach(c => rows.push([c.name, c.set_code, c.collector_number, c.quantity, c.market_price_usd]));
             const csv = rows.map(r => r.join(",")).join("\n");
             const blob = new Blob([csv], { type: 'text/csv' });
             const url = window.URL.createObjectURL(blob);
             const a = document.createElement('a'); a.href=url; a.download="collection.csv"; a.click();
        }
        
        function exportDecks() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(window.myDecks));
            const a = document.createElement('a');
            a.href = dataStr;
            a.download = "decks_backup.json";
            a.click();
        }

        function openEditModal(id, e) {
            e.stopPropagation();
            const card = cardsCache.find(c => c.id == id);
            if(card) {
                document.getElementById('edit-card-id').value = id;
                setText('edit-card-name', card.name);
                document.getElementById('edit-qty').value = card.quantity;
                document.getElementById('edit-cost').value = card.buy_price;
                document.getElementById('edit-modal').classList.remove('hidden');
            }
        }
        
        async function saveEdit(btn) {
            setLoading(btn, true);
            const id = getValue('edit-card-id');
            const q = getValue('edit-qty');
            const c = getValue('edit-cost');
            await sb.from('cards').update({ quantity:q, buy_price:c }).eq('id', id);
            document.getElementById('edit-modal').classList.add('hidden');
            setLoading(btn, false);
            showToast("Updated");
            loadData();
            if(!document.getElementById('view-collection').classList.contains('hidden')) filterVault();
        }
        
        async function deleteCard(id, e) {
            e.stopPropagation();
            if(confirm("Delete card?")) {
                await sb.from('cards').delete().eq('id', id);
                showToast("Deleted");
                loadData();
                if(!document.getElementById('view-collection').classList.contains('hidden')) filterVault();
                if(!document.getElementById('view-oracle').classList.contains('hidden')) loadOracle();
            }
        }
        
        function askDeleteDeck(id, e) {
            e.stopPropagation();
            pendingDeleteId = id;
            document.getElementById('delete-modal').classList.remove('hidden');
        }
        
        async function confirmDelete(btn) {
            setLoading(btn, true);
            await sb.from('decks').delete().eq('id', pendingDeleteId);
            document.getElementById('delete-modal').classList.add('hidden');
            setLoading(btn, false);
            showToast("Deck Deleted");
            loadDecks();
        }

        function debounceSearch() { clearTimeout(searchTimer); searchTimer = setTimeout(fetchMeta, 500); }
        async function fetchMeta() {
            const q = getValue('search');
            if(q.length < 3) return;
            setText('search-status', "Searching...");
            let url = `https://api.scryfall.com/cards/search?q=${encodeURIComponent(q)}&unique=prints`;
            const match = q.match(/^([a-z]{3,4})\s*(\d+)$/i);
            if(match) url = `https://api.scryfall.com/cards/${match[1]}/${match[2]}`;
            try {
                const res = await fetch(url);
                const d = await res.json();
                allVersions = d.data || (d.object === 'card' ? [d] : []);
                setText('search-status', allVersions.length + " found.");
                const s = document.getElementById('versionSelect');
                s.innerHTML = '';
                allVersions.forEach((v, i) => {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.innerText = `${v.set_name} - $${v.prices.usd || '0'}`;
                    s.appendChild(opt);
                });
                updateSelectedVersion();
            } catch(e) { setText('search-status', "Error"); }
        }
        
        function updateSelectedVersion() {
            const v = allVersions[document.getElementById('versionSelect').value];
            if(!v) return;
            document.getElementById('set').value = v.set.toUpperCase();
            document.getElementById('num').value = v.collector_number;
            setText('marketPrice', `$${v.prices.usd||'0.00'}`);
            document.getElementById('preview').src = getCardImage(v);
            document.getElementById('preview').style.display = 'block';
            tempCardData = v;
        }

        // V11.5 SESSION HISTORY
        function appendToSessionLog(name) {
            const log = document.getElementById('session-log');
            if(log.innerText === "Ready to forge.") log.innerHTML = "";
            const div = document.createElement('div');
            div.className = 'log-item';
            div.innerHTML = `<span>${name}</span> <span style="color:var(--success)">‚úì Added</span>`;
            log.prepend(div);
        }

        async function addCard(btn, isWishlist) {
            if(!tempCardData) return showToast("Select card");
            setLoading(btn, true);
            const qty = isWishlist ? 0 : (parseInt(getValue('qty')) || 1);
            const cost = parseFloat(getValue('cost')) || null;
            const tags = getValue('add-tags').split(',').filter(s=>s);
            const { error } = await sb.from('cards').insert({
                user_id: session.user.id,
                name: tempCardData.name,
                set_code: tempCardData.set,
                collector_number: tempCardData.collector_number,
                image_url: getCardImage(tempCardData),
                quantity: qty,
                buy_price: cost,
                market_price_usd: parseFloat(tempCardData.prices.usd || 0),
                tags: tags,
                cmc: tempCardData.cmc || 0,
                type_line: tempCardData.type_line,
                colors: tempCardData.colors,
                color_identity: tempCardData.color_identity,
                rarity: tempCardData.rarity
            });
            setLoading(btn, false);
            if(error) showToast("Error"); 
            else { 
                showToast("Saved"); 
                appendToSessionLog(tempCardData.name); 
                loadData(); 
            }
        }
        
        function handleCSVUpload(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split(/\r\n|\n/).slice(1);
                let out = "";
                lines.forEach(l => {
                    const cols = l.split(',');
                    if(cols.length > 1) {
                        const qty = parseInt(cols.find(c=>!isNaN(parseInt(c)) && c.length<4)) || 1;
                        const name = cols.find(c=>c.length>3 && isNaN(parseInt(c)));
                        if(name) out += `${qty} ${name}\n`;
                    }
                });
                if(!out) out = text;
                processBulkText(out);
            };
            reader.readAsText(file);
        }
        
        async function processBulkText(text) {
             const lines = text.split('\n').filter(l=>l.trim());
             const idents = lines.map(l=>{ const m=l.match(/^(\d+)\s+(.+)/); return m ? {name:m[2]} : null }).filter(x=>x);
             let allCards = [];
             for(let i=0; i<idents.length; i+=75) {
                const chunk = idents.slice(i, i+75);
                const res = await fetch('https://api.scryfall.com/cards/collection', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({identifiers:chunk})});
                const d = await res.json();
                if(d.data) allCards = allCards.concat(d.data);
             }
             for(const c of allCards) {
                 await sb.from('cards').insert({
                     user_id:session.user.id, name:c.name, set_code:c.set, collector_number:c.collector_number,
                     image_url:getCardImage(c), quantity:1, market_price_usd:parseFloat(c.prices.usd||0),
                     colors: c.colors, color_identity: c.color_identity, type_line: c.type_line, rarity: c.rarity, cmc: c.cmc
                 });
             }
             showToast(`Imported ${allCards.length} cards`);
             loadData();
        }

        // --- DECK SAVE LOGIC (V14.1: SMART SAVE) ---
        async function saveDeck(btn) {
            setLoading(btn, true);
            const name = getValue('deckName');
            const main = getValue('deckMain');
            
            try {
                if(!name) throw new Error("Deck Name is required");
                if(!session || !session.user) throw new Error("You must be logged in");

                // V14.2 FIX: Calculate true card count (summing quantities)
                let trueCount = 0;
                if(main) {
                    const lines = main.split('\n');
                    lines.forEach(l => {
                        const match = l.trim().match(/^(\d+)\s+/);
                        trueCount += (match ? parseInt(match[1]) : 1);
                    });
                }
                
                // V14.1: Ensure we have data for the cover image
                let structured = window.currentDeckStructuredList || [];
                if (main && structured.length === 0) {
                      // Auto-Fetch Logic for missing data
                      const lines = main.split('\n').filter(l=>l.trim());
                      const idents = lines.map(l=>{ const m=l.match(/^(\d+)\s+(.+)/); return m ? {name:m[2]} : null }).filter(x=>x).slice(0, 1); // Get first card only for speed
                      if(idents.length > 0) {
                          const res = await fetch('https://api.scryfall.com/cards/collection', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({identifiers:idents})});
                          const d = await res.json();
                          if(d.data && d.data.length > 0) {
                              structured = [{ img: getCardImage(d.data[0]) }]; // Minimal struct just for image
                          }
                      }
                }

                // Default cover: existing cache OR first card in struct OR default back
                let cover = currentDeckCache[0]?.img || (structured.length > 0 ? structured[0].img : CARD_BACK_URL);
                if(cover.includes('c1.scryfall')) cover = cover.replace('c1.scryfall.com', 'cards.scryfall.io'); // V14.0 Fix

                const payload = { 
                    user_id: session.user.id, 
                    name: name, 
                    card_list: main || "", 
                    format: document.getElementById('deckFormat').value || "Standard",
                    cover_url: cover, 
                    structured_list: window.currentDeckStructuredList ? window.currentDeckStructuredList : [],
                    card_count: trueCount // V14.2: Storing the correct sum
                };
                
                let error;
                if(currentViewedDeckId) {
                    const res = await sb.from('decks').update(payload).eq('id', currentViewedDeckId);
                    error = res.error;
                } else {
                    const res = await sb.from('decks').insert(payload);
                    error = res.error;
                }

                if(error) {
                    console.error("Supabase Error:", error);
                    throw new Error(error.message);
                }
                
                showToast("Deck Saved Successfully!"); 
                loadDecks(); 
            } catch(e) { 
                console.error(e);
                showToast("Save Failed: " + e.message); 
            } finally { 
                setLoading(btn, false); 
            }
        }

        // --- BATTLEFIELD LOGIC (V11.7) ---
        function initBattlefield() {
            document.getElementById('view-decks').classList.add('hidden');
            document.getElementById('view-battlefield').classList.remove('hidden');
            gameState = { lib:[], hand:[], field:[], grave:[], exile:[], life:40, turn:1 };
            
            // Build library
            if(currentDeckCache && currentDeckCache.length > 0) {
                currentDeckCache.forEach(c => {
                    for(let i=0; i<c.qty; i++) {
                        gameState.lib.push({ uid: Math.random().toString(36).substr(2, 9), ...c, tapped:false, counters:0 });
                    }
                });
                // Shuffle
                for(let i=gameState.lib.length-1; i>0; i--){ const j=Math.floor(Math.random()*(i+1)); [gameState.lib[i],gameState.lib[j]]=[gameState.lib[j],gameState.lib[i]]; }
                // Draw 7
                for(let i=0; i<7; i++) gameState.hand.push(gameState.lib.pop());
            }
            renderBF();
            
            document.addEventListener('keydown', handleShortcuts);
        }

        function handleShortcuts(e) {
            if(document.getElementById('view-battlefield').classList.contains('hidden')) return;
            if(e.key === 'd' || e.key === 'D') drawCard();
            if(e.key === 'u' || e.key === 'U') { gameState.field.forEach(c => c.tapped = false); renderBF(); }
            if(e.key === 'l' || e.key === 'L') updateLife(1);
            if(e.key === 'k' || e.key === 'K') updateLife(-1);
        }

        function renderBF() {
            setText('bf-lib-count', gameState.lib.length);
            setText('bf-grave-count', gameState.grave.length);
            setText('bf-exile-count', gameState.exile.length);
            setText('bf-life', gameState.life);
            setText('bf-turn', gameState.turn);

            // Hand
            setHTML('bf-hand', gameState.hand.map(c => 
                `<div class="bf-hand-card" draggable="true" ondragstart="drag(event, '${c.uid}')">
                    <img src="${getCardImage(c)}" draggable="false">
                </div>`
            ).join(''));
            
            const cardHTML = (c) => `
                <div class="bf-card ${c.tapped?'bf-tapped':''}" id="${c.uid}" draggable="true" ondragstart="drag(event, '${c.uid}')" onclick="tapCard('${c.uid}')" oncontextmenu="handleCardContext(event, '${c.uid}')">
                    ${c.counters > 0 ? `<div class="counter-badge">+${c.counters}</div>` : ''}
                    ${c.isToken ? `<div style="background:#333; height:100%; display:flex; align-items:center; justify-content:center; border:1px solid #fff; border-radius:9px; font-weight:bold; font-size:12px; text-align:center; padding:5px;">${c.name}</div>` : `<img src="${getCardImage(c)}" draggable="false">`}
                </div>
            `;
            
            const lands = gameState.field.filter(c => c.type && c.type.toLowerCase().includes('land'));
            const spells = gameState.field.filter(c => !c.type || !c.type.toLowerCase().includes('land'));
            
            setHTML('bf-backline', `<div class="bf-zone-label">Lands</div>` + lands.map(cardHTML).join(''));
            setHTML('bf-frontline', `<div class="bf-zone-label">Combat</div>` + spells.map(cardHTML).join(''));
        }

        function openPileViewer(zone) {
            let cards = [];
            let title = "Library";
            if(zone === 'lib') { drawCard(); return; }
            if(zone === 'grave') { cards = gameState.grave; title="Graveyard (Click to Return to Hand)"; }
            if(zone === 'exile') { cards = gameState.exile; title="Exile (Click to Return to Hand)"; }
            
            setText('pile-title', title);
            setHTML('pile-content', cards.map((c, index) => `
                <div class="pile-item" oncontextmenu="handlePileContext(event, '${c.uid}', '${zone}')" onclick="moveFromPile('${c.uid}', '${zone}')">
                    <img src="${getCardImage(c)}">
                </div>
            `).join(''));
            document.getElementById('pile-modal').classList.remove('hidden');
        }
        
        function moveFromPile(uid, zone) {
             const source = (zone === 'grave') ? gameState.grave : gameState.exile;
             const idx = source.findIndex(c => c.uid === uid);
             if(idx > -1) {
                 const card = source.splice(idx, 1)[0];
                 gameState.hand.push(card);
                 renderBF();
                 openPileViewer(zone); // Refresh modal
                 showToast("Returned to Hand");
             }
        }
        
        function handlePileContext(e, uid, zone) {
            e.preventDefault();
            const source = (zone === 'grave') ? gameState.grave : gameState.exile;
            const idx = source.findIndex(c => c.uid === uid);
            if(idx > -1) {
                const card = source.splice(idx, 1)[0];
                gameState.field.push(card);
                renderBF();
                openPileViewer(zone);
                showToast("Played to Battlefield");
            }
        }

        function handleCardContext(e, uid) {
            e.preventDefault();
            const menu = document.getElementById('card-ctx-menu');
            menu.style.top = e.clientY + 'px';
            menu.style.left = e.clientX + 'px';
            menu.classList.remove('hidden');
            
            menu.innerHTML = `
                <div class="ctx-item" onclick="modifyCard('${uid}', 'counter')">Add Counter üé≤</div>
                <div class="ctx-item" onclick="modifyCard('${uid}', 'untap')">Untap üîÑ</div>
                <div class="ctx-item" onclick="modifyCard('${uid}', 'bounce')">Bounce to Hand ‚úã</div>
                <div class="ctx-divider"></div>
                <div class="ctx-item" onclick="modifyCard('${uid}', 'grave')" style="color:var(--danger);">Destroy üíÄ</div>
                <div class="ctx-item" onclick="modifyCard('${uid}', 'exile')" style="color:var(--mana-blue);">Exile ‚ú®</div>
            `;
        }
        
        function hideContextMenu() { document.getElementById('card-ctx-menu').classList.add('hidden'); }
        
        function modifyCard(uid, action) {
            const idx = gameState.field.findIndex(c => c.uid === uid);
            if(idx === -1) return;
            const card = gameState.field[idx];
            
            if(action === 'counter') card.counters = (card.counters || 0) + 1;
            if(action === 'untap') card.tapped = false;
            if(action === 'bounce') { gameState.field.splice(idx, 1); gameState.hand.push(card); }
            if(action === 'grave') { gameState.field.splice(idx, 1); gameState.grave.push(card); }
            if(action === 'exile') { gameState.field.splice(idx, 1); gameState.exile.push(card); }
            
            renderBF();
            hideContextMenu();
        }

        function openTokenMenu() {
            const tokens = ['Soldier 1/1', 'Goblin 1/1', 'Zombie 2/2', 'Angel 4/4', 'Treasure', 'Clue', 'Food'];
            setHTML('token-grid', tokens.map(t => `<button onclick="spawnToken('${t}')">${t}</button>`).join(''));
            document.getElementById('token-modal').classList.remove('hidden');
        }
        
        function spawnToken(name) {
            gameState.field.push({ uid: Math.random().toString(36), name: name, isToken: true, type: 'Creature Token', tapped: false });
            document.getElementById('token-modal').classList.add('hidden');
            renderBF();
        }
        
        function drawCard() { if(gameState.lib.length) { gameState.hand.push(gameState.lib.pop()); renderBF(); } }
        function tapCard(uid) { const c = gameState.field.find(c => c.uid === uid); if(c) { c.tapped = !c.tapped; renderBF(); } }
        function updateLife(n) { gameState.life += n; renderBF(); }
        function nextTurn() { gameState.turn++; gameState.field.forEach(c => c.tapped = false); drawCard(); }
        function exitBattlefield() { nav('decks'); document.removeEventListener('keydown', handleShortcuts); }

        // Drag & Drop
        function drag(ev, uid) { ev.dataTransfer.setData("uid", uid); }
        function allowDrop(ev) { ev.preventDefault(); ev.target.closest('.bf-row, .bf-hand-shelf, .pile-card')?.classList.add('drag-over'); }
        function drop(ev, target) {
            ev.preventDefault();
            document.querySelectorAll('.drag-over').forEach(e => e.classList.remove('drag-over'));
            const uid = ev.dataTransfer.getData("uid");
            
            let card, sourceArr;
            ['hand','field','grave','exile','lib'].forEach(z => {
                const idx = gameState[z].findIndex(c => c.uid === uid);
                if(idx > -1) { card = gameState[z][idx]; sourceArr = gameState[z]; sourceArr.splice(idx, 1); }
            });
            
            if(card) {
                if(target === 'field') gameState.field.push(card);
                else if(target === 'hand') gameState.hand.push(card);
                else if(target === 'grave') gameState.grave.push(card);
                else if(target === 'exile') gameState.exile.push(card);
                
                document.getElementById('pile-modal').classList.add('hidden');
                renderBF();
            }
        }
        
        function openCodex(set, num) {
            document.getElementById('codex-modal').classList.remove('hidden');
            fetch(`https://api.scryfall.com/cards/${set}/${num}`).then(r=>r.json()).then(d=>{
                document.getElementById('codex-img').src=getCardImage(d);
                setText('codex-title', d.name);
                setText('codex-type', d.type_line);
                setText('codex-text', d.oracle_text);
                let h=''; if(d.legalities) for(const[k,v] of Object.entries(d.legalities)) if(['standard','commander'].includes(k)) h+=`<div>${k}: ${v}</div>`;
                setHTML('codex-legality', h);
                window.scryfallLink=d.scryfall_uri;
            })
        }
        
        // V12.4 RESTORED FUNCTIONS
        function showRitualEditor(keep) {
            document.getElementById('deck-library').classList.add('hidden');
            document.getElementById('deck-workspace').classList.remove('hidden');
            document.getElementById('detail-mode').classList.add('hidden');
            document.getElementById('editor-mode').classList.remove('hidden');
            currentViewedDeckId = null;
            if(!keep) {
                document.getElementById('deckName').value = '';
                document.getElementById('deckMain').value = '';
            }
            initEditorListeners();
            updateLiveEditorStats();
        }
        
        function closeDeck() {
            document.getElementById('deck-workspace').classList.add('hidden');
            document.getElementById('deck-library').classList.remove('hidden');
        }
        
        function clearDeckEditor() { document.getElementById('deckMain').value = ''; }
        function initEditorListeners() { document.getElementById('deckMain').addEventListener('input', () => setTimeout(updateLiveEditorStats, 500)); }
        function updateLiveEditorStats() {
            const txt = getValue('deckMain'); const lines = txt.split('\n');
            const data = {0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0}; let total=0;
            lines.forEach(l => {
                const m = l.match(/^(\d+)\s+(.+)/);
                if(m) {
                    const q=parseInt(m[1]), n=m[2].trim().toLowerCase(); total+=q;
                    const c = cardsCache.find(x=>x.name.toLowerCase()===n);
                    if(c && c.cmc !== undefined) { let b=Math.floor(c.cmc); if(b>7)b=7; data[b]+=q; }
                }
            });
            setText('editor-card-count', total);
            renderEditorChart(data);
        }
        function renderEditorChart(d) {
            const ctx=document.getElementById('editorManaChart').getContext('2d'); if(editorChartInstance) editorChartInstance.destroy();
            editorChartInstance = new Chart(ctx, { type:'bar', data:{labels:['0','1','2','3','4','5','6','7+'],datasets:[{data:Object.values(d),backgroundColor:'#9d4edd',borderRadius:2}]}, options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#a1a1aa'}},y:{display:false}}} });
        }

        async function validateDeck(btn) {
            setLoading(btn, true);
            const main = getValue('deckMain');
            const lines = main.split('\n').filter(l=>l.trim());
            const idents = lines.map(l=>{ const m=l.match(/^(\d+)\s+(.+)/); return m ? {name:m[2]} : null }).filter(x=>x);
            try {
                let allCards = [];
                for(let i=0; i<idents.length; i+=75) {
                    const chunk = idents.slice(i, i+75);
                    const res = await fetch('https://api.scryfall.com/cards/collection', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({identifiers:chunk})});
                    const d = await res.json();
                    if(d.data) allCards = allCards.concat(d.data);
                }
                const structured = allCards.map(c => {
                    const req = lines.find(l => l.toLowerCase().includes(c.name.toLowerCase()));
                    const qty = req ? parseInt(req.match(/^(\d+)/)[1]) : 1;
                    return {
                        name: c.name, qty: qty, set: c.set, num: c.collector_number,
                        img: getCardImage(c), type: c.type_line, cmc: c.cmc || 0,
                        price: parseFloat(c.prices.usd || 0), identity: c.color_identity,
                        mana_cost: c.mana_cost, oracle_text: c.oracle_text
                    };
                });
                window.currentDeckStructuredList = structured;
                processDeckData(structured);
            } catch(e) { showToast("Validation Error"); } finally { setLoading(btn, false); }
        }

        function processDeckData(data) {
            document.getElementById('editor-mode').classList.add('hidden');
            document.getElementById('detail-mode').classList.remove('hidden');
            setText('detail-deck-name', getValue('deckName') || "New Deck");
            
            let totalVal=0, types={}, cmcs={}, colors={W:0,U:0,B:0,R:0,G:0,C:0};
            let ownedVal=0, missingVal=0, ownedCount=0, totalCount=0;
            
            const listHtml = data.map(c => {
                const key = `${c.name.toLowerCase()}_${c.set}_${c.num}`;
                const have = vaultLookup[key] || 0;
                const isBasic = ['plains','island','swamp','mountain','forest'].some(x => c.name.toLowerCase().includes(x));
                const effectiveHave = isBasic ? c.qty : have;
                const match = Math.min(effectiveHave, c.qty);
                const missing = c.qty - match;
                
                ownedCount += match; totalCount += c.qty;
                totalVal += c.price * c.qty;
                missingVal += missing * c.price;
                
                const status = match >= c.qty ? 'is-owned' : (match > 0 ? 'is-partial' : 'is-missing');
                
                const type = c.type.split('‚Äî')[0].trim(); types[type] = (types[type]||0)+c.qty;
                if(!type.includes('Land')) { let b=Math.floor(c.cmc); if(b>7)b=7; cmcs[b]=(cmcs[b]||0)+c.qty; }
                if(c.mana_cost) {
                    colors.W += (c.mana_cost.match(/{W}/g)||[]).length * c.qty;
                    colors.U += (c.mana_cost.match(/{U}/g)||[]).length * c.qty;
                    colors.B += (c.mana_cost.match(/{B}/g)||[]).length * c.qty;
                    colors.R += (c.mana_cost.match(/{R}/g)||[]).length * c.qty;
                    colors.G += (c.mana_cost.match(/{G}/g)||[]).length * c.qty;
                }
                
                return `<div class="deck-line ${status}" data-name="${c.name}" data-qty="${missing}"><b>${c.qty}</b> ${c.name} <span style="float:right; opacity:0.6;">$${c.price.toFixed(2)} (${effectiveHave}/${c.qty})</span></div>`;
            }).join('');

            setHTML('detail-decklist-viewer', listHtml);
            setText('detail-deck-price', "$"+totalVal.toFixed(2));
            setText('detail-missing-cost', "$"+missingVal.toFixed(2));
            
            const pct = Math.round((ownedCount/totalCount)*100) || 0;
            setText('detail-owned-percent', pct+"%");
            const bar = document.getElementById('detail-owned-bar'); if(bar) bar.style.width = pct+"%";
            
            document.getElementById('deck-charts').classList.remove('hidden');
            renderTypeChart(types); renderManaCurve(cmcs);
            currentDeckCache = data;
            
            const stats = { lands:{count:0,target:36}, ramp:{count:0,target:10}, draw:{count:0,target:10}, removal:{count:0,target:10}, wipes:{count:0,target:3} };
            data.forEach(c => {
                const t=(c.oracle_text||"").toLowerCase(), ty=(c.type||"").toLowerCase(), q=c.qty;
                if(ty.includes('land')) { stats.lands.count+=q; return; }
                if((t.includes('add') && t.includes('mana')) || (t.includes('search') && t.includes('land'))) stats.ramp.count+=q;
                if(t.includes('draw') && t.includes('card')) stats.draw.count+=q;
                if((t.includes('destroy')||t.includes('exile')) && t.includes('target')) stats.removal.count+=q;
                if(t.includes('destroy') && t.includes('all')) stats.wipes.count+=q;
            });
            let advHtml = "";
            for(const [k,d] of Object.entries(stats)) {
                let col = 'var(--danger)'; if(d.count/d.target > 0.8) col='var(--success)';
                advHtml += `<div class="mb-20"><div class="flex-between text-sub" style="font-size:10px;"><span style="text-transform:capitalize">${k}</span><span>${d.count}/${d.target}</span></div><div class="progress-bg"><div class="progress-fill" style="width:${Math.min(100, (d.count/d.target)*100)}%; background:${col}"></div></div></div>`;
            }
            setHTML('deck-advisor', advHtml);
        }

        function renderTypeChart(d) { 
            const ctx=document.getElementById('typeChart').getContext('2d'); if(typeChartInstance) typeChartInstance.destroy();
            typeChartInstance = new Chart(ctx, { type:'doughnut', data:{labels:Object.keys(d),datasets:[{data:Object.values(d),backgroundColor:CHART_COLORS,borderWidth:0}]}, options:{plugins:{legend:{position:'right',labels:{color:'#a1a1aa'}}}} });
        }
        function renderManaCurve(d) {
            const ctx=document.getElementById('manaCurve').getContext('2d'); if(manaCurveInstance) manaCurveInstance.destroy();
            const l=['0','1','2','3','4','5','6','7+']; const v=l.map((_,i)=>d[i]||0);
            manaCurveInstance = new Chart(ctx, { type:'bar', data:{labels:l,datasets:[{data:v,backgroundColor:'#9d4edd'}]}, options:{plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#a1a1aa'}},y:{ticks:{color:'#a1a1aa'}}}} });
        }

        function viewRitualDetails(id) { 
            const d = window.myDecks.find(x => x.id == id);
            document.getElementById('deck-library').classList.add('hidden');
            document.getElementById('deck-workspace').classList.remove('hidden');
            document.getElementById('editor-mode').classList.add('hidden');
            document.getElementById('detail-mode').classList.remove('hidden');
            currentViewedDeckId = id;
            document.getElementById('deckName').value = d.name;
            document.getElementById('deckMain').value = d.card_list;
            window.currentDeckStructuredList = d.structured_list;
            validateDeck();
        }
        
        // V13.3 HAND SIMULATOR LOGIC
        function openHandSim() {
            document.getElementById('hand-sim-modal').classList.remove('hidden');
            // Build temporary deck for sim
            simDeck = [];
            currentDeckCache.forEach(c => {
                for(let i=0; i<c.qty; i++) {
                    simDeck.push({...c, uid: Math.random().toString(36)});
                }
            });
            // Shuffle
            for(let i=simDeck.length-1; i>0; i--){ const j=Math.floor(Math.random()*(i+1)); [simDeck[i],simDeck[j]]=[simDeck[j],simDeck[i]]; }
            
            // Draw 7
            renderSimHand(simDeck.splice(0, 7));
        }

        function simMulligan() {
            // Rebuild & Shuffle
            openHandSim();
        }
        
        function simDraw() {
            if(simDeck.length > 0) {
                const card = simDeck.shift();
                const container = document.getElementById('sim-hand-display');
                const div = document.createElement('div');
                div.className = 'sim-card animate-in';
                div.innerHTML = `<img src="${card.img}">`;
                container.appendChild(div);
                updateSimStats();
            }
        }
        
        function renderSimHand(hand) {
            const container = document.getElementById('sim-hand-display');
            container.innerHTML = hand.map(c => 
                `<div class="sim-card animate-in"><img src="${c.img}"></div>`
            ).join('');
            updateSimStats();
        }
        
        function updateSimStats() {
            const cards = document.querySelectorAll('.sim-card img');
            let lands = 0;
            // Basic land count logic for visualization
            document.getElementById('sim-land-count').innerText = `Cards: ${cards.length}`;
        }
        
        // V13.8 GEOLOGIST LOGIC (POLISHED)
        function openGeologist() {
            document.getElementById('stats-modal').classList.remove('hidden');
            const cards = window.currentDeckStructuredList || [];
            
            let colors = {W:0, U:0, B:0, R:0, G:0, C:0};
            let types = {};
            let totalCmc=0, totalCount=0, landCount=0, pipCount=0;

            cards.forEach(c => {
                const q = c.qty;
                totalCount += q;
                if(c.cmc) totalCmc += (c.cmc * q);
                
                // Color Pips
                if(c.mana_cost) {
                    ['W','U','B','R','G','C'].forEach(col => {
                        const pips = (c.mana_cost.match(new RegExp(`{${col}}`, 'g')) || []).length;
                        colors[col] += (pips * q);
                        pipCount += (pips * q);
                    });
                }
                
                // Type
                const t = c.type.split('‚Äî')[0].trim();
                types[t] = (types[t]||0) + q;
                if(t.includes('Land')) landCount += q;
            });
            
            // Update Quick Stats
            setText('stat-avg-cmc', (totalCount>0 ? (totalCmc/totalCount).toFixed(2) : "0.00"));
            setText('stat-land-count', landCount);
            setText('stat-pip-total', pipCount);
            
            // Chart Configs
            const commonOptions = {
                plugins: { legend: { labels: { color: '#94a3b8', font: {family: "'Inter', sans-serif", size: 10} } } },
                scales: {
                    r: { grid: { color: 'rgba(255,255,255,0.1)' }, angleLines: { color: 'rgba(255,255,255,0.1)' }, pointLabels: { color: '#fff' } }
                }
            };
            
            // Color Chart
            const ctxColor = document.getElementById('statsColorChart').getContext('2d');
            if(statsColorChart) statsColorChart.destroy();
            statsColorChart = new Chart(ctxColor, {
                type: 'polarArea',
                data: {
                    labels: Object.keys(colors),
                    datasets: [{
                        data: Object.values(colors),
                        backgroundColor: ['#f0f2c0','#b5cde3','#aca29a','#db8664','#93b483','#ccc'],
                        borderWidth: 0
                    }]
                },
                options: commonOptions
            });
            
            // Type Chart
            const ctxType = document.getElementById('statsTypeChart').getContext('2d');
            if(statsTypeChart) statsTypeChart.destroy();
            statsTypeChart = new Chart(ctxType, {
                type: 'pie',
                data: {
                    labels: Object.keys(types),
                    datasets: [{
                        data: Object.values(types),
                        backgroundColor: CHART_COLORS,
                        borderWidth: 0
                    }]
                },
                options: { plugins: { legend: { position: 'right', labels: { color: '#94a3b8' } } } }
            });
            
            // Probability
            const handSize = 7;
            let probs = [];
            for(let k=0; k<=7; k++) {
                let p = hyperGeo(totalCount, landCount, handSize, k);
                probs.push(p);
            }
            
            const ctxProb = document.getElementById('statsProbChart').getContext('2d');
            if(statsProbChart) statsProbChart.destroy();
            statsProbChart = new Chart(ctxProb, {
                type: 'bar',
                data: {
                    labels: ['0', '1', '2', '3', '4', '5', '6', '7'],
                    datasets: [{
                        label: '% Chance to draw X Lands',
                        data: probs,
                        backgroundColor: '#9d4edd',
                        borderRadius: 4
                    }]
                },
                options: { 
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        y: { beginAtZero: true, max: 100, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#666' } },
                        x: { grid: { display: false }, ticks: { color: '#666' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        function hyperGeo(N, K, n, k) {
            // N=Total, K=Successes in pop, n=Sample size, k=Successes in sample
            const combination = (n, k) => {
                if (k < 0 || k > n) return 0;
                let res = 1;
                for (let i = 1; i <= k; i++) res = res * (n - (i - 1)) / i;
                return res;
            };
            const waysToChooseK = combination(K, k);
            const waysToChooseRest = combination(N - K, n - k);
            const totalWays = combination(N, n);
            return ((waysToChooseK * waysToChooseRest) / totalWays * 100).toFixed(1);
        }

        // --- INIT ---
        sb.auth.getSession().then(({ data: { session: s } }) => { if(s) { session = s; initApp(); } });
    </script>
</body>
</html>

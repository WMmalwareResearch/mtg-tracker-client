<!DOCTYPE html>
<html lang="en">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Grimoire | Dark Edition</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü©∏</text></svg>">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- THEME & VARS (DARK GRIMOIRE) --- */
        :root { 
            --primary: #a78bfa; 
            --bg-dark: #0f0a1c; 
            --card-bg: rgba(45, 21, 60, 0.8); 
            --text: #f8fafc; 
            --subtext: #a1a1aa; 
            --border: rgba(167, 139, 250, 0.2); 
            --green: #d946ef; 
            --red: #dc2626; 
            --yellow: #facc15;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            
            /* Chart Colors */
            --chart-color-1: #d946ef; --chart-color-2: #dc2626; --chart-color-3: #a78bfa; --chart-color-4: #4f46e5; --chart-color-5: #059669;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: radial-gradient(circle at top left, #450a0a, #0f0a1c); 
            background-attachment: fixed;
            color: var(--text); 
            margin: 0; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            font-size: clamp(1rem, 0.8rem + 0.5vw, 1.125rem);
        }

        /* --- GLOBAL STYLES --- */
        * { box-sizing: border-box; }
        .hidden { display: none !important; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(167, 139, 250, 0.3); border-radius: 4px; } 
        ::-webkit-scrollbar-thumb:hover { background: rgba(167, 139, 250, 0.5); }

        /* --- LAYOUT --- */
        .app-container { display: grid; grid-template-columns: 240px 1fr; height: 100%; overflow: hidden; }
        
        /* SIDEBAR (Desktop) */
        .sidebar { background: var(--card-bg); backdrop-filter: blur(12px); border-right: 1px solid var(--border); padding: 25px; display: flex; flex-direction: column; z-index: 10; }
        .logo { font-size: 22px; font-weight: 700; color: var(--primary); margin-bottom: 40px; display: flex; align-items: center; gap: 12px; letter-spacing: -0.5px; text-shadow: 0 0 5px rgba(167, 139, 250, 0.5); }
        .nav-item { padding: 12px 15px; cursor: pointer; color: var(--subtext); font-weight: 500; border-radius: 8px; transition: all 0.2s; margin-bottom: 4px; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover { background: rgba(167, 139, 250, 0.08); color: white; }
        .nav-item.active { background: rgba(167, 139, 250, 0.2); color: white; border-left: 3px solid var(--primary); padding-left: 12px; }

        /* MAIN CONTENT */
        .main { padding: 40px clamp(1rem, 2vw + 1rem, 5rem); overflow-y: auto; flex: 1; }
        #view-dashboard, #view-add, #view-collection { max-width: 1400px; margin: 0 auto; }
        #view-decks { margin: 0 auto; }

        /* --- COMPONENTS --- */
        .card-box { background: var(--card-bg); backdrop-filter: blur(12px); padding: 1.5rem; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 24px; box-shadow: var(--shadow); }
        h2 { margin-top: 0; font-size: 1.5rem; font-weight: 600; letter-spacing: -0.5px; margin-bottom: 20px; }
        h3 { font-size: 1rem; font-weight: 600; color: var(--subtext); margin-top: 0; text-transform: uppercase; letter-spacing: 0.5px; font-size: 12px; margin-bottom: 15px;}

        /* INPUTS */
        .input-group { position: relative; display: flex; align-items: center; margin-bottom: 15px; }
        .input-icon { position: absolute; left: 12px; color: var(--subtext); font-size: 16px; pointer-events: none; }
        input, select { width: 100%; padding: 14px 14px 14px 40px; border-radius: 8px; border: 1px solid var(--border); background: rgba(0,0,0,0.4); color: white; font-size: 14px; transition: border-color 0.2s, box-shadow 0.2s; font-family: 'Inter', sans-serif; margin: 0; }
        textarea { padding: 14px; margin-bottom: 15px; height: 350px; resize: vertical; }

        /* BUTTONS */
        button { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: transform 0.1s, opacity 0.2s; }
        button:hover { opacity: 0.85; }
        button:active { transform: scale(0.98); }
        button.secondary { background: rgba(255,255,255,0.1); }
        .clear-btn { background: none; color: var(--subtext); width: 40px; padding: 0; height: 100%; margin-left: 10px; opacity: 0.7; }
        #validateDeckBtn { background: var(--green); margin-bottom: 10px; }

        /* DASHBOARD STATS */
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: rgba(255,255,255,0.03); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .stat-val { font-size: 28px; font-weight: 700; color: white; margin-bottom: 5px; }
        .stat-lbl { font-size: 11px; text-transform: uppercase; color: var(--subtext); font-weight: 600; letter-spacing: 1px; }
        @media (min-width: 901px) and (max-width: 1300px) { .stat-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; } }

        /* GRIDS */
        .collection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 20px; }
        #recent-grid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 12px; }
        .grid-card { position: relative; aspect-ratio: 2.5/3.5; border-radius: 10px; overflow: hidden; cursor: pointer; transition: transform 0.2s; background: rgba(0,0,0,0.3); box-shadow: var(--shadow); border: 1px solid var(--border); }
        .grid-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .grid-card img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.5s; }
        .overlay { position: absolute; bottom: 0; width: 100%; padding: 10px; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); font-size: 12px; font-weight: 600; color: white; display:flex; justify-content:space-between; align-items: flex-end; box-sizing: border-box; height: 50px; }
        
        /* DECK WORKSPACE */
        .deck-area-edit { display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        .deck-area-detail { display: grid; grid-template-columns: 1fr 400px; gap: 20px; }
        .deck-list-viewer { height: 70vh; overflow-y: auto; white-space: pre-wrap; padding: 15px; font-size: 14px; line-height: 1.5; color: var(--text); background: rgba(0,0,0,0.1); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); }
        #deck-charts { display: flex; flex-direction: column; gap: 20px; padding-top: 20px; }
        #saved-decks-list { max-height: 450px; overflow-y: auto; padding-right: 5px; display: flex; flex-direction: column; gap: 10px; }
        .deck-item-preview { background: rgba(255,255,255,0.05); padding:15px; border-radius:8px; border:1px solid var(--border); cursor:pointer; display:flex; justify-content:space-between; align-items:center; position: relative; }
        .deck-item-preview:hover { border-color: var(--primary); }
        .deck-item-info { font-size: 12px; color: var(--subtext); font-weight: 400; margin-top: 5px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* THE LINK (OWNERSHIP STYLES) */
        .deck-line { padding: 4px 8px; border-radius: 4px; margin-bottom: 2px; }
        .is-owned { color: var(--green); border-left: 2px solid var(--green); background: rgba(217, 70, 239, 0.05); }
        .is-partial { color: var(--yellow); border-left: 2px solid var(--yellow); background: rgba(250, 204, 21, 0.05); }
        .is-missing { color: var(--red); border-left: 2px solid var(--red); opacity: 0.8; }
        .progress-bg { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; margin-top: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); transition: width 0.5s ease-out; }

        /* PROPHECY MODAL */
        #prophecy-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 10, 28, 0.95); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .prophecy-content { width: 90%; max-width: 1000px; text-align: center; }
        .prophecy-hand { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin: 30px 0; min-height: 200px; }
        .prophecy-card { width: 140px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transition: transform 0.3s; cursor: pointer; animation: deal 0.5s ease-out forwards; opacity: 0; }
        .prophecy-card:hover { transform: scale(1.1) translateY(-10px); z-index: 10; }
        @keyframes deal { from { transform: translateY(50px) scale(0.8); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        
        /* LOGIN SCREEN */
        #auth-screen { background: radial-gradient(circle at center, #450a0a, #0f0a1c); position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .auth-box { background: rgba(255,255,255,0.05); backdrop-filter: blur(20px); border: 1px solid var(--border); box-shadow: 0 20px 40px rgba(0,0,0,0.6); padding: 40px; border-radius: 16px; width: 100%; max-width: 400px; text-align: center; }

        /* MOBILE BOTTOM NAV */
        .bottom-nav { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(15, 10, 28, 0.95); border-top: 1px solid var(--border); padding: 10px 0; justify-content: space-around; z-index: 20; backdrop-filter: blur(10px); }
        .b-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: var(--subtext); cursor: pointer; }
        .b-icon { font-size: 20px; margin-bottom: 4px; }
        .b-item.active { color: var(--primary); }

        /* RESPONSIVE */
        @media (max-width: 900px) { .deck-area-edit, .deck-area-detail { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { 
            .app-container { grid-template-columns: 1fr; padding-bottom: 80px; } 
            .sidebar { display: none; } 
            .main { padding: 20px; padding-bottom: 100px; } 
            .bottom-nav { display: flex; }
            .prophecy-card { width: 90px; }
        }
    </style>
</head>
<body>

    <div id="toast-container" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px;"></div>

    <div id="prophecy-modal" class="hidden">
        <div class="prophecy-content">
            <h2 style="color:var(--primary); text-shadow: 0 0 10px var(--primary); margin-bottom: 10px;">üîÆ The Prophecy</h2>
            <p style="color:var(--subtext); margin-bottom: 20px;">Divining a starting hand from the ether...</p>
            <div class="prophecy-hand" id="prophecy-hand-container"></div>
            <div style="display: flex; gap: 20px; justify-content: center;">
                <button onclick="drawProphecy()" style="width: auto; padding: 12px 30px; background: var(--primary);">üîÑ Mulligan</button>
                <button onclick="closeProphecy()" class="secondary" style="width: auto; padding: 12px 30px;">Close Vision</button>
            </div>
        </div>
    </div>

    <div id="auth-screen">
        <div class="auth-box">
            <div style="font-size:50px; margin-bottom:15px; text-shadow: 0 0 15px var(--primary);">ü©∏</div>
            <h2 style="margin:0 0 10px 0; color:white;">The Grimoire</h2>
            <p style="color:var(--subtext); margin-bottom:25px; font-size:14px;">Unleash your collection's true power.</p>
            
            <div class="input-group">
                <input type="email" id="email" placeholder="Sacrificial Email" style="padding-left: 14px;">
            </div>
            <div class="input-group">
                <input type="password" id="password" placeholder="Runic Key" style="padding-left: 14px;">
            </div>
            
            <button onclick="handleAuthAction()" id="auth-btn">Summon Session</button>
            
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:15px; font-size:12px;">
                <span id="auth-msg" style="color:var(--subtext); text-align: left; max-width: 60%;">First time? A pact will be forged upon login.</span>
                <span id="forgot-link" style="color:var(--primary); cursor:pointer; font-weight:600;" onclick="toggleResetMode()">Forgot Password?</span>
            </div>
        </div>
    </div>

    <div id="app" class="app-container hidden">
        <div class="sidebar">
            <div class="logo"><span>ü©∏</span> The Grimoire</div>
            <div class="nav-item active" onclick="nav('dashboard', 'dashboard')">üè† Dashboard</div>
            <div class="nav-item" onclick="nav('add', 'add')">‚ûï Add Relic</div>
            <div class="nav-item" onclick="nav('collection', 'collection')">üìö Vault</div>
            <div class="nav-item" onclick="nav('decks', 'decks')">üìã Rituals</div>
            <div style="flex-grow:1;"></div>
            <div style="padding:15px 0; border-top:1px solid var(--border); margin-top:10px;">
                <div id="user-email" style="font-size:11px; color:var(--subtext); margin-bottom:10px; overflow:hidden; text-overflow:ellipsis;"></div>
                <button class="secondary" onclick="handleLogout()">Break Pact</button>
            </div>
        </div>

        <div class="main">
            <div id="view-dashboard">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                    <h2 style="margin:0;">Dashboard</h2>
                </div>
                <div class="stat-grid">
                    <div class="stat-card"><div class="stat-val" id="stat-count">0</div><div class="stat-lbl">Relics</div></div>
                    <div class="stat-card"><div class="stat-val" id="stat-value">$0</div><div class="stat-lbl">Current Value</div></div>
                    <div class="stat-card"><div class="stat-val" id="stat-cost">$0</div><div class="stat-lbl">Total Investment</div></div>
                    <div class="stat-card"><div class="stat-val" id="stat-gain">$0</div><div class="stat-lbl">Arcane Gain/Loss</div></div>
                </div>
                <div class="card-box">
                    <h3>Recent Acquisitions (Last 5)</h3>
                    <div class="collection-grid" id="recent-grid" style="min-height:100px;">
                        <div style="color:var(--subtext); padding:20px; font-size:13px; grid-column:1/-1; text-align:center;">No cards found. Go to 'Add Relic' to start!</div>
                    </div>
                </div>
            </div>

            <div id="view-add" class="hidden">
                <div class="card-box" style="max-width:500px; margin:0 auto;">
                    <h2>Add Relic</h2>
                    <div class="input-group">
                        <span class="input-icon">üîç</span>
                        <input type="text" id="search" placeholder="Search Card Name..." oninput="debounceSearch()">
                    </div>
                    <div style="margin-bottom:15px; font-size:12px; color:var(--primary); font-weight:600; min-height:15px;" id="search-status"></div>
                    <select id="versionSelect" onchange="updateSelectedVersion()" style="margin-bottom:15px; padding-left: 14px;"></select>
                    <div style="display:flex; gap:10px; margin-bottom: 15px;">
                        <input id="set" placeholder="SET" readonly style="opacity:0.6; width:30%; padding-left: 14px;">
                        <input id="num" placeholder="#" readonly style="opacity:0.6; width:30%; padding-left: 14px;">
                        <input type="number" id="qty" placeholder="Qty" value="1" style="width:40%; padding-left: 14px;">
                    </div>
                    <div class="input-group">
                        <span class="input-icon">üí∞</span>
                        <input type="number" id="cost" placeholder="Acquisition Cost ($)" step="0.01" style="padding-left: 40px;">
                    </div>
                    <div style="font-size:12px; color:var(--subtext); margin-bottom:15px;">
                        Market Price: <span id="marketPrice" style="color:var(--green); font-weight:700;">--</span>
                    </div>
                    <div style="text-align:center; min-height:200px; background:rgba(0,0,0,0.2); border-radius:10px; margin-bottom:20px; display:flex; align-items:center; justify-content:center; border:1px dashed var(--border);">
                        <img id="preview" style="max-width:90%; border-radius:8px; display:none; margin:10px 0;">
                        <span id="preview-text" style="color:var(--subtext); font-size:12px;">Card Preview</span>
                    </div>
                    <button onclick="addCard()">Bind to Vault</button>
                </div>
            </div>
            
            <div id="view-collection" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2>Relic Vault</h2>
                    <button class="secondary" style="width:auto; padding:8px 16px; font-size:12px;" onclick="loadCollection()">Refresh</button>
                </div>
                <div class="collection-grid" id="collection-grid" style="margin-top:20px;">Loading...</div>
            </div>

            <div id="view-decks" class="hidden">
                <h2>Ritual Library</h2>
                <div id="deck-workspace">
                    <div id="editor-mode" class="deck-area-edit">
                        <div class="card-box">
                            <div style="display:flex; align-items:center; margin-bottom:10px;">
                                <input id="deckName" placeholder="Ritual Name (e.g. Eldrazi Aggro)" style="margin-bottom: 0; flex-grow: 1; padding-left:14px;">
                                <button class="secondary clear-btn" onclick="clearDeckEditor()">üóëÔ∏è</button>
                            </div>
                            <textarea id="deckList" placeholder="1 Sol Ring..."></textarea>
                            <button id="validateDeckBtn" onclick="validateDeck()">‚úÖ Validate & Resolve Ritual</button>
                            <button onclick="saveDeck()" style="margin-top:10px;">üíæ Forge Ritual</button>
                        </div>
                        <div class="card-box">
                            <h3 style="margin-top:0;">Saved Rituals</h3>
                            <div id="saved-decks-list"></div>
                        </div>
                    </div>
                    
                    <div id="detail-mode" class="deck-area-detail hidden">
                        <div class="card-box">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                                <div style="flex-grow:1;">
                                    <h3 id="detail-deck-name" style="margin:0; font-size:1.5rem; color:var(--primary);"></h3>
                                    <div style="font-size:11px; color:var(--subtext); margin-top:5px; display:flex; align-items:center; gap:8px;">
                                        OWNERSHIP: <span id="detail-owned-percent">0%</span>
                                        <div class="progress-bg" style="width:100px; height:6px; margin:0;"><div id="detail-owned-bar" class="progress-fill" style="width:0%"></div></div>
                                    </div>
                                </div>
                                <div style="display:flex; gap:10px;">
                                    <button style="width:auto; padding:8px 16px; font-size:12px; background:var(--primary); color:white;" onclick="openProphecy()">üîÆ Prophecy</button>
                                    <button style="width:auto; padding:8px 16px; font-size:12px; background:var(--green);" onclick="saveDeck()">üíæ Save</button>
                                    <button class="secondary" style="width:auto; padding:8px 16px; font-size:12px;" onclick="showRitualEditor(true)">‚úçÔ∏è Edit</button>
                                </div>
                            </div>
                            <div class="deck-list-viewer" id="detail-decklist-viewer">Card list will appear here...</div>
                        </div>
                        <div class="card-box">
                            <h3>Ritual Analysis</h3>
                            <div id="detail-analysis-results" style="font-size:13px; color:var(--subtext);">Metrics will appear here.</div>
                            <div id="deck-charts" class="hidden">
                                <div style="position:relative;"><canvas id="typeChart"></canvas></div>
                                <div style="position:relative;"><canvas id="manaCurve"></canvas></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="b-item active" onclick="nav('dashboard', 'dashboard')"><span class="b-icon">üè†</span>Dash</div>
            <div class="b-item" onclick="nav('add', 'add')"><span class="b-icon">‚ûï</span>Add</div>
            <div class="b-item" onclick="nav('collection', 'collection')"><span class="b-icon">üìö</span>Vault</div>
            <div class="b-item" onclick="nav('decks', 'decks')"><span class="b-icon">üìã</span>Rituals</div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const SUPABASE_URL = "https://mdirqlntcxqkthbwubmj.supabase.co"; 
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1kaXJxbG50Y3hxa3RoYnd1Ym1qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2OTUyOTAsImV4cCI6MjA4MTI3MTI5MH0.XBhYZiwINycA-QjAH-cL4vFzzyppm1c4M322jNDmbvE"; 
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let session = null;
        let tempCardData = null; 
        let allVersions = [];     
        let searchTimer;
        let cardsCache = []; 
        let currentViewedDeckId = null;
        let isResetMode = false;

        const CHART_COLORS = ['#d946ef', '#dc2626', '#a78bfa', '#4f46e5', '#059669', '#737373', '#facc15'];

        // --- TOAST HELPER ---
        function showToast(message, type = 'info') {
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                document.body.appendChild(container);
            }
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${message}</span> <span style="cursor:pointer; opacity:0.5;" onclick="this.parentElement.remove()">‚úï</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.classList.add('hiding'); toast.addEventListener('animationend', () => toast.remove()); }, 3000); 
            setTimeout(() => { if(toast.parentElement) toast.remove(); }, 3500);
        }

        // --- 2. AUTHENTICATION & RESET ---
        function toggleResetMode() {
            isResetMode = !isResetMode;
            const passInput = document.getElementById('password');
            const passGroup = passInput.parentElement; 
            const btn = document.getElementById('auth-btn');
            const forgotLink = document.getElementById('forgot-link');
            const msg = document.getElementById('auth-msg');

            if (isResetMode) {
                passGroup.classList.add('hidden');
                btn.innerText = "Send Recovery Magic";
                forgotLink.innerText = "Back to Login";
                msg.innerText = "Enter your email to recover your pact.";
            } else {
                passGroup.classList.remove('hidden');
                btn.innerText = "Summon Session";
                forgotLink.innerText = "Forgot Password?";
                msg.innerText = "First time? A pact will be forged upon login.";
            }
        }

        async function handleAuthAction() {
            if (isResetMode) await handlePasswordReset();
            else await handleLogin();
        }

        async function handlePasswordReset() {
            const email = document.getElementById('email').value;
            if(!email) return showToast("Enter your email address.", "error");
            const btn = document.getElementById('auth-btn');
            btn.innerText = "Casting..."; btn.disabled = true;
            const { data, error } = await sb.auth.resetPasswordForEmail(email, { redirectTo: window.location.href });
            btn.disabled = false;
            if (error) {
                btn.innerText = "Send Recovery Magic";
                showToast("Failed: " + error.message, "error");
            } else {
                btn.innerText = "Sent!";
                showToast("Recovery magic sent! Check your inbox.", "success");
            }
        }

        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            if(!email || !password) return showToast("Please enter email and password", "error");
            
            const btn = document.getElementById('auth-btn');
            const msg = document.getElementById('auth-msg');
            btn.innerText = "Processing..."; btn.disabled = true;

            let { data, error } = await sb.auth.signInWithPassword({ email, password });
            
            if (error) {
                if (error.message.includes("Invalid login credentials")) {
                    showToast("Invalid credentials. If you are new, we will attempt to create an account.", "info");
                }
                const signUp = await sb.auth.signUp({ email, password, options: { emailRedirectTo: window.location.href } });
                if (signUp.error) {
                    showToast(signUp.error.message, "error");
                    btn.innerText = "Summon Session"; btn.disabled = false;
                } else {
                    if(signUp.data.session) finalizeLogin(signUp.data.session);
                    else {
                        msg.innerText = "‚úÖ Pact Forged! Check your email.";
                        msg.style.color = "var(--green)";
                        btn.innerText = "Check Email";
                        btn.disabled = false;
                    }
                }
            } else {
                finalizeLogin(data.session);
            }
        }

        function finalizeLogin(newSession) {
            session = newSession;
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('user-email').innerText = session.user.email;
            loadData();
            showToast("Welcome back, Warlock.", "success");
        }

        async function handleLogout() {
            await sb.auth.signOut();
            window.location.reload(); 
        }

        sb.auth.onAuthStateChange((event, _session) => {
            if (event === 'SIGNED_IN' && _session) {
                session = _session;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                document.getElementById('user-email').innerText = session.user.email;
                if(cardsCache.length === 0) loadData(); 
            } else if (event === 'SIGNED_OUT') {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app').classList.add('hidden');
                session = null;
            } else if (event === 'PASSWORD_RECOVERY') {
                showToast("Recovery successful. Please change your password.", "success");
            }
        });

        // --- 3. NAVIGATION ---
        function nav(view, id) {
            document.querySelectorAll('.main > div').forEach(d => d.classList.add('hidden'));
            const target = document.getElementById('view-' + view);
            if(target) target.classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => {
                if(el.getAttribute('onclick').includes(`'${id}'`)) el.classList.add('active');
            });

            document.querySelectorAll('.b-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.b-item').forEach(el => {
                if(el.getAttribute('onclick').includes(`'${id}'`)) el.classList.add('active');
            });

            if (view !== 'decks') {
                showRitualEditor(false); 
                clearCharts();
            }

            if(view === 'collection') loadCollection();
            if(view === 'decks') loadDecks();
        }

        // --- 4. DATA LOGIC (Cards) ---
        function debounceSearch() { clearTimeout(searchTimer); searchTimer = setTimeout(fetchCardMeta, 500); }

        async function fetchCardMeta() {
            const name = document.getElementById('search').value;
            const status = document.getElementById('search-status');
            const select = document.getElementById('versionSelect');
            status.innerText = ""; select.innerHTML = '<option>Searching...</option>';
            document.getElementById('preview').style.display = 'none';
            document.getElementById('preview-text').style.display = 'block';
            document.getElementById('set').value = ''; document.getElementById('num').value = '';
            document.getElementById('marketPrice').innerText = '--';
            allVersions = []; tempCardData = null;

            if(name.length < 3) return;
            status.innerText = "Searching Scryfall...";

            try {
                const res = await fetch(`https://api.scryfall.com/cards/search?q=${encodeURIComponent(name)}&unique=prints`);
                const data = await res.json();
                if (data.object === 'error' || !data.data || data.data.length === 0) { status.innerText = "Relic not found."; select.innerHTML = '<option>No versions found</option>'; return; }
                allVersions = data.data.filter(c => c.lang === 'en' && c.collector_number && c.layout !== 'token' && c.layout !== 'art_series');
                allVersions.sort((a, b) => new Date(b.released_at) - new Date(a.released_at));
                if (allVersions.length === 0) { status.innerText = "No usable Relic versions found."; select.innerHTML = '<option>No versions found</option>'; return; }
                status.innerText = `Found ${allVersions.length} versions.`;
                select.innerHTML = '';
                allVersions.forEach((v, index) => {
                    const price = v.prices.usd || v.prices.usd_foil || 'N/A';
                    const option = document.createElement('option');
                    option.value = index;
                    option.text = `${v.set_name} (${v.set.toUpperCase()} #${v.collector_number}) - $${price}`;
                    select.appendChild(option);
                });
                select.selectedIndex = 0; updateSelectedVersion();
            } catch(e) { status.innerText = "Error connecting to Scryfall."; console.error(e); }
        }
        
        function updateSelectedVersion() {
            const select = document.getElementById('versionSelect');
            if (select.value === "") return;
            const index = parseInt(select.value);
            const v = allVersions[index];
            if (!v) return;
            const imageUrl = v.image_uris ? v.image_uris.normal : (v.card_faces && v.card_faces[0].image_uris ? v.card_faces[0].image_uris.normal : '');
            const usdPrice = v.prices.usd || v.prices.usd_foil || 0;
            document.getElementById('set').value = v.set.toUpperCase(); document.getElementById('num').value = v.collector_number;
            document.getElementById('marketPrice').innerText = usdPrice ? `$${parseFloat(usdPrice).toFixed(2)}` : 'N/A';
            const preview = document.getElementById('preview');
            preview.src = imageUrl; preview.style.display = 'block';
            document.getElementById('preview-text').style.display = 'none';
            tempCardData = { name: v.name, set: v.set.toUpperCase(), num: v.collector_number, img: imageUrl, market_price: parseFloat(usdPrice) };
        }

        async function addCard() {
            if(!tempCardData) return showToast("Search and select a Relic version first", "error");
            const costInput = document.getElementById('cost').value;
            const qty = document.getElementById('qty').value || 1;
            const btn = document.querySelector('#view-add button');
            if(Number(qty) <= 0) return showToast("Quantity must be greater than zero.", "error");
            btn.innerText = "Binding..."; btn.disabled = true;
            const costToSave = costInput.length > 0 ? parseFloat(costInput) : null;
            const { error } = await sb.from('cards').insert({ user_id: session.user.id, name: tempCardData.name, set_code: tempCardData.set, collector_number: tempCardData.num, image_url: tempCardData.img, buy_price: costToSave, quantity: qty, market_price_usd: tempCardData.market_price, last_price_update: new Date().toISOString() });
            btn.innerText = "Bind to Vault"; btn.disabled = false;
            if(!error) { 
                showToast(`‚úÖ Added ${qty}x ${tempCardData.name} to Vault!`, "success"); 
                document.getElementById('search').value = ""; document.getElementById('cost').value = ""; document.getElementById('qty').value = "1"; document.getElementById('versionSelect').innerHTML = ''; document.getElementById('preview').style.display = 'none'; document.getElementById('search-status').innerText = ""; document.getElementById('set').value = ''; document.getElementById('num').value = ''; document.getElementById('marketPrice').innerText = '--'; tempCardData = null; loadData(); 
            } else { showToast(error.message, "error"); }
        }

        async function loadData() {
            const { data: cards, error } = await sb.from('cards').select('*').order('created_at', { ascending: false });
            if(error) return console.error(error);
            cardsCache = cards; 
            let totalVal = 0, totalCost = 0, count = 0;
            cards.forEach(c => { count += c.quantity; if (c.buy_price !== null && Number(c.buy_price) > 0) totalCost += Number(c.buy_price) * c.quantity; totalVal += (Number(c.market_price_usd || 0) * c.quantity); });
            document.getElementById('stat-count').innerText = count; document.getElementById('stat-cost').innerText = "$" + totalCost.toFixed(2); document.getElementById('stat-value').innerText = "$" + totalVal.toFixed(2);
            const gain = totalVal - totalCost;
            const gainEl = document.getElementById('stat-gain'); gainEl.innerText = `$${gain.toFixed(2)}`; gainEl.style.color = gain >= 0 ? 'var(--green)' : 'var(--red)';
            if(cards.length > 0) {
                const recent = cards.slice(0, 5); 
                document.getElementById('recent-grid').innerHTML = recent.map(c => `
                    <div class="grid-card"><img src="${c.image_url}" loading="lazy" onload="this.style.opacity=1"><div class="overlay"><span>${c.name.substring(0, 15)}...</span><span>$${Number(c.market_price_usd || 0).toFixed(2)}</span></div></div>
                `).join('');
            } else { document.getElementById('recent-grid').innerHTML = '<div style="color:var(--subtext); padding:20px; font-size:13px; grid-column:1/-1; text-align:center;">No cards found. Go to \'Add Relic\' to start!</div>'; }
        }

        async function loadCollection() {
            const grid = document.getElementById('collection-grid');
            grid.innerHTML = Array(10).fill('<div class="skeleton sk-card"></div>').join('');
            const cards = cardsCache.length > 0 ? cardsCache : (await sb.from('cards').select('*')).data;
            if(cards.length === 0) { grid.innerHTML = '<div style="color:var(--subtext); grid-column:1/-1; text-align:center;">No cards found.</div>'; return; }
            cardsCache = cards; 
            grid.innerHTML = cards.map(c => `
                <div class="grid-card" id="card-${c.id}"><div class="overlay" style="top:5px; height:auto; background:none; align-items:flex-start;"><button style="background:var(--red); padding:4px 8px; border-radius:4px; font-size:10px; width:auto; transform:none;" onclick="deleteCard('${c.id}', event)">üóëÔ∏è Sacrifice</button></div><img src="${c.image_url}" loading="lazy" onload="this.style.opacity=1"><div class="overlay"><span>${c.quantity}x</span><span>$${Number(c.market_price_usd || 0).toFixed(2)}</span></div></div>
            `).join('');
        }

        async function deleteCard(id, e) {
            e.stopPropagation(); if(!confirm("Are you sure you want to sacrifice this relic?")) return;
            const cardEl = document.getElementById(`card-${id}`); if(cardEl) cardEl.style.display = 'none';
            cardsCache = cardsCache.filter(c => c.id !== Number(id));
            const { error } = await sb.from('cards').delete().eq('id', id);
            if(error) { showToast(`Error: ${error.message}`, "error"); if(cardEl) cardEl.style.display = 'block'; } 
            else { showToast("Relic sacrificed.", "success"); }
            loadData(); 
        }

        // --- 5. DECK LOGIC (LOCAL ANALYTICS & THE LINK) ---
        function analyzeOwnership(deckListText) {
            const vaultMap = {};
            cardsCache.forEach(c => { const key = c.name.toLowerCase().trim(); vaultMap[key] = (vaultMap[key] || 0) + c.quantity; });
            const basics = ['plains', 'island', 'swamp', 'mountain', 'forest', 'wastes', 'snow-covered plains', 'snow-covered island', 'snow-covered swamp', 'snow-covered mountain', 'snow-covered forest'];
            const lines = deckListText.split('\n'); let html = ''; let totalCards = 0; let totalOwned = 0; const regex = /^(\d+)\s+(.+)/;
            lines.forEach(line => {
                const match = line.trim().match(regex);
                if (match) {
                    const qtyNeeded = parseInt(match[1]); const name = match[2].trim(); const key = name.toLowerCase().replace(/[^a-z0-9]/g, '');
                    let qtyOwned = 0;
                    if (basics.includes(name.toLowerCase())) { qtyOwned = qtyNeeded; } 
                    else { for (let vKey in vaultMap) { const vKeyClean = vKey.replace(/[^a-z0-9]/g, ''); if (vKeyClean === key || vKeyClean.includes(key) || key.includes(vKeyClean)) { qtyOwned += vaultMap[vKey]; } } }
                    totalCards += qtyNeeded;
                    const ownedForThisLine = Math.min(qtyOwned, qtyNeeded);
                    totalOwned += ownedForThisLine;
                    let statusClass = 'is-missing';
                    if (qtyOwned >= qtyNeeded) statusClass = 'is-owned'; else if (qtyOwned > 0) statusClass = 'is-partial';
                    html += `<div class="deck-line ${statusClass}"><strong>${qtyNeeded}</strong> ${name} <span style="float:right; font-size:10px; opacity:0.7;">(Own: ${qtyOwned})</span></div>`;
                } else if (line.trim().length > 0) { html += `<div class="deck-line" style="opacity:0.5; font-size:11px;">${line}</div>`; }
            });
            const percent = totalCards > 0 ? Math.round((totalOwned / totalCards) * 100) : 0;
            document.getElementById('detail-decklist-viewer').innerHTML = html;
            document.getElementById('detail-owned-percent').innerText = `${percent}%`;
            document.getElementById('detail-owned-bar').style.width = `${percent}%`;
            const bar = document.getElementById('detail-owned-bar');
            if(percent === 100) bar.style.backgroundColor = 'var(--green)'; else if(percent > 50) bar.style.backgroundColor = 'var(--primary)'; else bar.style.backgroundColor = 'var(--red)';
        }

        let typeChartInstance = null; let manaCurveInstance = null;
        function clearCharts() { if (typeChartInstance) { typeChartInstance.destroy(); typeChartInstance = null; } if (manaCurveInstance) { manaCurveInstance.destroy(); manaCurveInstance = null; } document.getElementById('deck-charts').classList.add('hidden'); }
        function renderTypeChart(typeData) { if (typeChartInstance) typeChartInstance.destroy(); const ctx = document.getElementById('typeChart').getContext('2d'); typeChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(typeData), datasets: [{ data: Object.values(typeData), backgroundColor: CHART_COLORS, borderColor: 'rgba(0, 0, 0, 0.4)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { position: 'right', labels: { color: '#a1a1aa' } }, title: { display: true, text: 'Card Type Breakdown', color: 'white' } } } }); }
        function renderManaCurve(cmcData) { if (manaCurveInstance) manaCurveInstance.destroy(); const ctx = document.getElementById('manaCurve').getContext('2d'); const maxCmc = Math.max(...Object.keys(cmcData).map(Number)); const labels = []; const data = []; for (let i = 0; i <= Math.min(maxCmc, 6); i++) { labels.push(i.toString()); data.push(cmcData[i] || 0); } let cmcSevenPlus = 0; for (let i = 7; i <= maxCmc; i++) { cmcSevenPlus += (cmcData[i] || 0); } if (maxCmc >= 7 || maxCmc === 0) { labels.push('7+'); data.push(cmcSevenPlus); } manaCurveInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Card Count', data: data, backgroundColor: '#a78bfa', borderColor: 'rgba(167, 139, 250, 0.2)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false }, title: { display: true, text: 'Mana Value (CMC) Curve', color: 'white' } }, scales: { x: { ticks: { color: '#a1a1aa' }, grid: { color: 'rgba(255,255,255,0.05)' } }, y: { ticks: { color: '#a1a1aa', stepSize: 1 }, grid: { color: 'rgba(255,255,255,0.05)' } } } } }); }

        function parseDeckList(deckListText) {
            const lines = deckListText.split('\n'); let total = 0; const uniqueCardNames = new Map(); const regex = /^(\d+)\s+(.+)/; 
            lines.forEach(line => { const match = line.trim().match(regex); if (match) { const quantity = parseInt(match[1]); const name = match[2].trim(); if (!isNaN(quantity) && name.length > 0) { total += quantity; const key = name.toLowerCase().replace(/[^a-z0-9]/g, ''); const existing = uniqueCardNames.get(key); if (existing) { existing.qty += quantity; } else { uniqueCardNames.set(key, { qty: quantity, name: name }); } } } });
            return { totalCount: total, cards: Array.from(uniqueCardNames.values()) };
        }
        
        async function validateDeck() {
            const listText = document.getElementById('deckList').value;
            const resultsEl = document.getElementById('detail-analysis-results'); 
            const btn = document.getElementById('validateDeckBtn');
            if (!listText) return showToast("Ritual list is empty.", "error");

            document.getElementById('editor-mode').classList.add('hidden');
            document.getElementById('detail-mode').classList.remove('hidden');
            document.getElementById('detail-deck-name').innerText = document.getElementById('deckName').value || "New Ritual";
            
            // RUN THE LINK (Ownership Analysis)
            analyzeOwnership(listText);

            resultsEl.innerHTML = `<p style="color:var(--subtext);">Processing ritual list...</p>`;
            if(btn) { btn.innerText = "Resolving..."; btn.disabled = true; }

            const { totalCount, cards: parsedCards } = parseDeckList(listText);
            if (parsedCards.length === 0) { if(btn) { btn.innerText = "‚úÖ Validate & Resolve Ritual"; btn.disabled = false; } resultsEl.innerHTML = '<p style="color:var(--red);">No valid relic lines found.</p>'; return showToast("No valid ritual lines found.", "error"); }
            const identifiers = parsedCards.map(c => ({ name: c.name })); const chunkSize = 75; const totalChunks = Math.ceil(identifiers.length / chunkSize); let allMatchedCards = []; let allUnmatched = [];
            try {
                for (let i = 0; i < totalChunks; i++) { const chunk = identifiers.slice(i * chunkSize, (i + 1) * chunkSize); const response = await fetch('https://api.scryfall.com/cards/collection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ identifiers: chunk }) }); const data = await response.json(); if (data.object === 'error') throw new Error(data.details); allMatchedCards = allMatchedCards.concat(data.data); if (data.not_found) allUnmatched = allUnmatched.concat(data.not_found); }
                const typeAgg = {}; const cmcAgg = {};
                allMatchedCards.forEach(cardData => { 
                    const deckCard = parsedCards.find(c => c.name === cardData.name); 
                    const quantity = deckCard ? deckCard.qty : 1; 
                    const primaryType = cardData.type_line ? cardData.type_line.split('‚Äî')[0].split(' ')[0].trim() : 'Unknown'; 
                    typeAgg[primaryType] = (typeAgg[primaryType] || 0) + quantity; 
                    
                    // EXCLUDE LANDS FROM CMC CURVE
                    if (!cardData.type_line.toLowerCase().includes('land')) {
                        const cmc = Math.floor(cardData.cmc || 0); 
                        cmcAgg[cmc] = (cmcAgg[cmc] || 0) + quantity; 
                    }
                });
                let output = `<p style="color:var(--green); font-weight: 600;">‚úÖ Resolution Complete! Total Relics: ${totalCount}</p>`; output += `<p>Found **${allMatchedCards.length}** unique relic definitions.</p>`;
                if (allUnmatched.length > 0) { output += `<p style="color:var(--red); font-weight: 600;">‚ö†Ô∏è ${allUnmatched.length} Relic Names Unmatched:</p><ul>`; allUnmatched.forEach(u => output += `<li style="margin-left: -20px;">* ${u.name || 'Unknown'} (Typo?)</li>`); output += `</ul><p>Please fix these names in the editor.</p>`; showToast(`Validation failed: ${allUnmatched.length} unmatched.`, "error"); } else { output += `<p style="color:var(--green);">All unique relic names resolved!</p>`; showToast(`Ritual successfully resolved!`, "success"); }
                resultsEl.innerHTML = output;
                if (allUnmatched.length === 0) { document.getElementById('deck-charts').classList.remove('hidden'); renderTypeChart(typeAgg); renderManaCurve(cmcAgg); }
            } catch (error) { resultsEl.innerHTML = `<p style="color:var(--red);">Error: ${error.message}</p>`; showToast("Validation Error.", "error"); } finally { if(btn) { btn.innerText = "‚úÖ Validate & Resolve Ritual"; btn.disabled = false; } }
        }

        // --- 6. PROPHECY LOGIC ---
        function openProphecy() { document.getElementById('prophecy-modal').classList.remove('hidden'); drawProphecy(); }
        function closeProphecy() { document.getElementById('prophecy-modal').classList.add('hidden'); }
        async function drawProphecy() {
            const container = document.getElementById('prophecy-hand-container'); container.innerHTML = '<p style="color:var(--subtext);">Shuffling the ether...</p>';
            const listText = document.getElementById('deckList').value; const { cards } = parseDeckList(listText); let fullDeck = [];
            cards.forEach(c => { for(let i=0; i<c.qty; i++) fullDeck.push(c.name); });
            if(fullDeck.length < 7) { container.innerHTML = '<p style="color:var(--red);">Deck is too small for a prophecy.</p>'; return; }
            for (let i = fullDeck.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [fullDeck[i], fullDeck[j]] = [fullDeck[j], fullDeck[i]]; }
            const handNames = fullDeck.slice(0, 7); const identifiers = handNames.map(name => ({ name }));
            try {
                const response = await fetch('https://api.scryfall.com/cards/collection', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ identifiers }) });
                const data = await response.json(); container.innerHTML = '';
                handNames.forEach((handCardName, index) => {
                    const cardData = data.data.find(c => c.name === handCardName) || data.data.find(c => c.name.includes(handCardName)); 
                    if (cardData) { const imgUrl = cardData.image_uris ? cardData.image_uris.normal : (cardData.card_faces ? cardData.card_faces[0].image_uris.normal : ''); const delay = index * 0.1; container.innerHTML += `<div class="prophecy-card" style="animation-delay: ${delay}s"><img src="${imgUrl}" style="width:100%; border-radius:10px;"></div>`; } 
                    else { container.innerHTML += `<div class="prophecy-card" style="background:rgba(255,255,255,0.1); display:flex; align-items:center; justify-content:center; color:white; font-size:10px;">${handCardName}</div>`; }
                });
            } catch(e) { container.innerHTML = '<p style="color:var(--red);">The vision is clouded (API Error).</p>'; }
        }

        // --- NEW RITUAL VIEW CONTROL FUNCTIONS ---
        function viewRitualDetails(id) {
            currentViewedDeckId = id; const d = window.myDecks.find(x => x.id == id);
            if (!d) return showToast("Ritual not found in local cache.", "error");
            document.getElementById('deckName').value = d.name; document.getElementById('deckList').value = d.card_list;
            validateDeck(); 
        }
        function showRitualEditor(keepData = false) {
            document.getElementById('detail-mode').classList.add('hidden'); document.getElementById('editor-mode').classList.remove('hidden'); clearCharts(); currentViewedDeckId = null; 
            if (!keepData) { document.getElementById('deckName').value = ''; document.getElementById('deckList').value = ''; const resultsEl = document.getElementById('detail-analysis-results') || document.getElementById('deck-analysis-results'); if(resultsEl) resultsEl.innerHTML = '<p style="font-size:13px; color:var(--subtext);">Metrics will appear here.</p>'; }
        }
        function clearDeckEditor() { showRitualEditor(false); showToast("Ritual editor cleared.", "info"); }
        async function saveDeck() {
            const name = document.getElementById('deckName').value; const list = document.getElementById('deckList').value;
            if(!name) return showToast("Name required", "error");
            const { totalCount } = parseDeckList(list); 
            let error;
            if (currentViewedDeckId) { const res = await sb.from('decks').update({ name: name, card_list: list, card_count: totalCount }).eq('id', currentViewedDeckId); error = res.error; } 
            else { const res = await sb.from('decks').insert({ user_id: session.user.id, name: name, card_list: list, card_count: totalCount }); error = res.error; }
            if(!error) { showToast(`üíæ Ritual '${name}' saved!`, "success"); loadDecks(); } else { showToast(error.message, "error"); }
        }
        async function loadDecks() {
            showRitualEditor(); 
            const { data } = await sb.from('decks').select('*').order('updated_at', { ascending: false });
            const listEl = document.getElementById('saved-decks-list');
            if (!data || data.length === 0) { listEl.innerHTML = '<div style="color:var(--subtext); padding:10px;">No saved rituals.</div>'; return; }
            listEl.innerHTML = data.map(d => { const countText = d.card_count ? `(${d.card_count} relics)` : '(count unknown)'; return ` <div class="deck-item-preview" onclick="viewRitualDetails('${d.id}')"> <div> <div style="font-weight:600; color:white;">${d.name}</div> <div class="deck-item-info">${countText}</div> </div> <span style="font-size:12px; color:var(--red); padding:5px;" onclick="deleteDeck('${d.id}', event)">‚úï</span> </div> `; }).join('');
            window.myDecks = data;
        }
        async function deleteDeck(id, e) {
            e.stopPropagation(); if(!confirm("Delete ritual?")) return;
            if (currentViewedDeckId == id) { showRitualEditor(false); }
            await sb.from('decks').delete().eq('id', id); showToast("Ritual removed.", "success"); loadDecks();
        }

        // Initialize Session Check
        sb.auth.getSession().then(({ data: { session: existingSession } }) => {
            if (existingSession) { session = existingSession; document.getElementById('auth-screen').classList.add('hidden'); document.getElementById('app').classList.remove('hidden'); document.getElementById('user-email').innerText = session.user.email; loadData(); }
        });
    </script>
</body>
</html>

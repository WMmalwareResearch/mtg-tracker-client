async function logDailyValue(totalVal) {
            // V4.0.7 FIX: Removing reliance on non-existent 'id' column.
            const today = new Date().toISOString().slice(0, 10); // Format YYYY-MM-DD
            const numericValue = parseFloat(totalVal.toFixed(2));

            // 1. Check if a log entry exists for today, selecting only the date (or any column)
            const { data: existingEntry, error: selectError } = await sb
                .from('price_history')
                .select('date') // Selecting 'date' column which must exist
                .eq('user_id', session.user.id)
                .eq('date', today)
                .maybeSingle();

            if (selectError) {
                console.error("Supabase Select Error in logDailyValue (Select):", selectError.message);
                return;
            }

            // 2. If NO entry is found, perform the insert
            if (!existingEntry) {
                const { error: insertError } = await sb.from('price_history').insert({
                    user_id: session.user.id,
                    date: today,
                    portfolio_value: numericValue
                });

                if (insertError) {
                    console.error("Supabase Insert Error in logDailyValue (Insert):", insertError.message);
                    showToast("Error logging price history: Check console.", "error");
                } else {
                    console.log(`Successfully logged daily value: $${numericValue}`);
                }
            } else {
                // 3. If entry IS found, UPDATE using the composite primary key (user_id and date)
                const { error: updateError } = await sb.from('price_history').update({
                    portfolio_value: numericValue
                })
                .eq('user_id', session.user.id)
                .eq('date', today);
                
                if (updateError) {
                    console.error("Supabase Update Error in logDailyValue (Update):", updateError.message);
                } else {
                     console.log(`Updated existing daily value for ${today}: $${numericValue}`); 
                }
            }
        }

<!DOCTYPE html>
<html lang="en">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Grimoire | v9.4 (Button Fix)</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü©∏</text></svg>">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- THEME & VARS --- */
        :root { 
            --primary: #a78bfa; 
            --bg-dark: #0f0a1c; 
            --card-bg: rgba(45, 21, 60, 0.8); 
            --text: #f8fafc; 
            --subtext: #a1a1aa; 
            --border: rgba(167, 139, 250, 0.2); 
            --green: #d946ef; --red: #dc2626; --yellow: #facc15; --blue: #3b82f6; 
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            --chart-color-1: #d946ef; --chart-color-2: #dc2626; --chart-color-3: #a78bfa; --chart-color-4: #4f46e5; --chart-color-5: #059669;
        }

        body { font-family: 'Inter', sans-serif; background: radial-gradient(circle at top left, #1a1a1a, var(--bg-dark)); background-attachment: fixed; color: var(--text); margin: 0; height: 100vh; display: flex; flex-direction: column; font-size: clamp(1rem, 0.8rem + 0.5vw, 1.125rem); overflow: hidden; transition: background 0.5s; }
        * { box-sizing: border-box; }
        .hidden { display: none !important; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* --- UI POLISH & BUTTONS --- */
        /* Ripple Effect */
        button { position: relative; overflow: hidden; transform: translate3d(0, 0, 0); cursor: pointer; user-select: none; }
        button:after {
            content: ""; display: block; position: absolute; width: 100%; height: 100%; top: 0; left: 0; pointer-events: none;
            background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
            background-repeat: no-repeat; background-position: 50%; transform: scale(10, 10); opacity: 0; transition: transform .5s, opacity 1s;
        }
        button:active:after { transform: scale(0, 0); opacity: .2; transition: 0s; }
        button:disabled, .btn-disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); }

        /* V9.3: Loading Spinner (The Guard) */
        .btn-loading { pointer-events: none; opacity: 0.7; position: relative; color: transparent !important; }
        .btn-loading::after {
            content: ""; position: absolute; left: 50%; top: 50%; width: 16px; height: 16px; margin: -8px 0 0 -8px;
            border: 2px solid white; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; color: white;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* UTILITIES */
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .flex-row { display: flex; align-items: center; gap: 10px; }
        .flex-col { display: flex; flex-direction: column; }
        .w-full { width: 100%; }
        .mt-15 { margin-top: 15px; } .mb-15 { margin-bottom: 15px; } .mb-20 { margin-bottom: 20px; }
        .text-sub { font-size: 12px; color: var(--subtext); }
        .text-bold { font-weight: 700; }
        .text-green { color: var(--green); } .text-red { color: var(--red); }

        /* LAYOUT */
        .app-container { display: grid; grid-template-columns: 240px 1fr; height: 100%; overflow: hidden; }
        .sidebar { background: var(--card-bg); backdrop-filter: blur(12px); border-right: 1px solid var(--border); padding: 25px; display: flex; flex-direction: column; z-index: 10; }
        .bottom-nav { display: none; } 

        @media (max-width: 768px) { 
            .app-container { grid-template-columns: 1fr; padding-bottom: 80px; } 
            .sidebar { display: none; } 
            .bottom-nav { display: flex; position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(15, 10, 28, 0.95); border-top: 1px solid var(--border); padding: 10px 0; justify-content: space-around; z-index: 20; backdrop-filter: blur(10px); }
            .main { padding: 20px 15px; }
            .stat-grid { grid-template-columns: repeat(2, 1fr); }
            .dashboard-split { grid-template-columns: 1fr; }
            #view-add .card-box, #view-settings .card-box { max-width: 100%; margin: 0; }
        }

        .logo { font-size: 22px; font-weight: 700; color: var(--primary); margin-bottom: 40px; display: flex; align-items: center; gap: 12px; }
        .nav-item { padding: 12px 15px; cursor: pointer; color: var(--subtext); font-weight: 500; border-radius: 8px; transition: all 0.2s; margin-bottom: 4px; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover { background: rgba(255, 255, 255, 0.05); color: white; }
        .nav-item.active { background: rgba(255, 255, 255, 0.1); color: white; border-left: 3px solid var(--primary); padding-left: 12px; }
        .main { padding: 40px clamp(1rem, 2vw + 1rem, 5rem); overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }
        #view-battlefield { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 50; background: var(--bg-dark); overflow: hidden; display: flex; flex-direction: column; }
        .b-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: var(--subtext); cursor: pointer; }
        .b-icon { font-size: 20px; margin-bottom: 4px; }
        .b-item.active { color: var(--primary); }

        /* COMPONENTS */
        .skeleton { background-color: var(--card-bg); background-image: linear-gradient(90deg, var(--card-bg) 0%, rgba(167, 139, 250, 0.1) 20%, var(--card-bg) 40%, var(--card-bg) 100%); background-size: 200% 100%; animation: shimmer 1.5s infinite linear; border-radius: 4px; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        .card-box { background: var(--card-bg); backdrop-filter: blur(12px); padding: 1.5rem; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 24px; box-shadow: var(--shadow); }
        h2 { margin-top: 0; font-size: 1.5rem; font-weight: 600; margin-bottom: 20px; }
        h3 { font-size: 1rem; font-weight: 600; color: var(--subtext); margin-top: 0; text-transform: uppercase; font-size: 12px; margin-bottom: 15px;}
        .input-group { position: relative; display: flex; align-items: center; margin-bottom: 15px; }
        .input-icon { position: absolute; left: 12px; color: var(--subtext); font-size: 16px; pointer-events: none; }
        input, select { width: 100%; padding: 14px 14px 14px 40px; border-radius: 8px; border: 1px solid var(--border); background: rgba(0,0,0,0.4); color: white; font-size: 14px; margin: 0; }
        textarea { padding: 14px; margin-bottom: 15px; height: 350px; resize: vertical; background: rgba(0,0,0,0.2); border: 1px solid var(--border); color: var(--text); border-radius: 8px; width: 100%; font-family: monospace; font-size: 13px; }
        button { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 14px; transition: transform 0.1s, opacity 0.2s, background 0.3s; }
        button:hover { opacity: 0.85; } button:active { transform: scale(0.98); }
        button.secondary { background: rgba(255,255,255,0.1); }
        .clear-btn { background: none; color: var(--subtext); width: 40px; padding: 0; height: 100%; margin-left: 10px; opacity: 0.7; }
        
        .theme-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-bottom: 20px; }
        .theme-btn { width: 100%; aspect-ratio: 1; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }
        .theme-btn:hover { transform: scale(1.1); }
        .theme-btn.active-theme { border-color: white; box-shadow: 0 0 10px white; }

        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: rgba(255,255,255,0.03); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .stat-val { font-size: 28px; font-weight: 700; color: white; margin-bottom: 5px; }
        .stat-lbl { font-size: 11px; text-transform: uppercase; color: var(--subtext); font-weight: 600; letter-spacing: 1px; }
        .dashboard-split { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .asset-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .asset-info { display: flex; align-items: center; gap: 15px; }
        .asset-img { width: 40px; height: 56px; border-radius: 4px; object-fit: cover; border: 1px solid var(--border); }
        .asset-val { font-weight: 700; color: var(--green); }
        
        .collection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 20px; }
        #recent-grid { grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 12px; }
        .grid-card { position: relative; aspect-ratio: 2.5/3.5; border-radius: 10px; overflow: hidden; cursor: pointer; transition: transform 0.2s; background: rgba(0,0,0,0.3); border: 1px solid var(--border); }
        .grid-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .grid-card img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.5s; }
        .overlay { position: absolute; bottom: 0; width: 100%; padding: 10px; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); font-size: 12px; font-weight: 600; color: white; display:flex; justify-content:space-between; align-items: flex-end; box-sizing: border-box; height: 50px; }
        .gain-badge { position: absolute; top: 10px; right: 10px; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700; background: rgba(0,0,0,0.8); z-index: 5; }
        .tag-container { position: absolute; top: 10px; left: 10px; display: flex; flex-direction: column; gap: 4px; z-index: 5; align-items: flex-start; }
        .tag-pill { background: var(--primary); color: white; font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: 700; box-shadow: 0 2px 5px rgba(0,0,0,0.5); white-space: nowrap; max-width: 100px; overflow: hidden; text-overflow: ellipsis; }

        .vault-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .vault-table th { text-align: left; padding: 12px; color: var(--subtext); border-bottom: 1px solid var(--border); font-weight: 600; text-transform: uppercase; font-size: 11px; }
        .vault-table td { padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); vertical-align: middle; }
        .vault-table tr:hover { background: rgba(255,255,255,0.03); }
        .list-img { width: 30px; height: 42px; border-radius: 4px; object-fit: cover; }
        .view-toggle { display: flex; background: rgba(0,0,0,0.3); border-radius: 6px; padding: 2px; border: 1px solid var(--border); }
        .view-btn { padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; color: var(--subtext); font-weight: 600; }
        .view-btn.active { background: var(--primary); color: white; }
        
        #hover-preview { position: fixed; pointer-events: none; z-index: 9999; width: 220px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); border: 2px solid var(--primary); display: none; transform: translateY(-50%); animation: fadeIn 0.1s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-40%); } to { opacity: 1; transform: translateY(-50%); } }
        .animate-in { animation: fadeUp 0.3s cubic-bezier(0.25, 0.8, 0.25, 1) forwards; }

        /* DECK GRID */
        .deck-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        .deck-card { background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 12px; height: 300px; display: flex; flex-direction: column; justify-content: flex-end; position: relative; overflow: hidden; cursor: pointer; transition: all 0.3s; background-size: cover; background-position: center; }
        .deck-card:hover { border-color: var(--primary); transform: translateY(-5px); box-shadow: var(--shadow); }
        .deck-card::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top, rgba(15, 10, 28, 1) 0%, rgba(15, 10, 28, 0.6) 40%, rgba(15, 10, 28, 0) 100%); z-index: 1; }
        .deck-card-content { position: relative; z-index: 2; padding: 20px; }
        .deck-card h4 { margin: 0; color: white; font-size: 18px; text-shadow: 0 2px 4px black; margin-bottom: 5px; }
        .deck-card-meta { color: var(--subtext); font-size: 12px; display: flex; justify-content: space-between; align-items: center; }
        .format-badge { background: var(--primary); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .new-deck-card { border: 1px dashed var(--subtext); display: flex; align-items: center; justify-content: center; flex-direction: column; color: var(--subtext); background: none; }
        .new-deck-card:hover { border-color: var(--primary); color: var(--primary); background: rgba(255,255,255,0.02); }
        .new-deck-card::after { display: none; }
        
        .deck-area-edit { display: block; } 
        .deck-area-detail { display: grid; grid-template-columns: 1fr 400px; gap: 20px; }
        .deck-list-viewer { height: 70vh; overflow-y: auto; white-space: pre-wrap; padding: 15px; font-size: 14px; line-height: 1.5; color: var(--text); background: rgba(0,0,0,0.1); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); }
        .editor-header { display: flex; gap: 10px; margin-bottom: 20px; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; border: 1px solid var(--border); align-items: center; }
        .editor-split { display: grid; grid-template-columns: 3fr 1fr; gap: 20px; height: 60vh; }
        .editor-column { display: flex; flex-direction: column; }
        .editor-label { color: var(--subtext); font-size: 12px; text-transform: uppercase; margin-bottom: 8px; font-weight: 600; display: flex; justify-content: space-between; }
        
        .visual-grid-container { height: 70vh; overflow-y: auto; padding-right: 5px; }
        .visual-section { margin-bottom: 20px; }
        .visual-header { font-size: 12px; text-transform: uppercase; color: var(--subtext); border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 10px; padding-bottom: 5px; font-weight: 700; }
        .visual-card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .visual-card { position: relative; border-radius: 6px; overflow: hidden; transition: transform 0.2s; cursor: pointer; aspect-ratio: 2.5/3.5; }
        .visual-card:hover { transform: scale(1.05); z-index: 10; border: 1px solid var(--primary); }
        .visual-card img { width: 100%; height: 100%; object-fit: cover; }
        .visual-badge { position: absolute; bottom: 0; right: 0; background: rgba(0,0,0,0.8); color: white; font-size: 10px; padding: 2px 6px; border-top-left-radius: 6px; font-weight: 700; }
        .cover-btn { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.8); color: rgba(255,255,255,0.7); border: none; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0.7; transition: opacity 0.2s; z-index: 20; font-size: 14px; }
        .cover-btn:hover { background: var(--yellow); color: black; opacity: 1; transform: scale(1.1); }
        .is-cover-card .cover-btn { opacity: 1; color: var(--yellow); background: black; }

        .deck-item-preview { background: rgba(255,255,255,0.05); padding:15px; border-radius:8px; border:1px solid var(--border); cursor:pointer; display:flex; justify-content:space-between; align-items:center; position: relative; }
        .deck-item-info { font-size: 12px; color: var(--subtext); font-weight: 400; margin-top: 5px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .deck-line { padding: 4px 8px; border-radius: 4px; margin-bottom: 2px; }
        .is-owned { color: var(--green); border-left: 2px solid var(--green); background: rgba(217, 70, 239, 0.05); }
        .is-partial { color: var(--yellow); border-left: 2px solid var(--yellow); background: rgba(250, 204, 21, 0.05); }
        .is-missing { color: var(--red); border-left: 2px solid var(--red); opacity: 0.8; }
        .progress-bg { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; margin-top: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); transition: width 0.5s ease-out; }

        /* BATTLEFIELD */
        .bf-hud { height: 60px; background: rgba(0,0,0,0.8); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 100; }
        .bf-stat { font-size: 14px; font-weight: 700; display: flex; gap: 10px; align-items: center; }
        .bf-main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; background: radial-gradient(circle at center, #2d153c 0%, #0f0a1c 70%); }
        .bf-field { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 10px; }
        .bf-hand-area { height: 220px; background: rgba(0,0,0,0.85); border-top: 1px solid var(--border); padding: 15px 20px; display: flex; gap: 20px; overflow-x: auto; align-items: center; }
        .bf-card { width: 120px; border-radius: 8px; cursor: pointer; transition: transform 0.1s, box-shadow 0.2s; position: relative; flex-shrink: 0; }
        .bf-card img { width: 100%; border-radius: 8px; }
        .bf-card:hover { transform: translateY(-10px); z-index: 10; box-shadow: 0 0 15px var(--primary); }
        .bf-tapped { transform: rotate(5deg) translateY(10px); opacity: 0.6; filter: grayscale(50%); }
        .bf-zone-btn { width: 100px; height: 140px; border: 1px dashed var(--subtext); border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--subtext); cursor: pointer; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; text-align: center; }
        .bf-zone-btn:hover { border-color: var(--primary); color: white; background: rgba(255,255,255,0.05); }
        .bf-row { flex: 1; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 10px; padding: 20px; border-bottom: 1px dashed rgba(255,255,255,0.1); overflow-y: auto; transition: background 0.2s; }
        .bf-row:last-child { border-bottom: none; background: rgba(0,0,0,0.2); }
        .bf-row-label { width: 100%; font-size: 10px; color: var(--subtext); text-transform: uppercase; margin-bottom: 5px; opacity: 0.5; pointer-events: none; }
        .tap-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 40px; color: white; text-shadow: 0 0 10px black; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .bf-tapped .tap-icon { opacity: 1; }
        .counter-badge { position: absolute; top: -5px; right: -5px; background: var(--red); color: white; border-radius: 50%; width: 24px; height: 24px; font-size: 11px; font-weight: 700; display: flex; align-items: center; justify-content: center; border: 2px solid #0f0a1c; z-index: 20; box-shadow: 0 2px 5px black; }
        .token-card { background: #1e1e1e; border: 2px dashed var(--subtext); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; text-align: center; font-size: 12px; }
        
        .drag-over { background: rgba(167, 139, 250, 0.2) !important; border: 2px dashed var(--primary) !important; transform: scale(1.02); }
        .bf-card[draggable="true"] { cursor: grab; }
        .bf-card[draggable="true"]:active { cursor: grabbing; }

        .mana-row { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.05); align-items: center; }
        .mana-pip { width:20px; height:20px; border-radius:50%; display:inline-block; margin-right:8px; vertical-align:middle; text-align: center; line-height: 20px; font-size: 12px; color:black; font-weight:700; }
        .pip-w { background:#f0f2c0; } .pip-u { background:#b3ceea; } .pip-b { background:#a69f9d; } .pip-r { background:#ea9f82; } .pip-g { background:#c4d3ca; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 10, 28, 0.95); z-index: 1000; display: flex; align-items: center; justify-content: center; overflow-y: auto; padding: 20px; backdrop-filter: blur(10px); }
        .modal-content { width: 90%; max-width: 800px; text-align: center; flex-shrink: 0; }
        
        /* V8.1 FAB */
        .fab-btn { position: fixed; bottom: 90px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background: var(--primary); color: white; border: none; box-shadow: 0 4px 15px rgba(167, 139, 250, 0.6); font-size: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100; transition: transform 0.2s, box-shadow 0.2s; }
        .fab-btn:active { transform: scale(0.90); }
        @media (min-width: 769px) { .fab-btn { display: none; } }
    </style>
</head>
<body>

    <img id="hover-preview"> 

    <div id="toast-container" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px;"></div>

    <div id="report-modal" class="modal-overlay hidden" onclick="if(event.target===this) this.classList.add('hidden')">
        <div class="modal-content card-box" style="max-width: 400px;">
            <h2 class="text-red">ü™≤ Submit Bug Report</h2>
            <p class="text-sub">Tell us what broke.</p>
            <textarea id="bug-description" placeholder="Steps to reproduce..." style="height: 200px; margin-bottom: 20px;"></textarea>
            <div class="flex-row" style="justify-content: center;">
                <button onclick="reportBug(this)" style="background:var(--red);">üêõ Send</button>
                <button onclick="document.getElementById('report-modal').classList.add('hidden')" class="secondary">Cancel</button>
            </div>
        </div>
    </div>

    <div id="land-modal" class="modal-overlay hidden" onclick="if(event.target===this) this.classList.add('hidden')">
        <div class="modal-content card-box" style="max-width: 400px;">
            <h2 style="color:var(--primary);">The Geomancer</h2>
            <p class="text-sub">Recommended basic lands.</p>
            <div style="margin-bottom:20px; text-align:left;">
                <label class="text-sub">Target Land Count</label>
                <input type="number" id="target-land-count" value="24" onchange="recalcLands()" class="mt-5">
            </div>
            <div id="land-results" class="mb-20"></div>
            <div class="flex-row" style="justify-content: center;">
                <button onclick="applyLands(this)" style="background:var(--green);">üíæ Add to Deck</button>
                <button onclick="document.getElementById('land-modal').classList.add('hidden')" class="secondary">Cancel</button>
            </div>
        </div>
    </div>

    <div id="avatar-modal" class="modal-overlay hidden" onclick="if(event.target===this) this.classList.add('hidden')">
        <div class="modal-content card-box">
            <h2 style="color:var(--primary);">Choose Your Avatar</h2>
            <div id="avatar-grid" class="avatar-grid"></div>
            <button onclick="document.getElementById('avatar-modal').classList.add('hidden')" class="secondary mt-20 btn-md">Cancel</button>
        </div>
    </div>

    <div id="user-options-modal" class="modal-overlay hidden" onclick="closeUserOptionsModal()">
        <div class="modal-content card-box" style="max-width: 300px; text-align: left;" onclick="event.stopPropagation()">
            <h2 class="mb-15" style="color:var(--primary);">Account Actions</h2>
            <button class="secondary w-full mb-10" onclick="nav('settings', 'settings'); closeUserOptionsModal()">‚öôÔ∏è Settings</button>
            <button class="w-full mb-10" onclick="openAvatarModal(); closeUserOptionsModal()" style="background: rgba(255, 255, 255, 0.1);">üñºÔ∏è Change Avatar</button>
            <button onclick="handleLogout(this)" class="w-full" style="background:var(--red);">üö™ Log Out</button>
        </div>
    </div>

    <div id="bulk-modal" class="modal-overlay hidden" onclick="if(event.target===this) closeBulkModal()">
        <div class="modal-content card-box">
            <h2 style="color:var(--primary);">The Scribe (Bulk)</h2>
            <p class="text-sub mb-20">Format: <code>Quantity Name</code></p>
            <div class="mb-15" style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px; border:1px dashed var(--border);">
                <div class="flex-between">
                    <span class="text-sub">Import CSV</span>
                    <input type="file" id="csvFile" accept=".csv" style="display:none;" onchange="handleCSVUpload(this)">
                    <button class="secondary btn-sm" onclick="document.getElementById('csvFile').click()">üìÇ Select File</button>
                </div>
                <div id="csv-status" class="mt-5 text-bold" style="font-size:11px; color:var(--primary); text-align:right;"></div>
            </div>
            <textarea id="bulkList" placeholder="4 Sol Ring&#10;10 Mountain" style="height: 300px;"></textarea>
            <div class="flex-row" style="justify-content: center; margin-top: 20px;">
                <button onclick="processBulkImport(this)" style="background: var(--green);">üìú Inscribe</button>
                <button onclick="closeBulkModal()" class="secondary">Cancel</button>
            </div>
            <div id="bulk-status" class="mt-15 text-sub"></div>
        </div>
    </div>

    <div id="delete-modal" class="modal-overlay hidden" onclick="if(event.target===this) closeDeleteModal()">
        <div class="modal-content card-box" style="max-width: 400px; border-color: var(--red);">
            <h2 class="text-red">Sacrifice Deck?</h2>
            <p class="text-sub mb-20">Destroy <b id="delete-target-name" class="text-white">this deck</b>?</p>
            <div class="flex-row" style="justify-content: center;">
                <button onclick="confirmDelete(this)" style="background:var(--red);">üî• Destroy</button>
                <button onclick="closeDeleteModal()" class="secondary">Cancel</button>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal-overlay hidden" onclick="if(event.target===this) this.classList.add('hidden')">
        <div class="modal-content card-box" style="max-width: 400px;">
            <h2 id="edit-card-name" style="color:var(--primary);">Edit Card</h2>
            <input type="hidden" id="edit-card-id">
            <div style="text-align:left; margin-bottom:10px;"><label class="text-sub">Quantity</label><input type="number" id="edit-qty" class="mt-5"></div>
            <div style="text-align:left; margin-bottom:20px;"><label class="text-sub">Cost ($)</label><input type="number" id="edit-cost" step="0.01" class="mt-5"></div>
            <div style="text-align:left; margin-bottom:20px;"><label class="text-sub">Tags</label><input type="text" id="edit-tags" class="mt-5"></div>
            <div class="flex-row" style="justify-content: center;">
                <button onclick="saveEdit(this)" style="background: var(--green);">üíæ Save</button>
                <button onclick="document.getElementById('edit-modal').classList.add('hidden')" class="secondary">Cancel</button>
            </div>
        </div>
    </div>

    <div id="codex-modal" class="modal-overlay hidden" onclick="if(event.target===this) this.classList.add('hidden')">
        <div class="modal-content card-box" style="max-width: 800px;">
            <div id="codex-loading" style="padding: 40px;" class="text-sub">Consulting archives...</div>
            <div id="codex-content" class="codex-layout hidden">
                <div><img id="codex-img" class="codex-img" src=""></div>
                <div class="codex-info">
                    <div id="codex-title" class="codex-title"></div>
                    <div id="codex-type" class="codex-type"></div>
                    <div id="codex-text" class="codex-text"></div>
                    <h4 class="text-sub mt-15" style="font-size:12px; text-transform:uppercase;">Legality</h4>
                    <div id="codex-legality" class="legality-grid"></div>
                    <div class="mt-20 flex-row">
                        <button class="secondary" onclick="document.getElementById('codex-modal').classList.add('hidden')">Close</button>
                        <button onclick="window.open(window.scryfallLink, '_blank')" style="background:#2b253a;">Scryfall ‚Üó</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="auth-screen">
        <div class="auth-box">
            <div style="font-size:50px; margin-bottom:15px; text-shadow: 0 0 15px var(--primary);">ü©∏</div>
            <h2 style="margin:0 0 10px 0; color:white;">The Grimoire</h2>
            <p class="text-sub mb-20" style="font-size:14px;">Unleash your collection.</p>
            <div class="input-group"><input type="email" id="email" placeholder="Email" style="padding-left: 14px;"></div>
            <div class="input-group"><input type="password" id="password" placeholder="Password" style="padding-left: 14px;"></div>
            <button onclick="handleAuthAction(this)" id="auth-btn">Enter</button>
            <div class="flex-between mt-15" style="font-size:12px;">
                <span id="auth-msg" class="text-sub">First time? We'll create an account.</span>
                <span id="forgot-link" style="color:var(--primary); cursor:pointer;" onclick="toggleResetMode()">Forgot?</span>
            </div>
        </div>
    </div>

    <div id="app" class="app-container hidden">
        <div class="sidebar">
            <div class="logo"><span>ü©∏</span> The Grimoire</div>
            <div class="user-profile-section">
                <img id="sidebar-avatar" class="avatar-circle" src="https://svgshare.com/i/10gq.svg">
                <div class="user-meta">
                    <div id="sidebar-username" class="user-name">Wizard</div>
                    <div id="user-email" class="user-email-txt">Loading...</div>
                </div>
            </div>
            <div class="nav-item active" onclick="nav('dashboard', 'dashboard')">üè† Dashboard</div>
            <div class="nav-item" onclick="nav('add', 'add')">‚ûï Add Card</div>
            <div class="nav-item" onclick="nav('collection', 'collection')">üìö Collection</div>
            <div class="nav-item" onclick="nav('oracle', 'oracle')">üëÅÔ∏è Wishlist</div>
            <div class="nav-item" onclick="nav('decks', 'decks')">üìã Decklists</div>
            <div class="nav-item" onclick="nav('settings', 'settings')">‚öôÔ∏è Settings</div>
            <div style="flex-grow:1;"></div>
            <button class="secondary mb-10" style="color:var(--red); border:1px solid var(--red); background:rgba(220,38,38,0.1);" onclick="document.getElementById('report-modal').classList.remove('hidden')">ü™≤ Report Bug</button>
            <div style="padding:15px 0; border-top:1px solid var(--border); margin-top:10px;">
                <div class="text-sub mb-5" style="font-size:10px;">v9.4</div>
                <button class="secondary" onclick="openUserOptionsModal()">üßô Profile</button>
            </div>
        </div>

        <div class="main">
            <div id="view-dashboard">
                <div class="flex-between mb-20"><h2 style="margin:0;">Dashboard</h2><button class="secondary btn-md" onclick="exportCSV()">üìâ Export CSV</button></div>
                <div class="stat-grid">
                    <div class="stat-card"><div class="stat-val skeleton" id="stat-count"></div><div class="stat-lbl">Cards</div></div>
                    <div class="stat-card"><div class="stat-val skeleton" id="stat-value"></div><div class="stat-lbl">Value</div></div>
                    <div class="stat-card"><div class="stat-val skeleton" id="stat-cost"></div><div class="stat-lbl">Cost</div></div>
                    <div class="stat-card"><div class="stat-val skeleton" id="stat-oracle"></div><div class="stat-lbl">Wishlist</div></div>
                    <div class="stat-card"><div class="stat-val skeleton" id="stat-gain"></div><div class="stat-lbl">Gain</div></div>
                </div>
                <div class="dashboard-split">
                    <div class="card-box"><h3>üèÜ Top Assets</h3><div id="top-assets-list"></div></div>
                    <div class="card-box"><h3>Recent</h3><div class="collection-grid" id="recent-grid"></div></div>
                </div>
            </div>

            <div id="view-settings" class="hidden">
                <div class="card-box" style="max-width: 500px; margin: 0 auto;">
                    <h2>üßô‚Äç‚ôÇÔ∏è Identity</h2>
                    <div style="text-align:center; margin-bottom:20px;">
                        <img id="settings-avatar" class="avatar-circle" style="width:100px; height:100px; margin-bottom:15px;" src="https://svgshare.com/i/10gq.svg"><br>
                        <button onclick="openAvatarModal()" class="secondary btn-sm">Change Avatar</button>
                    </div>
                    <div class="input-group"><span class="input-icon">üë§</span><input type="text" id="settings-username" placeholder="Display Name"></div>
                    <button onclick="saveProfile(this)" class="mb-20" style="background:var(--green);">üíæ Save</button>
                    <h3 class="mt-20" style="border-top:1px solid var(--border); padding-top:20px;">üé® Theme</h3>
                    <div class="theme-grid">
                        <div class="theme-btn" style="background:#a78bfa;" onclick="applyTheme('purple')"></div> 
                        <div class="theme-btn" style="background:#fcd34d;" onclick="applyTheme('white')"></div> 
                        <div class="theme-btn" style="background:#60a5fa;" onclick="applyTheme('blue')"></div> 
                        <div class="theme-btn" style="background:#18181b; border-color:#52525b;" onclick="applyTheme('black')"></div> 
                        <div class="theme-btn" style="background:#f87171;" onclick="applyTheme('red')"></div> 
                        <div class="theme-btn" style="background:#34d399;" onclick="applyTheme('green')"></div> 
                    </div>
                    <h3 class="mt-20">üí∞ Price Source</h3>
                    <select id="settingsPriceSource" class="mb-20"><option value="usd">USD</option><option value="eur">EUR</option><option value="tix">TIX</option></select>
                    <button onclick="savePrefs(this)" class="mb-20" style="background:var(--green);">üíæ Save Prefs</button>
                </div>
            </div>

            <div id="view-add" class="hidden">
                <div class="card-box" style="max-width:500px; margin:0 auto;">
                    <div class="flex-between mb-20"><h2 style="margin:0;">Add Card</h2><button class="secondary btn-sm" onclick="openBulkModal()">üìú Bulk</button></div>
                    <div class="input-group"><span class="input-icon">üîç</span><input type="text" id="search" placeholder="Name or SET 123" oninput="debounceSearch()"></div>
                    <div class="mb-15 text-bold" style="font-size:12px; color:var(--primary); min-height:15px;" id="search-status"></div>
                    <select id="versionSelect" onchange="updateSelectedVersion()" class="mb-15" style="padding-left:14px;"></select>
                    <div class="flex-row mb-15">
                        <input id="set" placeholder="SET" readonly style="opacity:0.6; width:30%; padding-left:14px;">
                        <input id="num" placeholder="#" readonly style="opacity:0.6; width:30%; padding-left:14px;">
                        <input type="number" id="qty" placeholder="Qty" value="1" style="width:40%; padding-left:14px;">
                    </div>
                    <div class="input-group quantity-group"><span class="input-icon">üí∞</span><input type="number" id="cost" placeholder="Cost ($)" step="0.01" style="padding-left:40px;"></div>
                    <div class="input-group quantity-group"><span class="input-icon">üè∑Ô∏è</span><input type="text" id="add-tags" placeholder="Tags..." style="padding-left:40px;"></div>
                    <div id="quick-tags-area" class="flex-row mb-15" style="flex-wrap:wrap;"></div>
                    <div class="flex-between mb-15 text-sub">
                        <select id="priceSource" onchange="updateSelectedVersion(); savePrefs();" style="width:auto; padding:4px; font-size:11px;"><option value="usd">USD</option><option value="eur">EUR</option></select>
                        <span id="marketPrice" class="text-green text-bold">--</span>
                    </div>
                    <div style="text-align:center; min-height:200px; background:rgba(0,0,0,0.2); border-radius:10px; margin-bottom:20px;"><img id="preview" style="max-width:90%; border-radius:8px; display:none; margin:10px 0;"></div>
                    <div class="flex-row">
                        <button onclick="addCard(this, false)" style="flex:2;">Bind</button>
                        <button onclick="addCard(this, true)" class="secondary" style="flex:1;">Wishlist</button>
                    </div>
                </div>
            </div>
            
            <div id="view-collection" class="hidden">
                <div class="flex-between mb-20">
                    <h2>Collection</h2>
                    <div class="flex-row"><button id="btn-appraise" class="secondary btn-md" style="background:var(--green); color:white;" onclick="appraiseCollection(this)">üîÑ Appraise</button><button class="secondary btn-md" onclick="loadCollection()">Refresh</button></div>
                </div>
                <div id="appraisal-status" class="hidden mb-15 text-sub"></div>
                <div class="mb-20">
                    <div class="input-group mb-10"><span class="input-icon">üîç</span><input id="vaultSearch" placeholder="Search..." oninput="filterVault()" style="padding-left:40px;"></div>
                    <div class="flex-row" style="flex-wrap:wrap;">
                        <select id="filterColor" onchange="filterVault()" style="flex:1; padding:10px;"><option value="all">Color</option><option value="W">White</option><option value="U">Blue</option><option value="B">Black</option><option value="R">Red</option><option value="G">Green</option><option value="M">Multi</option></select>
                        <select id="filterRarity" onchange="filterVault()" style="flex:1; padding:10px;"><option value="all">Rarity</option><option value="mythic">Mythic</option><option value="rare">Rare</option></select>
                        <select id="vaultSort" onchange="filterVault()" style="flex:1; padding:10px;"><option value="date-new">Newest</option><option value="price-high">Value</option></select>
                        <div class="view-toggle"><div id="view-grid-btn" class="view-btn active" onclick="toggleVaultView('grid')">Grid</div><div id="view-list-btn" class="view-btn" onclick="toggleVaultView('list')">List</div></div>
                    </div>
                </div>
                <div id="collection-grid" class="collection-grid"></div>
            </div>

            <div id="view-oracle" class="hidden">
                <div class="flex-between mb-20"><h2 style="color:var(--blue);">Wishlist</h2><button class="secondary btn-md" onclick="loadOracle()">Refresh</button></div>
                <div class="collection-grid" id="oracle-grid"></div>
            </div>

            <div id="view-decks" class="hidden">
                <div id="deck-library">
                    <div class="flex-between mb-20"><h2 style="margin:0;">Library</h2><div class="input-group" style="width:200px;"><span class="input-icon">üîç</span><input id="deckSearch" oninput="filterDecks()" style="padding-left:40px;"></div></div>
                    <div id="deck-grid-container" class="deck-grid"></div>
                </div>
                <div id="deck-workspace" class="hidden">
                    <button onclick="closeDeck()" class="secondary btn-sm mb-15">‚Üê Library</button>
                    <div id="editor-mode" class="hidden">
                        <div class="card-box">
                            <div class="editor-header">
                                <input id="deckName" placeholder="Deck Name" style="flex-grow:2;">
                                <input id="deckCommander" placeholder="Commander" style="flex-grow:2;">
                                <select id="deckFormat"><option value="Casual">Casual</option><option value="Commander">Commander</option></select>
                                <button class="secondary clear-btn" onclick="clearDeckEditor()">üóëÔ∏è</button>
                            </div>
                            <div class="card-box" style="padding:10px; margin-bottom:20px; background:rgba(0,0,0,0.2);">
                                <div class="flex-between mb-10"><span class="text-sub text-bold">Live Curve</span><span id="editor-card-count" style="font-size:12px;">0</span></div>
                                <div style="height:100px;"><canvas id="editorManaChart"></canvas></div>
                            </div>
                            <div class="editor-split">
                                <div class="editor-column"><div class="editor-label">Main</div><textarea id="deckMain" placeholder="1 Sol Ring..."></textarea></div>
                                <div class="editor-column"><div class="editor-label">Side</div><textarea id="deckSide"></textarea></div>
                            </div>
                            <div class="flex-row mt-15"><button id="validateDeckBtn" onclick="validateDeck(this)">‚úÖ Validate</button><button onclick="saveDeck(this)" style="background:var(--green);">üíæ Save</button></div>
                        </div>
                    </div>
                    <div id="detail-mode" class="deck-area-detail hidden">
                        <div class="card-box">
                            <div class="flex-between mb-15">
                                <div style="flex-grow:1; display:flex; gap:20px;">
                                    <img id="detail-commander-img" style="width:70px; height:98px; border-radius:6px; display:none;">
                                    <div>
                                        <h3 id="detail-deck-name" style="margin:0; color:var(--primary);"></h3>
                                        <div id="detail-commander" class="text-white mb-10" style="font-size:14px;"></div>
                                        <div style="background:rgba(0,0,0,0.3); padding:10px; border-radius:6px;">
                                            <div class="flex-between mb-5 text-sub" style="font-size:11px;"><span>Owned: <b id="detail-owned-percent" class="text-white">0%</b></span><span>Missing: <b id="detail-missing-cost" class="text-red">$0</b></span></div>
                                            <div class="progress-bg"><div id="detail-owned-bar" class="progress-fill" style="width:0%"></div></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex-row">
                                    <button class="btn-md" style="background:var(--primary);" onclick="initBattlefield()">‚öîÔ∏è Play</button>
                                    <button class="btn-md" style="background:var(--green);" onclick="saveDeck(this)">üíæ Save</button>
                                    <select id="tools-dropdown" onchange="handleDeckTool(this.value)" style="width:40px;">
                                        <option value="">‚öôÔ∏è</option><option value="edit">Edit</option><option value="view_toggle">Toggle View</option><option value="copy_missing">Copy Missing</option><option value="buy">Buy Missing</option><option value="print">Proxies</option>
                                    </select>
                                </div>
                            </div>
                            <div id="detail-visual-grid" class="hidden visual-grid-container"></div>
                            <div class="deck-list-viewer" id="detail-decklist-viewer"></div>
                        </div>
                        <div class="card-box">
                            <h3>Analysis</h3>
                            <div class="flex-between mb-15" style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px;"><span class="text-sub text-bold">Value</span><span id="detail-deck-price" class="text-green text-bold" style="font-size:18px;">$0</span></div>
                            <button onclick="openLandCalculator()" class="secondary w-full mb-15" style="border:1px dashed var(--primary); color:var(--primary);">üèîÔ∏è Geomancer</button>
                            <div id="deck-advisor" class="mt-20 pt-15" style="border-top:1px solid var(--border);"><h4 style="color:var(--primary);">The Advisor</h4><div id="advisor-grid"></div></div>
                            <div id="detail-analysis-results" class="text-sub mt-15"></div>
                            <div id="deck-charts" class="hidden"><canvas id="colorChart"></canvas><canvas id="typeChart"></canvas><canvas id="manaCurve"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-battlefield" class="hidden">
                <div class="bf-hud">
                    <button class="secondary" style="width:auto;" onclick="exitBattlefield()">‚Üê Exit</button>
                    <div class="bf-stat"><span class="text-sub">Life:</span> <span id="bf-life" class="text-white" style="font-size:20px;">20</span> <button onclick="updateLife(1)">+</button><button onclick="updateLife(-1)">-</button></div>
                    <div class="bf-stat"><span class="text-sub">Turn:</span> <span id="bf-turn">1</span> <button onclick="nextTurn()">Next</button></div>
                    <div class="bf-stat"><button style="background:var(--blue);" onclick="createToken()">Token</button> <button style="background:var(--red);" onclick="initBattlefield()">Reset</button></div>
                </div>
                <div class="bf-main">
                    <div id="bf-frontline" class="bf-row" ondrop="drop(event, 'field')" ondragover="allowDrop(event)"><div class="bf-row-label">Front</div></div>
                    <div id="bf-backline" class="bf-row" ondrop="drop(event, 'field')" ondragover="allowDrop(event)"><div class="bf-row-label">Back</div></div>
                </div>
                <div class="bf-hand-area">
                    <div class="bf-zone-btn" onclick="drawCard()" ondrop="drop(event, 'library')" ondragover="allowDrop(event)">Lib <div id="bf-lib-count">0</div></div>
                    <div class="bf-zone-btn" style="border-color:var(--red);" ondrop="drop(event, 'grave')" ondragover="allowDrop(event)">Grave <div id="bf-grave-count">0</div></div>
                    <div class="bf-zone-btn" style="border-color:var(--blue);" ondrop="drop(event, 'exile')" ondragover="allowDrop(event)">Exile <div id="bf-exile-count">0</div></div>
                    <div id="bf-hand" style="display:flex; gap:10px; overflow-x:auto; flex:1;" ondrop="drop(event, 'hand')" ondragover="allowDrop(event)"></div>
                </div>
            </div>
        </div>
        <div class="bottom-nav">
            <div class="b-item active" onclick="nav('dashboard', 'dashboard')">üè†</div>
            <div class="b-item" onclick="nav('add', 'add')">‚ûï</div>
            <div class="b-item" onclick="nav('collection', 'collection')">üìö</div>
            <div class="b-item" onclick="nav('decks', 'decks')">üìã</div>
        </div>
        <button class="fab-btn" onclick="nav('add', 'add')">+</button>
    </div>

    <script>
        // --- CONFIG ---
        const SUPABASE_URL="https://mdirqlntcxqkthbwubmj.supabase.co";
        const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1kaXJxbG50Y3hxa3RoYnd1Ym1qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2OTUyOTAsImV4cCI6MjA4MTI3MTI5MH0.XBhYZiwINycA-QjAH-cL4vFzzyppm1c4M322jNDmbvE";
        let sb; try { sb = supabase.createClient(SUPABASE_URL,SUPABASE_KEY); } catch(e){ alert("Database Error"); }
        
        const EMAILJS_SERVICE_ID='service_n9utr47', EMAILJS_TEMPLATE_ID='template_xtth5gu', EMAILJS_PUBLIC_KEY='ohGLAW9gp3OUPH0uf';

        // --- GLOBAL STATE ---
        let vaultLookup = {}, typeChartInstance, manaCurveInstance, colorChartInstance, editorChartInstance;
        let session, tempCardData, allVersions=[], searchTimer, cardsCache=[];
        let currentViewedDeckId, currentDeckCache=[], currentDeckCoverUrl='', currentDeckStructuredList;
        let vaultViewMode = localStorage.getItem('grimoire_view') || 'grid';
        const CHART_COLORS=['#a78bfa','#dc2626','#a78bfa','#4f46e5','#059669','#737373','#facc15'];
        let suggestedLands=[], gameState={lib:[],hand:[],field:[],grave:[],exile:[],life:20,turn:1};
        let customTags = JSON.parse(localStorage.getItem('grimoire_custom_tags')) || ['Foil', 'Trade', 'Damaged'];

        // --- HELPERS ---
        function setLoading(btn, isLoading) { if(!btn) return; if(isLoading){ btn.classList.add('btn-loading'); btn.dataset.originalText=btn.innerText; } else { btn.classList.remove('btn-loading'); } }
        function showToast(m,t='info'){ let c=document.getElementById('toast-container'); if(!c){c=document.createElement('div');c.id='toast-container';document.body.appendChild(c)} const el=document.createElement('div'); el.className=`toast ${t}`; el.innerHTML=`<span>${m}</span>`; c.appendChild(el); setTimeout(()=>{el.remove()},3000); }
        function getCardImage(c) { 
            if(!c) return ''; const set=c.set_code||c.set; const num=c.collector_number||c.num;
            if(!set||!num) return c.image_url||(c.image_uris?c.image_uris.normal:null)||(c.card_faces?c.card_faces[0].image_uris.normal:'')||'';
            return c.image_url||`https://cards.scryfall.io/normal/front/${set[0]}/${set[1]}/${set}/${num}.jpg`; // Fallback approximate
        }
        function openUserOptionsModal() { document.getElementById('user-options-modal').classList.remove('hidden'); }
        function closeUserOptionsModal() { document.getElementById('user-options-modal').classList.add('hidden'); }

        // --- CHART FUNCTIONS (Moved up for safety) ---
        function clearCharts() { 
            [typeChartInstance, manaCurveInstance, colorChartInstance].forEach(c => { if(c) c.destroy(); });
            document.getElementById('deck-charts').classList.add('hidden'); 
        }
        function renderTypeChart(d) { 
            const ctx=document.getElementById('typeChart').getContext('2d'); if(typeChartInstance) typeChartInstance.destroy();
            typeChartInstance = new Chart(ctx, { type:'doughnut', data:{labels:Object.keys(d),datasets:[{data:Object.values(d),backgroundColor:CHART_COLORS,borderWidth:0}]}, options:{plugins:{legend:{position:'right',labels:{color:'#a1a1aa'}}}} });
        }
        function renderManaCurve(d) {
            const ctx=document.getElementById('manaCurve').getContext('2d'); if(manaCurveInstance) manaCurveInstance.destroy();
            const l=['0','1','2','3','4','5','6','7+']; const v=l.map((_,i)=>d[i]||0);
            manaCurveInstance = new Chart(ctx, { type:'bar', data:{labels:l,datasets:[{data:v,backgroundColor:'#a78bfa'}]}, options:{plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#a1a1aa'}},y:{ticks:{color:'#a1a1aa'}}}} });
        }
        function renderColorChart(c) {
            const ctx=document.getElementById('colorChart').getContext('2d'); if(colorChartInstance) colorChartInstance.destroy();
            const l=['White','Blue','Black','Red','Green','Colorless']; const d=[c.W,c.U,c.B,c.R,c.G,c.C];
            colorChartInstance = new Chart(ctx, { type:'polarArea', data:{labels:l,datasets:[{data:d,backgroundColor:['#f0f2c0','#b3ceea','#a69f9d','#ea9f82','#c4d3ca','#d8d8d8']}]}, options:{scales:{r:{grid:{color:'#333'},ticks:{display:false}}}} });
        }
        function renderEditorChart(d) {
            const ctx=document.getElementById('editorManaChart').getContext('2d'); if(editorChartInstance) editorChartInstance.destroy();
            editorChartInstance = new Chart(ctx, { type:'bar', data:{labels:['0','1','2','3','4','5','6','7+'],datasets:[{data:Object.values(d),backgroundColor:'#3b82f6',borderRadius:2}]}, options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#a1a1aa'}},y:{display:false}}} });
        }

        // --- CORE LOGIC ---
        function nav(v,i){ 
            document.querySelectorAll('.main > div').forEach(d=>d.classList.add('hidden')); 
            const view = document.getElementById('view-'+v); if(view) view.classList.remove('hidden');
            if(v==='decks') loadDecks(); else { document.getElementById('deck-workspace').classList.add('hidden'); document.getElementById('deck-library').classList.remove('hidden'); showRitualEditor(false); }
            if(v==='collection') loadCollection(); if(v==='oracle') loadOracle(); if(v==='add') renderQuickTags();
        }

        async function loadData() {
            try {
                const { data, error } = await sb.from('cards').select('*').order('created_at', { ascending: false });
                if(error) throw error;
                cardsCache = data; vaultLookup = {};
                let count=0, val=0, cost=0;
                cardsCache.forEach(c => {
                    const key = `${c.name.toLowerCase()}_${c.set_code}_${c.collector_number}`;
                    vaultLookup[key] = (vaultLookup[key]||0) + c.quantity;
                    if(c.quantity>0) { count+=c.quantity; val+=(c.market_price_usd||0)*c.quantity; cost+=(c.buy_price||0)*c.quantity; }
                });
                document.getElementById('stat-count').innerText = count;
                document.getElementById('stat-value').innerText = "$"+val.toFixed(2);
                document.getElementById('stat-cost').innerText = "$"+cost.toFixed(2);
                document.querySelectorAll('.stat-val').forEach(el => el.classList.remove('skeleton'));
                
                // Recent
                const recent = cardsCache.filter(c=>c.quantity>0).slice(0,5);
                document.getElementById('recent-grid').innerHTML = recent.map(c => `<div class="grid-card animate-in" onclick="openCodex('${c.set_code}','${c.collector_number}')"><img src="${getCardImage(c)}" loading="lazy"><div class="overlay"><span>${c.name}</span></div></div>`).join('');
                
                // Top Assets
                const top = [...cardsCache].filter(c=>c.quantity>0).sort((a,b)=>b.market_price_usd-a.market_price_usd).slice(0,5);
                document.getElementById('top-assets-list').innerHTML = top.map(c => `<div class="asset-row"><div class="asset-info"><img src="${getCardImage(c)}" class="asset-img"><div><div class="text-bold">${c.name}</div><div class="text-sub">${c.set_code} #${c.collector_number}</div></div></div><div class="asset-val">$${c.market_price_usd}</div></div>`).join('');
            } catch(e) { console.error(e); showToast("Load Error","error"); }
        }

        // --- SEARCH FIX (V9.3.1) ---
        function debounceSearch(){ clearTimeout(searchTimer); searchTimer=setTimeout(fetchCardMeta,500); }
        async function fetchCardMeta(){ 
            const n = document.getElementById('search').value.trim(); if(n.length < 3) return;
            document.getElementById('search-status').innerText = "Searching...";
            let url = `https://api.scryfall.com/cards/search?q=${encodeURIComponent(n)}&unique=prints`;
            const match = n.match(/^([a-z]{3,4})\s*(\d+)$/i);
            if(match) url = `https://api.scryfall.com/cards/${match[1].toLowerCase()}/${match[2]}`;

            try {
                const res = await fetch(url); const d = await res.json();
                if(d.object==='error') { document.getElementById('search-status').innerText = "Not found."; allVersions=[]; return; }
                allVersions = d.object==='list' ? d.data : [d];
                document.getElementById('search-status').innerText = `${allVersions.length} versions.`;
                const s = document.getElementById('versionSelect'); s.innerHTML='';
                allVersions.forEach((v,i) => { const o=document.createElement('option'); o.value=i; o.text=`${v.set_name} ($${v.prices.usd||'0'})`; s.appendChild(o); });
                updateSelectedVersion();
            } catch(e) { document.getElementById('search-status').innerText = "Error."; }
        }

        function updateSelectedVersion(){
            const v = allVersions[document.getElementById('versionSelect').value]; if(!v) return;
            document.getElementById('set').value = v.set.toUpperCase();
            document.getElementById('num').value = v.collector_number;
            document.getElementById('marketPrice').innerText = `$${v.prices.usd||'0.00'}`;
            document.getElementById('preview').src = getCardImage(v); document.getElementById('preview').style.display='block';
            tempCardData = { name:v.name, set:v.set.toUpperCase(), num:v.collector_number, img:getCardImage(v), market_price: parseFloat(v.prices.usd||0), type_line:v.type_line, rarity:v.rarity, colors:v.colors||[], cmc:v.cmc||0 };
        }

        // --- BUTTON FIX (The Guard) ---
        async function addCard(btn, isWishlist) {
            if(!tempCardData) return showToast("Select a card first", "error");
            setLoading(btn, true);
            try {
                const qty = isWishlist ? 0 : (parseInt(document.getElementById('qty').value)||1);
                const cost = parseFloat(document.getElementById('cost').value)||null;
                const tags = document.getElementById('add-tags').value.split(',').filter(t=>t.trim());
                await sb.from('cards').insert({ user_id:session.user.id, name:tempCardData.name, set_code:tempCardData.set, collector_number:tempCardData.num, image_url:tempCardData.img, buy_price:cost, quantity:qty, market_price_usd:tempCardData.market_price, tags:tags, type_line:tempCardData.type_line, rarity:tempCardData.rarity, colors:tempCardData.colors, cmc:tempCardData.cmc });
                showToast("Saved!", "success"); loadData();
            } catch(e){ showToast("Error", "error"); } finally { setLoading(btn, false); }
        }

        // --- DECKS ---
        function showRitualEditor(keep) { 
            document.getElementById('deck-library').classList.add('hidden'); 
            document.getElementById('deck-workspace').classList.remove('hidden'); 
            document.getElementById('detail-mode').classList.add('hidden'); 
            document.getElementById('editor-mode').classList.remove('hidden');
            if(!keep) { document.getElementById('deckName').value=''; document.getElementById('deckMain').value=''; }
            initEditorListeners();
        }
        function initEditorListeners() { document.getElementById('deckMain').addEventListener('input', () => setTimeout(updateLiveEditorStats, 500)); }
        function updateLiveEditorStats() {
            const txt = document.getElementById('deckMain').value; const lines = txt.split('\n');
            const data = {0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0}; let total=0;
            lines.forEach(l => {
                const m = l.match(/^(\d+)\s+(.+)/);
                if(m) {
                    const q=parseInt(m[1]), n=m[2].trim().toLowerCase(); total+=q;
                    const c = cardsCache.find(x=>x.name.toLowerCase()===n);
                    if(c && c.cmc !== undefined) { let b=Math.floor(c.cmc); if(b>7)b=7; data[b]+=q; }
                }
            });
            document.getElementById('editor-card-count').innerText = total; renderEditorChart(data);
        }

        async function validateDeck(btn) {
            const main = document.getElementById('deckMain').value;
            if(!main.trim()) return showToast("Empty deck", "error");
            
            setLoading(btn, true);
            
            // Check cache
            if(window.currentDeckStructuredList && window.currentDeckStructuredList.length > 0) {
                processDeckData(window.currentDeckStructuredList); setLoading(btn, false); return;
            }

            // API Resolve
            const lines = main.split('\n').filter(l=>l.trim());
            const idents = lines.map(l=>{ const m=l.match(/^(\d+)\s+(.+)/); return m ? {name:m[2]} : null }).filter(x=>x);
            
            try {
                const res = await fetch('https://api.scryfall.com/cards/collection', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({identifiers:idents})});
                const d = await res.json();
                processDeckData(d.data || []);
            } catch(e) { showToast("Validation Error"); } finally { setLoading(btn, false); }
        }

        function processDeckData(data) {
            document.getElementById('editor-mode').classList.add('hidden');
            document.getElementById('detail-mode').classList.remove('hidden');
            document.getElementById('detail-deck-name').innerText = document.getElementById('deckName').value || "New Deck";
            
            let totalVal=0, types={}, cmcs={}, colors={W:0,U:0,B:0,R:0,G:0,C:0};
            let cache = [];
            
            data.forEach(c => {
                const price = parseFloat(c.prices.usd||0); totalVal += price;
                const type = c.type_line.split('‚Äî')[0].trim();
                types[type] = (types[type]||0)+1;
                if(!type.includes('Land')) { let b=Math.floor(c.cmc||0); if(b>7)b=7; cmcs[b]=(cmcs[b]||0)+1; }
                if(c.mana_cost) {
                    colors.W += (c.mana_cost.match(/{W}/g)||[]).length;
                    colors.U += (c.mana_cost.match(/{U}/g)||[]).length;
                    colors.B += (c.mana_cost.match(/{B}/g)||[]).length;
                    colors.R += (c.mana_cost.match(/{R}/g)||[]).length;
                    colors.G += (c.mana_cost.match(/{G}/g)||[]).length;
                }
                cache.push({ ...c, quantity:1 }); // Simplified for logic
            });

            document.getElementById('detail-deck-price').innerText = "$"+totalVal.toFixed(2);
            document.getElementById('deck-charts').classList.remove('hidden');
            renderTypeChart(types); renderManaCurve(cmcs); renderColorChart(colors);
            
            // Advisor
            const stats = { lands:{count:0,target:36}, ramp:{count:0,target:10}, draw:{count:0,target:10}, removal:{count:0,target:10}, wipes:{count:0,target:3} };
            cache.forEach(c => {
                const t=(c.oracle_text||"").toLowerCase(), ty=(c.type_line||"").toLowerCase();
                if(ty.includes('land')) stats.lands.count++;
                if(t.includes('add') && t.includes('mana')) stats.ramp.count++;
                if(t.includes('draw') && t.includes('card')) stats.draw.count++;
                if((t.includes('destroy')||t.includes('exile')) && t.includes('target')) stats.removal.count++;
                if(t.includes('destroy') && t.includes('all')) stats.wipes.count++;
            });
            let advHtml = "";
            for(const [k,d] of Object.entries(stats)) {
                let col = 'var(--red)'; if(d.count/d.target > 0.8) col='var(--green)';
                advHtml += `<div class="mb-5 flex-between text-sub" style="font-size:10px;"><span style="text-transform:capitalize">${k}</span><span>${d.count}/${d.target}</span></div><div class="progress-bg"><div class="progress-fill" style="width:${Math.min(100, (d.count/d.target)*100)}%; background:${col}"></div></div>`;
            }
            document.getElementById('advisor-grid').innerHTML = advHtml;
            currentDeckCache = cache;
        }

        async function saveDeck(btn) {
            setLoading(btn, true);
            const name = document.getElementById('deckName').value;
            const main = document.getElementById('deckMain').value;
            try {
                if(!name) throw new Error("Name required");
                const { error } = await sb.from('decks').insert({ user_id:session.user.id, name:name, card_list:main, format:document.getElementById('deckFormat').value });
                if(error) throw error;
                showToast("Saved!", "success"); loadDecks();
            } catch(e) { showToast(e.message||"Error", "error"); } finally { setLoading(btn, false); }
        }

        // --- AUTH ---
        async function handleAuthAction(btn){ 
            setLoading(btn, true);
            const e=document.getElementById('email').value, p=document.getElementById('password').value;
            const { data, error } = await sb.auth.signInWithPassword({email:e,password:p});
            if(error) {
                const sup = await sb.auth.signUp({email:e,password:p});
                if(sup.data.session) finalizeLogin(sup.data.session); else showToast("Check email to confirm signup.", "success");
            } else finalizeLogin(data.session);
            setLoading(btn, false);
        }
        function finalizeLogin(s){ session=s; document.getElementById('auth-screen').classList.add('hidden'); document.getElementById('app').classList.remove('hidden'); document.getElementById('user-email').innerText=s.user.email; loadData(); }
        async function handleLogout(){ await sb.auth.signOut(); window.location.reload(); }

        // --- INIT ---
        sb.auth.getSession().then(({ data: { session: s } }) => { if (s) finalizeLogin(s); });
    </script>
</body>
</html>

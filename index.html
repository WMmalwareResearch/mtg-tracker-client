<!DOCTYPE html>
<html lang="en">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Grimoire: The ultimate MTG collection manager and finance tracker. Track prices, analyze decks, and manage your portfolio.">
    <title>Grimoire | MTG Finance & Collection</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîÆ</text></svg>">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --primary: #6366f1; /* Indigo */
            --bg: #f1f5f9;      /* Slate 100 */
            --sidebar: #ffffff;
            --card: #ffffff;
            --text: #0f172a;    /* Slate 900 */
            --subtext: #64748b; /* Slate 500 */
            --border: #e2e8f0;
            --green: #10b981;
            --red: #ef4444;
            --ad-bg: #e2e8f0;   /* Ad Placeholder */
            --input-bg: #ffffff;
            --hover: #f8fafc;
        }

        [data-theme="dark"] {
            --primary: #818cf8;
            --bg: #0f172a;      /* Slate 900 */
            --sidebar: #1e293b; /* Slate 800 */
            --card: #1e293b;
            --text: #f8fafc;    /* Slate 50 */
            --subtext: #94a3b8;
            --border: #334155;
            --ad-bg: #334155;
            --input-bg: #334155;
            --hover: #334155;
        }

        /* --- LAYOUT GRID --- */
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; color: var(--text); height: 100vh; display: grid; grid-template-columns: 240px 1fr; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { background: var(--sidebar); border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; justify-content: space-between; z-index: 10; }
        .logo { font-size: 20px; font-weight: 800; display: flex; align-items: center; gap: 10px; color: var(--primary); margin-bottom: 40px; letter-spacing: -0.5px; }
        .nav-links { display: flex; flex-direction: column; gap: 5px; }
        .nav-item { padding: 12px 15px; border-radius: 8px; cursor: pointer; color: var(--subtext); font-weight: 600; font-size: 14px; transition: 0.2s; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover { background: var(--bg); color: var(--text); }
        .nav-item.active { background: #e0e7ff; color: var(--primary); }
        [data-theme="dark"] .nav-item.active { background: rgba(99, 102, 241, 0.2); }

        /* MAIN CONTENT AREA */
        .main-content { overflow-y: auto; padding: 0 40px 40px 40px; display: flex; flex-direction: column; }
        
        /* AD ZONES */
        .ad-banner-top { width: 100%; height: 90px; background: var(--ad-bg); margin: 20px 0; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--subtext); font-size: 12px; font-weight: bold; border: 1px dashed var(--border); }
        .ad-sidebar { width: 100%; height: 250px; background: var(--ad-bg); border-radius: 8px; margin-top: 20px; display: flex; align-items: center; justify-content: center; color: var(--subtext); font-size: 12px; font-weight: bold; border: 1px dashed var(--border); }

        /* HEADER */
        .top-bar { display: flex; justify-content: flex-end; align-items: center; padding: 20px 0; gap: 15px; }
        .theme-btn { background: none; border: 1px solid var(--border); border-radius: 50%; width: 36px; height: 36px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; color: var(--text); transition: 0.2s; }
        .theme-btn:hover { background: var(--hover); }

        /* VIEW CONTAINER */
        .view-container { max-width: 1200px; margin: 0 auto; width: 100%; }
        .view { display: none; animation: fadeUp 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- COMPONENT STYLES --- */
        .card-box { background: var(--card); padding: 24px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        h1 { font-size: 24px; font-weight: 700; margin-bottom: 5px; color: var(--text); }
        h2 { font-size: 14px; font-weight: 500; color: var(--subtext); margin: 0 0 20px 0; }
        h3 { font-size: 16px; font-weight: 700; color: var(--text); margin-top: 0; margin-bottom: 15px; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }

        /* INPUTS & BUTTONS */
        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; margin-bottom: 6px; color: var(--subtext); letter-spacing: 0.5px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text); border-radius: 6px; margin-bottom: 10px; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        input:focus, select:focus, textarea:focus { outline: 2px solid var(--primary); border-color: transparent; }
        
        .btn-primary { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-secondary { padding: 8px 16px; background: var(--card); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; color: var(--text); font-weight: 500; font-size: 13px; transition: 0.2s; }
        .btn-secondary:hover { background: var(--hover); }
        .btn-danger { width: 100%; padding: 12px; background: rgba(239, 68, 68, 0.1); color: var(--red); border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }
        
        /* FOOTER */
        .footer-legal { margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border); text-align: center; color: var(--subtext); font-size: 11px; }
        .footer-legal a { color: var(--subtext); text-decoration: none; margin: 0 10px; }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            body { grid-template-columns: 1fr; }
            .sidebar { display: none; } /* Mobile menu would go here */
            .main-content { padding: 15px; }
            .grid-2 { grid-template-columns: 1fr; }
        }

        /* --- FUNCTIONAL STYLES (from V2.6) --- */
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--hover); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid var(--border); }
        .stat-num { font-size: 20px; font-weight: 800; color: var(--primary); }
        .stat-label { font-size: 11px; font-weight: 700; color: var(--subtext); text-transform: uppercase; }
        .chart-container { height: 250px; width: 100%; position: relative; }
        
        /* LISTS */
        .top-card-row { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 13px; color: var(--text); }
        .collection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .grid-card { position: relative; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s; background: #000; aspect-ratio: 2.5/3.5; }
        .grid-card:hover { transform: translateY(-5px); }
        .grid-card img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .grid-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.9), rgba(0,0,0,0)); padding: 10px; color: white; transform: translateY(100%); transition: transform 0.2s; display: flex; flex-direction: column; }
        .grid-card:hover .grid-overlay { transform: translateY(0); }
        .grid-price { font-weight: 700; color: #4ade80; font-size: 14px; }
        .grid-del { position: absolute; top: 5px; right: 5px; background: rgba(220, 38, 38, 0.8); color: white; border: none; border-radius: 4px; padding: 2px 6px; cursor: pointer; display: none; font-size: 10px; }
        .grid-card:hover .grid-del { display: block; }

        /* HELPER CLASSES */
        .hidden { display: none !important; }
        #importStatus { color: var(--primary); font-weight: bold; font-size: 12px; margin-top: 5px; }
        #suggestions { position: absolute; background: var(--card); width: 100%; border: 1px solid var(--border); z-index: 99; max-height: 200px; overflow-y: auto; display: none; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2); margin-top: 2px; }
        .s-item { padding: 10px 12px; cursor: pointer; font-size: 14px; border-bottom: 1px solid var(--border); color: var(--text); }
        .s-item:hover { background: var(--hover); color: var(--primary); }
    </style>
</head>
<body>

    <div class="sidebar">
        <div>
            <div class="logo">
                <span>üîÆ</span> GRIMOIRE
            </div>
            <div class="nav-links">
                <div class="nav-item active" onclick="nav('home', this)">üè† Dashboard</div>
                <div class="nav-item" onclick="nav('add', this)">‚ûï Add Asset</div>
                <div class="nav-item" onclick="nav('collection', this)">üìö Collection</div>
                <div class="nav-item" onclick="nav('analytics', this)">üìä Finance</div>
                <div class="nav-item" onclick="nav('deckcheck', this)">üìã Deck Check</div>
            </div>
        </div>
        
        <div>
            <div class="ad-sidebar">
                AD SPACE<br>(Skyscraper)
            </div>
            <div style="font-size: 10px; color: var(--subtext); margin-top: 10px; text-align: center;">v3.1 Beta</div>
        </div>
    </div>

    <div class="main-content">
        
        <div class="top-bar">
            <button class="theme-btn" onclick="toggleTheme()" id="themeBtn" title="Toggle Dark Mode">üåô</button>
            <button class="btn-secondary" onclick="showSetup()">‚öôÔ∏è Settings</button>
        </div>

        <div class="ad-banner-top">
            AD SPACE (Leaderboard 728x90)
        </div>

        <div class="view-container">

            <div id="view-home" class="view active">
                <h1>Dashboard</h1>
                <h2>Your portfolio at a glance.</h2>
                
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-num" id="stat-count">0</div>
                        <div class="stat-label">Cards</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-num" id="stat-value" style="color:var(--primary);">$0.00</div>
                        <div class="stat-label">Market Value</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-num" id="stat-cost" style="color:var(--subtext);">$0.00</div>
                        <div class="stat-label">Cost Basis</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-num" id="stat-gain">$0.00</div>
                        <div class="stat-label">Unrealized P/L</div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="card-box">
                        <h3>Portfolio Value</h3>
                        <div class="chart-container"><canvas id="historyChart"></canvas></div>
                    </div>
                    <div class="card-box">
                        <h3>Daily Movers</h3>
                        <div id="moversList">Loading market data...</div>
                    </div>
                </div>
            </div>

            <div id="view-add" class="view">
                <h1>Add Asset</h1>
                <h2>Catalog new cards into your portfolio.</h2>
                
                <div class="grid-2">
                    <div class="card-box">
                        <form id="addForm" onsubmit="event.preventDefault(); submitForm(this)">
                            <div class="input-group" style="position:relative;">
                                <label>Card Name</label>
                                <input type="text" id="search" placeholder="Search Scryfall..." autocomplete="off">
                                <div id="suggestions"></div>
                            </div>
                            
                            <div id="verGrp" style="display:none; margin-bottom:15px;">
                                <label>Select Version</label>
                                <select id="versionSelect" onchange="updateUI()"></select>
                            </div>

                            <label>Set & Number</label>
                            <div style="display:flex; gap:10px; margin-bottom:15px;">
                                <input id="setCode" readonly placeholder="SET" style="background:var(--hover); color:var(--subtext);">
                                <input id="colNum" readonly placeholder="#" style="background:var(--hover); color:var(--subtext);">
                            </div>

                            <label>Financials</label>
                            <div class="grid-2">
                                <div>
                                    <label style="font-size:9px;">Cost (Opt)</label>
                                    <input type="number" id="boughtPriceInput" step="0.01" placeholder="0.00">
                                </div>
                                <div>
                                    <label style="font-size:9px;">Qty</label>
                                    <input type="number" id="quantityInput" value="1" oninput="calculateTotalValue()">
                                </div>
                            </div>

                            <div style="display:flex; gap:20px; margin-bottom:20px; align-items: center;">
                                <label style="display:flex; align-items:center; gap:5px; cursor:pointer;">
                                    <input type="checkbox" id="foil-on" style="width:auto; margin:0;" onchange="calculateTotalValue()"> Foil
                                </label>
                                <div style="font-size:12px;">Est. Market: <span id="bigPrice" style="font-weight:bold; color:var(--green);">--</span></div>
                            </div>

                            <div style="display:none;">
                                <select id="currencySelect" onchange="updateUI()"><option value="CAD" selected>CAD</option></select>
                                <input id="locationInput" value="Unsorted">
                            </div>

                            <button class="btn-primary" id="subBtn">Add Asset</button>
                            
                            <input type="hidden" id="cardNameInput"><input type="hidden" id="cardPriceInput">
                        </form>
                    </div>
                    <div class="card-box" style="text-align:center; display:flex; align-items:center; justify-content:center; background:var(--bg); border-style:dashed;">
                        <img id="cardPreview" style="max-width: 100%; border-radius: 10px; display:none;">
                        <span id="previewText" style="color:var(--subtext);">Card Preview</span>
                    </div>
                </div>
            </div>

            <div id="view-collection" class="view">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h1 style="margin:0;">Collection</h1>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-secondary" onclick="document.getElementById('csvInput').click()">Import CSV</button>
                        <button class="btn-secondary" onclick="exportCSV()">Export</button>
                        <input type="file" id="csvInput" style="display:none;" onchange="handleImport()">
                    </div>
                </div>
                <div id="importStatus"></div>
                
                <div class="card-box">
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="collectionSearch" placeholder="Search your database..." oninput="filterCollection()" style="flex:1;">
                        <button class="btn-secondary" onclick="updatePrices(this)">üîÑ Prices</button>
                    </div>
                    <div id="collectionList" style="margin-top:20px;">Loading...</div>
                </div>
            </div>

            <div id="view-analytics" class="view">
                <h1>Analytics</h1>
                <h2>Deep dive into your portfolio metrics.</h2>
                <div class="grid-dashboard">
                    <div class="card-box"><h3>Allocation (Color)</h3><div class="chart-container"><canvas id="colorChart"></canvas></div></div>
                    <div class="card-box"><h3>Allocation (Rarity)</h3><div class="chart-container"><canvas id="rarityChart"></canvas></div></div>
                    <div class="card-box"><h3>Top Sets</h3><div class="chart-container"><canvas id="setChart"></canvas></div></div>
                </div>
                <div class="card-box" style="margin-top:20px;">
                    <h3>üíé Top Assets</h3>
                    <div id="topCardsList"></div>
                </div>
            </div>

            <div id="view-deckcheck" class="view">
                <h1>Deck Validator</h1>
                <div class="card-box">
                    <textarea id="deckInput" style="width:100%; height:150px; border-radius:6px; border:1px solid var(--border); background:var(--bg); color:var(--text); padding:10px; font-family:monospace;" placeholder="1 Sol Ring [C19]..."></textarea>
                    <br><br>
                    <button class="btn-primary" onclick="runDeckCheck(this)">Validate Ownership</button>
                </div>
                <div id="deckResults" style="margin-top:20px;"></div>
            </div>

        </div> <div class="footer-legal">
            &copy; 2025 Grimoire. All rights reserved.<br>
            <a href="#">Privacy Policy</a> | <a href="#">Terms of Service</a> | <a href="#">Cookie Policy</a>
        </div>

    </div> <div id="setupModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; z-index:9999;">
        <div style="background:var(--card); padding:30px; border-radius:12px; width:400px; border: 1px solid var(--border);">
            <h2>Configuration</h2>
            <label>API Endpoint</label>
            <input id="apiUrlInput" placeholder="https://script.google.com/...">
            <button class="btn-primary" onclick="saveApiUrl()">Save Connection</button>
            <br><br>
            <button class="btn-danger" style="width:100%;" onclick="runMaintenance()">Run Database Maintenance</button>
            <br><br>
            <button class="btn-secondary" style="width:100%;" onclick="document.getElementById('setupModal').classList.add('hidden')">Close</button>
        </div>
    </div>

    <script>
        // --- V3.1 LOGIC KERNEL ---
        const APP_VERSION = "v3.1 Commercial Beta";
        let API_ENDPOINT = "", rawCollectionData = [], currentCardData = null, debounceTimer, viewMode = 'list', charts = { color: null, rarity: null, history: null, sets: null };

        // INIT
        window.onload = function() {
            loadTheme();
            checkConnection();
        };

        // NAV
        function nav(viewId, btn) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + viewId).classList.add('active');
            if(btn) {
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                btn.classList.add('active');
            }
            if (viewId === 'home' || viewId === 'analytics') loadAnalytics();
            if (viewId === 'collection') loadCollection();
        }

        // THEME
        function toggleTheme() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            localStorage.setItem('mtgManager_Theme', isDark ? 'light' : 'dark');
        }
        function loadTheme() { if(localStorage.getItem('mtgManager_Theme') === 'dark') document.body.setAttribute('data-theme', 'dark'); }

        // API
        function checkConnection() { const storedUrl = localStorage.getItem('mtg_api_url'); if (!storedUrl) document.getElementById('setupModal').classList.remove('hidden'); else { API_ENDPOINT = storedUrl; init(); } }
        function saveApiUrl() { const input = document.getElementById('apiUrlInput').value.trim(); if (!input.includes('script.google.com')) { alert("Invalid URL."); return; } localStorage.setItem('mtg_api_url', input); API_ENDPOINT = input; document.getElementById('setupModal').classList.add('hidden'); init(); }
        async function callAPI(action, data = {}) { if (!API_ENDPOINT) return { success: false }; try { const response = await fetch(`${API_ENDPOINT}?action=${action}`, { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify({ ...data, action: action }) }); if (!response.ok) throw new Error(response.status); return await response.json(); } catch (error) { console.error(error); return { success: false, error: error.message }; } }
        function init() { loadLocations(); calculateTotalValue(); loadAnalytics(); } // Pre-load stats on init

        // MAINTENANCE
        async function runMaintenance() { if (!confirm("Sort & Clean Database?")) return; const res = await callAPI('performMaintenance'); if (res.success) { alert(`Cleaned ${res.data.count} rows!`); loadCollection(); } else { alert("Failed: " + res.error); } }

        // --- ADD CARD LOGIC ---
        const search = document.getElementById('search'); const suggs = document.getElementById('suggestions');
        search.addEventListener('input', function(e) {
            const q = e.target.value; clearTimeout(debounceTimer);
            if (q.length < 3) { suggs.style.display = 'none'; return; }
            debounceTimer = setTimeout(() => {
                fetch('https://api.scryfall.com/cards/autocomplete?q=' + encodeURIComponent(q)).then(r => r.json()).then(j => {
                    if (j.data) { suggs.innerHTML = ''; j.data.forEach(n => { const d = document.createElement('div'); d.className = 's-item'; d.innerText = n; d.onclick = () => selectCard(n); suggs.appendChild(d); }); suggs.style.display = 'block'; }
                });
            }, 300);
        });
        async function selectCard(name) { search.value = name; suggs.style.display = 'none'; document.getElementById('bigPrice').innerText = 'Loading...'; document.getElementById('verGrp').style.display = 'block'; document.getElementById('versionSelect').innerHTML = '<option>Loading...</option>'; const res = await callAPI('getCardVersionsEncoded', { name: name }); if (res.success) versionsRx(res.data); }
        function versionsRx(j) { const vers = JSON.parse(j); const sel = document.getElementById('versionSelect'); sel.innerHTML = ''; if (!vers.length) { sel.innerHTML = '<option>No versions</option>'; updateUI(); return; } let best = 0, low = Infinity; vers.forEach((v, i) => { const o = document.createElement('option'); o.value = JSON.stringify(v); o.text = `${v.setName || v.set} (${v.set}) #${v.code} (${v.year})`; sel.add(o); if (v.prices.USD.normal < low) { low = v.prices.USD.normal; best = i; } }); sel.selectedIndex = best; updateUI(); }
        function updateUI() { 
            const sel = document.getElementById('versionSelect'); if (sel.value) currentCardData = JSON.parse(sel.value); 
            document.getElementById('setCode').value = currentCardData.set; document.getElementById('colNum').value = currentCardData.code; 
            const img = document.getElementById('cardPreview'); 
            if (currentCardData.image) { img.src = currentCardData.image; img.style.display = 'block'; document.getElementById('previewText').style.display='none'; } 
            calculateTotalValue(); 
        }
        function calculateTotalValue() {
            const qty = parseInt(document.getElementById('quantityInput').value) || 1; const foil = document.getElementById('foil-on').checked; const cur = document.getElementById('currencySelect').value; let p = 0, sym = "$";
            if (currentCardData && currentCardData.prices) { if (cur === 'EUR') { p = foil ? currentCardData.prices.EUR.foil : currentCardData.prices.EUR.normal; sym = "‚Ç¨"; } else if (cur === 'CAD') { p = foil ? currentCardData.prices.CAD.foil : currentCardData.prices.CAD.normal; sym = "C$"; } else { p = foil ? currentCardData.prices.USD.foil : currentCardData.prices.USD.normal; } }
            document.getElementById('cardPriceInput').value = p; document.getElementById('bigPrice').innerText = sym + (p || 0).toFixed(2); document.getElementById('totalValue').innerText = sym + ((p || 0) * qty).toFixed(2);
        }
        async function submitForm(f) {
            document.getElementById('subBtn').disabled = true; const loc = "Unsorted";
            const fd = { setCode: document.getElementById('setCode').value, colNum: document.getElementById('colNum').value, quantity: document.getElementById('quantityInput').value, isFoil: document.getElementById('foil-on').checked, cardLocation: loc, cardName: document.getElementById('search').value, 
            cardPrice: document.getElementById('cardPriceInput').value, boughtPrice: document.getElementById('boughtPriceInput').value };
            const res = await callAPI('processForm', fd); document.getElementById('subBtn').disabled = false;
            if (res.success) { 
                alert("Asset Added!"); 
                f.reset(); document.getElementById('search').value=''; document.getElementById('cardPreview').style.display='none'; document.getElementById('previewText').style.display='block'; currentCardData=null; 
            }
        }

        // --- IMPORT/EXPORT ---
        function handleImport() {
            const fi = document.getElementById('csvInput'), st = document.getElementById('importStatus'); if (!fi.files.length) return; st.style.display = 'block'; st.innerText = "Parsing...";
            Papa.parse(fi.files[0], { header: true, skipEmptyLines: true, complete: async function(res) {
                const cards = res.data.map(r => ({ name: r.Name || r.name, set: r.Set || r.set, code: r.Code || r.code, qty: parseInt(r.Qty || r.quantity || 1), foil: r.Foil || r.foil })).filter(c => c.name);
                const chunks = []; for (let i = 0; i < cards.length; i += 10) chunks.push(cards.slice(i, i + 10));
                let count = 0; for (let i = 0; i < chunks.length; i++) { st.innerText = `Batch ${i + 1}/${chunks.length}...`; await callAPI('processBatch', { cards: chunks[i], location: "Import" }); count += chunks[i].length; }
                st.innerText = `Done! ${count} cards.`; loadCollection(); setTimeout(() => st.style.display = 'none', 4000);
            }});
        }
        function exportCSV() { if (!rawCollectionData.length) return; const csv = "data:text/csv;charset=utf-8," + ["Set,Code,Name,Finish,Qty,Price,Loc"].join(",") + "\n" + rawCollectionData.map(c => [c.SetCode, c.Code, `"${c.Name.replace(/"/g, '""')}"`, c.Finish, c.Quantity, c.TotalValue, `"${c.Location}"`].join(",")).join("\n"); const l = document.createElement("a"); l.href = encodeURI(csv); l.download = "mtg_export.csv"; l.click(); }

        // --- COLLECTION ---
        async function loadCollection() {
            document.getElementById('collectionList').innerText = 'Loading...'; const res = await callAPI('getCollectionData');
            if (res.success) { rawCollectionData = res.data; filterCollection(); }
        }
        function filterCollection() {
            const q = document.getElementById('collectionSearch').value.toLowerCase();
            const list = rawCollectionData.filter(c => (c.Name.toLowerCase().includes(q) || c.SetCode.toLowerCase().includes(q) || (c.Location || "").toLowerCase().includes(q)));
            const div = document.getElementById('collectionList'); div.innerHTML = '';
            // Using Grid mode by default for Collection view in V3
            div.className = 'collection-grid'; 
            list.forEach(c => div.innerHTML += `<div class="grid-card"><button class="grid-del" onclick="del('${c.SetCode.replace(/'/g, "\\'")}', '${c.Code.replace(/'/g, "\\'")}', '${c.Finish === 'Foil'}')">√ó</button><img src="${c.ImageURL}" loading="lazy"><div class="grid-overlay"><div class="grid-price">$${c.TotalValue}</div><div class="grid-meta"><span>${c.Finish === 'Foil' ? '‚ú®' : ''} x${c.Quantity}</span><span>${c.Location.substring(0, 8)}...</span></div></div></div>`);
        }
        async function del(s, c, f) { if (confirm("Delete Asset?")) { const r = await callAPI('deleteCardRow', { s: s, c: c, f: f === 'true' }); if (r.success) loadCollection(); } }
        async function updatePrices(btn) { btn.disabled = true; btn.innerText = "..."; const r = await callAPI('refreshCollectionPrices'); btn.disabled = false; btn.innerText = "üîÑ Prices"; if (r.success) { alert(`Updated ${r.data.updatedCount}`); loadCollection(); } }
        async function loadLocations() { await callAPI('getUniqueLocations'); /* Placeholder for future filter logic */ }

        // --- ANALYTICS ---
        async function loadAnalytics() { const r = await callAPI('getAnalyticsData'); if (r.success) renderAnalytics(r.data); }
        function renderAnalytics(d) {
            if (!d) return;
            document.getElementById('stat-count').innerText = d.totalCards;
            document.getElementById('stat-value').innerText = "$" + d.totalValue;
            document.getElementById('stat-cost').innerText = "$" + d.totalCost;
            
            const gain = parseFloat(d.totalValue) - parseFloat(d.totalCost);
            const gainPct = (parseFloat(d.totalCost) > 0) ? ((gain / parseFloat(d.totalCost)) * 100).toFixed(1) : 0;
            const gainEl = document.getElementById('stat-gain');
            gainEl.innerText = `${gain >= 0 ? '+' : ''}$${gain.toFixed(2)} (${gainPct}%)`;
            gainEl.style.color = gain >= 0 ? 'var(--green)' : 'var(--red)';

            document.getElementById('moversList').innerHTML = d.biggestMovers.map(c => `<div class="top-card-row"><div>${c.name}</div><div style="color:${c.change >= 0 ? 'var(--green)' : 'var(--red)'}">${c.change >= 0 ? '+' : ''}${c.change.toFixed(2)}</div></div>`).join('');
            document.getElementById('topCardsList').innerHTML = d.topCards.map(c => `<div class="top-card-row"><div>${c.name}</div><div style="color:var(--green)">$${c.price}</div></div>`).join('');
            
            if (charts.history) charts.history.destroy(); charts.history = new Chart(document.getElementById('historyChart').getContext('2d'), { type: 'line', data: { labels: d.history.map(h => new Date(h.date).toLocaleDateString()), datasets: [{ label: 'Value', data: d.history.map(h => h.value), borderColor: '#6366f1', fill: true }] }, options: { responsive: true, maintainAspectRatio: false } });
            if (charts.color) charts.color.destroy(); charts.color = new Chart(document.getElementById('colorChart').getContext('2d'), { type: 'doughnut', data: { labels: ['W', 'U', 'B', 'R', 'G', 'M', 'C'], datasets: [{ data: [d.colors.W, d.colors.U, d.colors.B, d.colors.R, d.colors.G, d.colors.Multi, d.colors.Colorless], backgroundColor: ['#f0f2c9', '#b3ceea', '#aeb2b7', '#eaa6a5', '#b6d7a8', '#dcc689', '#d7d7d7'] }] }, options: { responsive: true, maintainAspectRatio: false } });
            if (charts.rarity) charts.rarity.destroy(); charts.rarity = new Chart(document.getElementById('rarityChart').getContext('2d'), { type: 'bar', data: { labels: ['C', 'U', 'R', 'M'], datasets: [{ label: 'Count', data: [d.rarity.common, d.rarity.uncommon, d.rarity.rare, d.rarity.mythic], backgroundColor: ['#0f172a', '#94a3b8', '#d4af37', '#ef4444'] }] }, options: { responsive: true, maintainAspectRatio: false } });
            if (charts.sets) charts.sets.destroy(); charts.sets = new Chart(document.getElementById('setChart').getContext('2d'), { type: 'bar', indexAxis: 'y', data: { labels: d.sets.map(s => s.set), datasets: [{ label: 'Unique Cards', data: d.sets.map(s => s.count), backgroundColor: '#6366f1', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false } });
        }
        async function runDeckCheck(btn) {
            const t = document.getElementById('deckInput').value; if (!t) return; btn.disabled = true; const r = await callAPI('checkDeckList', { deckText: t }); btn.disabled = false;
            if (r.success) {
                const res = r.data, d = document.getElementById('deckResults'); d.innerHTML = '';
                if (!res.found.length && !res.missing.length) { d.innerText = "No cards found."; return; }
                const p = Math.round((res.found.length / (res.found.length + res.missing.length)) * 100);
                d.innerHTML = `<h3>Deck Status: ${p}%</h3><div class="progress-container"><div class="progress-bar" style="width: ${p}%"></div></div>`;
                if (res.missing.length) { d.innerHTML += `<h4>Missing</h4><div class="collection-grid">` + res.missing.map(m => `<div class="grid-card" style="filter:grayscale(1); opacity:0.7;"><div style="position:absolute; top:5px; left:5px; background:red; color:white; padding:2px 5px; border-radius:4px; font-size:10px;">Need ${m.req}</div><img src="https://api.scryfall.com/cards/named?exact=${encodeURIComponent(m.name.split('[')[0].trim())}&format=image"></div>`).join('') + `</div>`; }
                if (res.found.length) { d.innerHTML += `<h4>Owned</h4><div class="collection-grid">` + res.found.map(m => `<div class="grid-card"><div style="position:absolute; top:5px; left:5px; background:green; color:white; padding:2px 5px; border-radius:4px; font-size:10px;">Have ${m.have}</div><img src="${m.image}"></div>`).join('') + `</div>`; }
            }
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Grimoire | v9.5 (Restored & Secure)</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü©∏</text></svg>">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- THEME & VARS --- */
        :root { --primary: #a78bfa; --bg-dark: #0f0a1c; --card-bg: rgba(45, 21, 60, 0.8); --text: #f8fafc; --subtext: #a1a1aa; --border: rgba(167, 139, 250, 0.2); --green: #d946ef; --red: #dc2626; --yellow: #facc15; --blue: #3b82f6; --shadow: 0 4px 15px rgba(0, 0, 0, 0.5); --chart-color-1: #d946ef; --chart-color-2: #dc2626; --chart-color-3: #a78bfa; --chart-color-4: #4f46e5; --chart-color-5: #059669; }
        body { font-family: 'Inter', sans-serif; background: radial-gradient(circle at top left, #1a1a1a, var(--bg-dark)); background-attachment: fixed; color: var(--text); margin: 0; height: 100vh; display: flex; flex-direction: column; font-size: clamp(1rem, 0.8rem + 0.5vw, 1.125rem); overflow: hidden; transition: background 0.5s; }
        * { box-sizing: border-box; } .hidden { display: none !important; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* UI ELEMENTS */
        button { position: relative; overflow: hidden; transform: translate3d(0, 0, 0); cursor: pointer; }
        button:after { content: ""; display: block; position: absolute; width: 100%; height: 100%; top: 0; left: 0; pointer-events: none; background-image: radial-gradient(circle, #fff 10%, transparent 10.01%); background-repeat: no-repeat; background-position: 50%; transform: scale(10, 10); opacity: 0; transition: transform .5s, opacity 1s; }
        button:active:after { transform: scale(0, 0); opacity: .2; transition: 0s; }
        
        /* THE GUARD (Spinner) */
        .btn-loading { pointer-events: none; opacity: 0.7; position: relative; color: transparent !important; }
        .btn-loading::after { content: ""; position: absolute; left: 50%; top: 50%; width: 16px; height: 16px; margin: -8px; border: 2px solid white; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; color: white; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* COMPONENTS */
        .card-box { background: var(--card-bg); backdrop-filter: blur(12px); padding: 1.5rem; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 24px; box-shadow: var(--shadow); transition: border-color 0.3s; }
        .input-group { position: relative; display: flex; align-items: center; margin-bottom: 15px; }
        .input-icon { position: absolute; left: 12px; color: var(--subtext); font-size: 16px; pointer-events: none; }
        input, select { width: 100%; padding: 14px 14px 14px 40px; border-radius: 8px; border: 1px solid var(--border); background: rgba(0,0,0,0.4); color: white; font-size: 14px; margin: 0; }
        textarea { padding: 14px; margin-bottom: 15px; height: 350px; resize: vertical; background: rgba(0,0,0,0.2); border: 1px solid var(--border); color: var(--text); border-radius: 8px; width: 100%; font-family: monospace; font-size: 13px; }
        button { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 14px; transition: transform 0.1s, opacity 0.2s, background 0.3s; }
        .secondary { background: rgba(255,255,255,0.1); }
        .btn-sm { width: auto; padding: 6px 12px; font-size: 11px; }
        .btn-md { width: auto; padding: 8px 16px; font-size: 12px; }
        
        /* LAYOUT */
        .app-container { display: grid; grid-template-columns: 240px 1fr; height: 100%; overflow: hidden; }
        .sidebar { background: var(--card-bg); backdrop-filter: blur(12px); border-right: 1px solid var(--border); padding: 25px; display: flex; flex-direction: column; z-index: 10; }
        .main { padding: 40px clamp(1rem, 2vw + 1rem, 5rem); overflow-y: auto; flex: 1; }
        .bottom-nav { display: none; } 
        @media (max-width: 768px) { .app-container { grid-template-columns: 1fr; padding-bottom: 80px; } .sidebar { display: none; } .bottom-nav { display: flex; position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(15, 10, 28, 0.95); border-top: 1px solid var(--border); padding: 10px 0; justify-content: space-around; z-index: 20; backdrop-filter: blur(10px); } .main { padding: 20px 15px; } }

        /* GRIDS & VISUALS */
        .grid-card { position: relative; aspect-ratio: 2.5/3.5; border-radius: 10px; overflow: hidden; cursor: pointer; transition: transform 0.2s; background: rgba(0,0,0,0.3); border: 1px solid var(--border); }
        .grid-card img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.5s; }
        .collection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 20px; }
        .deck-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        .deck-card { background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 12px; height: 300px; display: flex; flex-direction: column; justify-content: flex-end; position: relative; overflow: hidden; cursor: pointer; transition: all 0.3s; background-size: cover; background-position: center; }
        .deck-card::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top, rgba(15, 10, 28, 1) 0%, rgba(15, 10, 28, 0.6) 40%, rgba(15, 10, 28, 0) 100%); z-index: 1; }
        .deck-card-content { position: relative; z-index: 2; padding: 20px; }

        /* UTILS */
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .flex-row { display: flex; align-items: center; gap: 10px; }
        .text-sub { color: var(--subtext); font-size: 12px; }
        .mb-20 { margin-bottom: 20px; } .mt-20 { margin-top: 20px; }
        
        .skeleton { background-color: var(--card-bg); background-image: linear-gradient(90deg, var(--card-bg) 0%, rgba(167, 139, 250, 0.1) 20%, var(--card-bg) 40%, var(--card-bg) 100%); background-size: 200% 100%; animation: shimmer 1.5s infinite linear; border-radius: 4px; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeUp 0.3s cubic-bezier(0.25, 0.8, 0.25, 1) forwards; }
        
        /* Modal & FAB */
        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 10, 28, 0.95); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .fab-btn { position: fixed; bottom: 90px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background: var(--primary); color: white; border: none; box-shadow: 0 4px 15px rgba(167, 139, 250, 0.6); font-size: 28px; display: flex; align-items: center; justify-content: center; z-index: 100; }
        @media (min-width: 769px) { .fab-btn { display: none; } }
        
        /* LINK STYLES (Accountant) */
        .deck-line { padding: 4px 8px; border-radius: 4px; margin-bottom: 2px; }
        .is-owned { color: var(--green); border-left: 2px solid var(--green); background: rgba(217, 70, 239, 0.05); }
        .is-partial { color: var(--yellow); border-left: 2px solid var(--yellow); background: rgba(250, 204, 21, 0.05); }
        .is-missing { color: var(--red); border-left: 2px solid var(--red); opacity: 0.8; }
        .progress-bg { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; margin-top: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); transition: width 0.5s ease-out; }
    </style>
</head>
<body>
    <img id="hover-preview" style="position:fixed; z-index:2000; width:220px; border-radius:12px; display:none; pointer-events:none;">
    <div id="toast-container" style="position:fixed; bottom:20px; right:20px; z-index:9999; display:flex; flex-direction:column; gap:10px;"></div>

    <div id="auth-screen" class="modal-overlay">
        <div class="card-box" style="max-width:350px; text-align:center;">
            <h1 style="color:var(--primary);">ü©∏ The Grimoire</h1>
            <div class="input-group"><input type="email" id="email" placeholder="Email" style="padding-left:14px;"></div>
            <div class="input-group"><input type="password" id="password" placeholder="Password" style="padding-left:14px;"></div>
            <button onclick="handleAuthAction(this)">Enter</button>
        </div>
    </div>

    <div id="user-options-modal" class="modal-overlay hidden" onclick="closeUserOptionsModal()">
        <div class="card-box" style="max-width:300px;" onclick="event.stopPropagation()">
            <h2 class="mb-20">Menu</h2>
            <button class="secondary w-full mb-20" onclick="nav('settings','settings'); closeUserOptionsModal()">Settings</button>
            <button class="w-full" style="background:var(--red);" onclick="handleLogout(this)">Log Out</button>
        </div>
    </div>
    
    <div id="land-modal" class="modal-overlay hidden" onclick="if(event.target===this) this.classList.add('hidden')">
        <div class="card-box" style="max-width:400px;">
            <h2>The Geomancer</h2>
            <input type="number" id="target-land-count" value="36" onchange="recalcLands()" placeholder="Total Lands">
            <div id="land-results" class="mb-20"></div>
            <button onclick="applyLands(this)">Add to Deck</button>
        </div>
    </div>
    
    <div id="codex-modal" class="modal-overlay hidden" onclick="if(event.target===this) this.classList.add('hidden')">
        <div class="card-box" style="max-width:800px; display:flex; gap:20px; flex-wrap:wrap;">
            <img id="codex-img" style="width:250px; border-radius:12px;">
            <div style="flex:1;">
                <h2 id="codex-title"></h2>
                <div id="codex-type" class="text-sub mb-20"></div>
                <div id="codex-text" style="white-space:pre-wrap; margin-bottom:20px;"></div>
                <div id="codex-legality"></div>
                <button class="mt-20 secondary" onclick="document.getElementById('codex-modal').classList.add('hidden')">Close</button>
            </div>
        </div>
    </div>

    <div id="app" class="app-container hidden">
        <div class="sidebar">
            <div class="flex-row mb-20" style="font-weight:700; font-size:18px; color:var(--primary);">ü©∏ The Grimoire</div>
            <div class="nav-item active" onclick="nav('dashboard','dashboard')">üè† Dashboard</div>
            <div class="nav-item" onclick="nav('add','add')">‚ûï Add Card</div>
            <div class="nav-item" onclick="nav('collection','collection')">üìö Collection</div>
            <div class="nav-item" onclick="nav('decks','decks')">üìã Decks</div>
            <div style="flex:1;"></div>
            <button class="secondary" onclick="openUserOptionsModal()">üßô User</button>
        </div>

        <div class="main">
            <div id="view-dashboard">
                <div class="flex-between mb-20"><h2>Dashboard</h2><button class="secondary btn-sm" onclick="exportCSV()">CSV</button></div>
                <div class="stat-grid">
                    <div class="stat-card"><div class="stat-val" id="stat-count">0</div><div class="stat-lbl">Cards</div></div>
                    <div class="stat-card"><div class="stat-val" id="stat-value">$0</div><div class="stat-lbl">Value</div></div>
                    <div class="stat-card"><div class="stat-val" id="stat-cost">$0</div><div class="stat-lbl">Cost</div></div>
                </div>
                <h3>Recent</h3>
                <div id="recent-grid" class="collection-grid"></div>
            </div>

            <div id="view-add" class="hidden">
                <div class="card-box" style="max-width:500px; margin:0 auto;">
                    <h2>Add Card</h2>
                    <div class="input-group"><span class="input-icon">üîç</span><input id="search" placeholder="Name or SET 123" oninput="debounceSearch()"></div>
                    <div id="search-status" class="text-sub mb-20"></div>
                    <select id="versionSelect" onchange="updateSelectedVersion()" class="mb-20" style="padding-left:14px;"></select>
                    <div class="flex-row">
                        <input id="qty" type="number" value="1" placeholder="Qty">
                        <input id="cost" type="number" step="0.01" placeholder="Cost">
                    </div>
                    <input id="add-tags" placeholder="Tags (foil, trade)...">
                    <div class="flex-between mb-20 mt-20">
                        <span id="marketPrice" class="text-green text-bold">--</span>
                        <img id="preview" style="height:60px; border-radius:4px; display:none;">
                    </div>
                    <div class="flex-row">
                        <button onclick="addCard(this, false)">Add</button>
                        <button class="secondary" onclick="addCard(this, true)">Wishlist</button>
                    </div>
                </div>
            </div>

            <div id="view-collection" class="hidden">
                <div class="flex-between mb-20"><h2>Collection</h2><button class="secondary btn-sm" onclick="appraiseCollection(this)">Appraise</button></div>
                <input id="vaultSearch" placeholder="Search..." oninput="filterVault()">
                <div id="collection-grid" class="collection-grid mt-20"></div>
            </div>

            <div id="view-decks" class="hidden">
                <div id="deck-library">
                    <div class="flex-between mb-20"><h2>Decks</h2><button class="secondary btn-sm" onclick="showRitualEditor()">+ New</button></div>
                    <div id="deck-grid-container" class="deck-grid"></div>
                </div>
                
                <div id="deck-workspace" class="hidden">
                    <button class="secondary btn-sm mb-20" onclick="closeDeck()">‚Üê Back</button>
                    
                    <div id="editor-mode">
                        <div class="card-box">
                            <input id="deckName" placeholder="Deck Name">
                            <input id="deckCommander" placeholder="Commander">
                            <select id="deckFormat"><option value="Commander">Commander</option><option value="Casual">Casual</option></select>
                            <div class="flex-between mt-20 mb-10"><span class="text-sub text-bold">LIVE CURVE</span><span id="editor-card-count">0</span></div>
                            <div style="height:100px;"><canvas id="editorManaChart"></canvas></div>
                            <div class="editor-split mt-20">
                                <div class="editor-column"><span class="text-sub">Main</span><textarea id="deckMain"></textarea></div>
                                <div class="editor-column"><span class="text-sub">Side</span><textarea id="deckSide"></textarea></div>
                            </div>
                            <div class="flex-row mt-20"><button onclick="validateDeck(this)">Validate</button><button class="secondary" onclick="saveDeck(this)">Save</button></div>
                        </div>
                    </div>
                    
                    <div id="detail-mode" class="hidden deck-area-detail">
                        <div class="card-box">
                            <div class="flex-between">
                                <div>
                                    <h2 id="detail-deck-name"></h2>
                                    <div id="detail-commander" class="text-sub mb-20"></div>
                                </div>
                                <img id="detail-commander-img" style="width:80px; border-radius:6px;">
                            </div>
                            <div class="card-box" style="background:rgba(0,0,0,0.3);">
                                <div class="flex-between text-sub mb-5"><span>Owned: <b id="detail-owned-percent" class="text-white">0%</b></span><span class="text-red" id="detail-missing-cost">$0</span></div>
                                <div class="progress-bg"><div id="detail-owned-bar" class="progress-fill" style="width:0%"></div></div>
                                <div class="text-sub mt-5" style="text-align:right;" id="detail-total-value">Total: $0</div>
                            </div>
                            <div class="flex-row mb-20">
                                <button onclick="initBattlefield()">Play</button>
                                <button class="secondary" onclick="saveDeck(this)">Save</button>
                                <button class="secondary" onclick="handleDeckTool('copy_missing')">Copy Missing</button>
                            </div>
                            <div id="detail-visual-grid" class="visual-grid-container hidden"></div>
                            <div id="detail-decklist-viewer" class="deck-list-viewer"></div>
                        </div>
                        <div class="card-box">
                            <h3 id="detail-deck-price" class="text-green mb-20">$0.00</h3>
                            <button class="secondary w-full mb-20" onclick="openLandCalculator()">Geomancer</button>
                            <div id="deck-advisor"></div>
                            <div id="detail-analysis-results" class="text-sub mt-20"></div>
                            <div id="deck-charts" class="hidden"><canvas id="typeChart"></canvas><canvas id="manaCurve"></canvas><canvas id="colorChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="view-settings" class="hidden">
                <div class="card-box" style="max-width:500px;">
                    <h2>Settings</h2>
                    <input id="settings-username" placeholder="Username">
                    <button onclick="saveProfile(this)">Save</button>
                </div>
            </div>

            <div id="view-battlefield" class="hidden">
                <div class="bf-hud">
                    <button class="secondary btn-sm" onclick="exitBattlefield()">Exit</button>
                    <div class="bf-stat">Life: <span id="bf-life" class="text-white">20</span> <button class="btn-sm" onclick="updateLife(1)">+</button><button class="btn-sm" onclick="updateLife(-1)">-</button></div>
                    <button class="btn-sm" style="background:var(--red);" onclick="initBattlefield()">Reset</button>
                </div>
                <div class="bf-main">
                    <div id="bf-frontline" class="bf-row" ondrop="drop(event,'field')" ondragover="allowDrop(event)"></div>
                    <div id="bf-backline" class="bf-row" ondrop="drop(event,'field')" ondragover="allowDrop(event)"></div>
                </div>
                <div class="bf-hand-area">
                    <div class="bf-zone-btn" onclick="drawCard()">Lib <span id="bf-lib-count">0</span></div>
                    <div class="bf-zone-btn" ondrop="drop(event,'grave')" ondragover="allowDrop(event)">Grave <span id="bf-grave-count">0</span></div>
                    <div id="bf-hand" style="display:flex; gap:10px; overflow-x:auto; flex:1;" ondrop="drop(event,'hand')" ondragover="allowDrop(event)"></div>
                </div>
            </div>

        </div>
        
        <div class="bottom-nav">
            <div onclick="nav('dashboard','dashboard')">üè†</div>
            <div onclick="nav('add','add')">‚ûï</div>
            <div onclick="nav('decks','decks')">üìã</div>
        </div>
    </div>

    <script>
        // CONFIG
        const SUPABASE_URL="https://mdirqlntcxqkthbwubmj.supabase.co";
        const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1kaXJxbG50Y3hxa3RoYnd1Ym1qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2OTUyOTAsImV4cCI6MjA4MTI3MTI5MH0.XBhYZiwINycA-QjAH-cL4vFzzyppm1c4M322jNDmbvE";
        let sb; try { sb = supabase.createClient(SUPABASE_URL,SUPABASE_KEY); } catch(e){ alert("DB Error"); }

        // STATE
        let session, cardsCache=[], vaultLookup={}, searchTimer, tempCardData, allVersions=[], currentViewedDeckId;
        let typeChartInstance, manaCurveInstance, colorChartInstance, editorChartInstance;
        let currentDeckCache=[], currentDeckStructuredList=[], currentDeckCoverUrl='';
        let gameState={lib:[],hand:[],field:[],grave:[],exile:[],life:20,turn:1};
        const CHART_COLORS=['#a78bfa','#dc2626','#a78bfa','#4f46e5','#059669','#737373','#facc15'];
        let suggestedLands=[];

        // --- HELPERS ---
        function setLoading(btn, isLoading) { if(!btn) return; if(isLoading) btn.classList.add('btn-loading'); else btn.classList.remove('btn-loading'); }
        function showToast(msg) { let c=document.getElementById('toast-container'); let e=document.createElement('div'); e.className='toast'; e.innerHTML=`<span>${msg}</span>`; c.appendChild(e); setTimeout(()=>e.remove(),3000); }
        function getCardImage(c) {
            const set=c.set_code||c.set; const num=c.collector_number||c.num;
            if(!set||!num) return c.image_url||'';
            return c.image_url||`https://cards.scryfall.io/normal/front/${set[0]}/${set[1]}/${set}/${num}.jpg`;
        }
        function openUserOptionsModal() { document.getElementById('user-options-modal').classList.remove('hidden'); }
        function closeUserOptionsModal() { document.getElementById('user-options-modal').classList.add('hidden'); }
        
        // --- CHARTS (Defined Early) ---
        function clearCharts() { [typeChartInstance,manaCurveInstance,colorChartInstance,editorChartInstance].forEach(c=>{if(c)c.destroy()}); document.getElementById('deck-charts').classList.add('hidden'); }
        function renderTypeChart(d) { const ctx=document.getElementById('typeChart').getContext('2d'); typeChartInstance=new Chart(ctx,{type:'doughnut',data:{labels:Object.keys(d),datasets:[{data:Object.values(d),backgroundColor:CHART_COLORS,borderWidth:0}]},options:{plugins:{legend:{position:'right',labels:{color:'#888'}}}}}); }
        function renderManaCurve(d) { const ctx=document.getElementById('manaCurve').getContext('2d'); const l=['0','1','2','3','4','5','6','7+']; const v=l.map((_,i)=>d[i]||0); manaCurveInstance=new Chart(ctx,{type:'bar',data:{labels:l,datasets:[{data:v,backgroundColor:'#a78bfa'}]},options:{scales:{x:{ticks:{color:'#888'}},y:{ticks:{color:'#888'}}},plugins:{legend:{display:false}}}}); }
        function renderColorChart(c) { const ctx=document.getElementById('colorChart').getContext('2d'); colorChartInstance=new Chart(ctx,{type:'polarArea',data:{labels:['W','U','B','R','G','C'],datasets:[{data:[c.W,c.U,c.B,c.R,c.G,c.C],backgroundColor:['#fff4bd','#b3ceea','#a69f9d','#ea9f82','#c4d3ca','#ccc']}]},options:{scales:{r:{ticks:{display:false},grid:{color:'#333'}}}}}); }
        function renderEditorChart(d) { const ctx=document.getElementById('editorManaChart').getContext('2d'); if(editorChartInstance)editorChartInstance.destroy(); editorChartInstance=new Chart(ctx,{type:'bar',data:{labels:['0','1','2','3','4','5','6','7+'],datasets:[{data:Object.values(d),backgroundColor:'#3b82f6',borderRadius:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#888',font:{size:9}},grid:{display:false}},y:{display:false}}}}); }

        // --- CORE ---
        function nav(v){ 
            document.querySelectorAll('.main > div').forEach(d=>d.classList.add('hidden')); 
            const view=document.getElementById('view-'+v); if(view) view.classList.remove('hidden');
            if(v==='decks') loadDecks(); 
            else { document.getElementById('deck-workspace').classList.add('hidden'); document.getElementById('deck-library').classList.remove('hidden'); showRitualEditor(false); }
            if(v==='collection') filterVault();
            if(v==='oracle') loadOracle();
        }

        async function loadData() {
            try {
                const { data, error } = await sb.from('cards').select('*').order('created_at',{ascending:false});
                if(error) throw error;
                cardsCache = data; vaultLookup = {};
                let count=0, val=0, cost=0;
                cardsCache.forEach(c => {
                    const key = `${c.name.toLowerCase().trim()}_${c.set_code}_${c.collector_number}`;
                    vaultLookup[key] = (vaultLookup[key]||0) + c.quantity;
                    if(c.quantity>0) { count+=c.quantity; val+=(c.market_price_usd||0)*c.quantity; cost+=(c.buy_price||0)*c.quantity; }
                });
                document.getElementById('stat-count').innerText = count;
                document.getElementById('stat-value').innerText = "$"+val.toFixed(2);
                document.getElementById('stat-cost').innerText = "$"+cost.toFixed(2);
                
                const recent = cardsCache.filter(c=>c.quantity>0).slice(0,5);
                document.getElementById('recent-grid').innerHTML = recent.map(c=>`<div class="grid-card animate-in" onclick="openCodex('${c.set_code}','${c.collector_number}')"><img src="${getCardImage(c)}" loading="lazy"></div>`).join('');
            } catch(e) { console.error(e); showToast("Load Error"); }
        }

        // --- SEARCH FIX (Complex) ---
        function debounceSearch(){ clearTimeout(searchTimer); searchTimer=setTimeout(fetchMeta,500); }
        async function fetchMeta() {
            const q = document.getElementById('search').value.trim(); if(q.length<3) return;
            document.getElementById('search-status').innerText = "Searching...";
            let url = `https://api.scryfall.com/cards/search?q=${encodeURIComponent(q)}&unique=prints`;
            const match = q.match(/^([a-z]{3,4})\s*(\d+)$/i);
            if(match) url = `https://api.scryfall.com/cards/${match[1]}/${match[2]}`;

            try {
                const res = await fetch(url); const d = await res.json();
                if(d.object==='error') { document.getElementById('search-status').innerText = "Not Found"; allVersions=[]; return; }
                allVersions = d.object==='list' ? d.data : [d];
                document.getElementById('search-status').innerText = `${allVersions.length} versions`;
                const s=document.getElementById('versionSelect'); s.innerHTML='';
                allVersions.forEach((v,i) => { const o=document.createElement('option'); o.value=i; o.text=`${v.set_name} ($${v.prices.usd||'0'})`; s.appendChild(o); });
                updateSelectedVersion();
            } catch(e) { document.getElementById('search-status').innerText="Error"; }
        }
        
        function updateSelectedVersion() {
            const v = allVersions[document.getElementById('versionSelect').value]; if(!v) return;
            document.getElementById('marketPrice').innerText = `$${v.prices.usd||'0.00'}`;
            document.getElementById('preview').src = getCardImage(v); document.getElementById('preview').style.display='block';
            tempCardData = v;
        }

        async function addCard(btn, isWishlist) {
            if(!tempCardData) return showToast("Select Card");
            setLoading(btn, true);
            const qty = isWishlist ? 0 : (parseInt(document.getElementById('qty').value)||1);
            const cost = parseFloat(document.getElementById('cost').value)||null;
            const tags = document.getElementById('add-tags').value.split(',').filter(s=>s);
            
            await sb.from('cards').insert({
                user_id:session.user.id, name:tempCardData.name, set_code:tempCardData.set.toUpperCase(), 
                collector_number:tempCardData.collector_number, image_url:getCardImage(tempCardData),
                quantity:qty, buy_price:cost, market_price_usd:parseFloat(tempCardData.prices.usd||0),
                tags:tags, type_line:tempCardData.type_line, rarity:tempCardData.rarity, 
                colors:tempCardData.colors, cmc:tempCardData.cmc||0
            });
            setLoading(btn, false);
            showToast(isWishlist ? "Wishlisted" : "Added"); loadData();
        }

        // --- DECK ENGINE (RESTORED V9.0 LOGIC) ---
        async function loadDecks() {
            const { data } = await sb.from('decks').select('*').order('updated_at', {ascending:false});
            window.myDecks = data||[];
            document.getElementById('deck-grid-container').innerHTML = window.myDecks.map(d => 
                `<div class="deck-card animate-in" onclick="viewRitualDetails('${d.id}')" style="background-image:url('${d.cover_url}')">
                    <div class="deck-card-content"><h4>${d.name}</h4><div class="deck-card-meta"><span>${d.card_count} Cards</span><span class="format-badge">${d.format}</span></div></div>
                </div>`
            ).join('');
        }

        async function validateDeck(btn) {
            const main = document.getElementById('deckMain').value;
            if(!main.trim()) return showToast("Deck empty");
            setLoading(btn, true);
            
            // Cached path
            if(window.currentDeckStructuredList && window.currentDeckStructuredList.length > 0) {
                processDeckData(window.currentDeckStructuredList); setLoading(btn,false); return;
            }

            // Heavy Logic: Batch Scryfall
            const lines = main.split('\n').filter(l=>l.trim());
            // Extract names (simplified regex for stability)
            const reqs = lines.map(l=>{ const m=l.match(/^(\d+)\s+(.+)/); return m ? {name:m[2], qty:parseInt(m[1])} : null }).filter(x=>x);
            
            let matched = [];
            const chunks = []; for(let i=0; i<reqs.length; i+=75) chunks.push(reqs.slice(i, i+75));
            
            try {
                for(const chunk of chunks) {
                    const res = await fetch('https://api.scryfall.com/cards/collection', {
                        method:'POST', headers:{'Content-Type':'application/json'},
                        body:JSON.stringify({identifiers: chunk.map(c=>({name:c.name}))})
                    });
                    const d = await res.json();
                    if(d.data) matched = matched.concat(d.data);
                }
                
                // Merge Qty back in
                const structured = matched.map(card => {
                    const req = reqs.find(r => r.name.toLowerCase() === card.name.toLowerCase());
                    return {
                        name: card.name, qty: req?req.qty:1, set: card.set, num: card.collector_number,
                        img: getCardImage(card), type: card.type_line, cmc: card.cmc, 
                        price: parseFloat(card.prices.usd||0), identity: card.color_identity,
                        oracle_text: card.oracle_text, mana_cost: card.mana_cost
                    };
                });
                
                window.currentDeckStructuredList = structured;
                processDeckData(structured);
            } catch(e) { console.error(e); showToast("Validation Failed"); }
            finally { setLoading(btn, false); }
        }

        function processDeckData(data) {
            // Stats
            let totalVal=0, types={}, cmcs={}, colors={W:0,U:0,B:0,R:0,G:0,C:0};
            data.forEach(c => {
                totalVal += c.price * c.qty;
                const type = c.type.split('‚Äî')[0].trim();
                types[type] = (types[type]||0) + c.qty;
                if(!type.includes('Land')) { let b=Math.floor(c.cmc||0); if(b>7)b=7; cmcs[b]=(cmcs[b]||0)+c.qty; }
                if(c.mana_cost) {
                    colors.W += (c.mana_cost.match(/{W}/g)||[]).length * c.qty;
                    colors.U += (c.mana_cost.match(/{U}/g)||[]).length * c.qty;
                    colors.B += (c.mana_cost.match(/{B}/g)||[]).length * c.qty;
                    colors.R += (c.mana_cost.match(/{R}/g)||[]).length * c.qty;
                    colors.G += (c.mana_cost.match(/{G}/g)||[]).length * c.qty;
                }
            });

            // Advisor Heuristics
            const stats = { lands:{count:0,target:36}, ramp:{count:0,target:10}, draw:{count:0,target:10}, removal:{count:0,target:10}, wipes:{count:0,target:3} };
            data.forEach(c => {
                const t=(c.oracle_text||"").toLowerCase(), ty=(c.type||"").toLowerCase(), q=c.qty;
                if(ty.includes('land')) { stats.lands.count+=q; return; }
                if((t.includes('add') && t.includes('mana')) || (t.includes('search') && t.includes('land'))) stats.ramp.count+=q;
                if(t.includes('draw') && t.includes('card')) stats.draw.count+=q;
                if((t.includes('destroy')||t.includes('exile')) && t.includes('target')) stats.removal.count+=q;
                if((t.includes('destroy')||t.includes('exile')) && t.includes('all')) stats.wipes.count+=q;
            });
            let advHtml = "";
            for(const [k,d] of Object.entries(stats)) {
                let col = 'var(--red)'; if(d.count/d.target > 0.8) col='var(--green)';
                advHtml += `<div class="mb-5 flex-between text-sub" style="font-size:10px;"><span style="text-transform:capitalize">${k}</span><span>${d.count}/${d.target}</span></div><div class="progress-bg"><div class="progress-fill" style="width:${Math.min(100, (d.count/d.target)*100)}%; background:${col}"></div></div>`;
            }
            
            // Ownership (Accountant)
            let ownedVal=0, missingVal=0, ownedCount=0, totalCount=0;
            const listHtml = data.map(c => {
                const key = `${c.name.toLowerCase().trim()}_${c.set}_${c.num}`;
                const have = vaultLookup[key] || 0;
                // Basic land bypass
                const isBasic = ['plains','island','swamp','mountain','forest'].some(x=>c.name.toLowerCase().includes(x));
                const effectiveHave = isBasic ? c.qty : have;
                
                const match = Math.min(effectiveHave, c.qty);
                const missing = c.qty - match;
                
                ownedCount += match; totalCount += c.qty;
                ownedVal += (match * c.price); missingVal += (missing * c.price);
                
                const status = match >= c.qty ? 'is-owned' : (match > 0 ? 'is-partial' : 'is-missing');
                return `<div class="deck-line ${status}" data-name="${c.name}" data-qty="${missing}"><b>${c.qty}</b> ${c.name} <span style="float:right; opacity:0.6;">$${c.price.toFixed(2)} (${effectiveHave}/${c.qty})</span></div>`;
            }).join('');

            const pct = Math.round((ownedCount/totalCount)*100);
            
            // UI Updates
            document.getElementById('editor-mode').classList.add('hidden');
            document.getElementById('detail-mode').classList.remove('hidden');
            document.getElementById('detail-deck-name').innerText = document.getElementById('deckName').value;
            document.getElementById('detail-deck-price').innerText = "$"+totalVal.toFixed(2);
            document.getElementById('detail-missing-cost').innerText = "$"+missingVal.toFixed(2);
            document.getElementById('detail-owned-percent').innerText = pct+"%";
            document.getElementById('detail-owned-bar').style.width = pct+"%";
            document.getElementById('advisor-grid').innerHTML = advHtml;
            document.getElementById('detail-decklist-viewer').innerHTML = listHtml;
            document.getElementById('deck-charts').classList.remove('hidden');
            
            renderTypeChart(types); renderManaCurve(cmcs); renderColorChart(colors);
            currentDeckCache = data; // For battlefield
        }

        async function saveDeck(btn) {
            setLoading(btn, true);
            const name = document.getElementById('deckName').value;
            const main = document.getElementById('deckMain').value;
            try {
                const payload = {
                    user_id:session.user.id, name:name, card_list:main, 
                    format:document.getElementById('deckFormat').value,
                    cover_url: currentDeckCache[0]?.img || '',
                    structured_list: window.currentDeckStructuredList
                };
                
                if(currentViewedDeckId) await sb.from('decks').update(payload).eq('id', currentViewedDeckId);
                else await sb.from('decks').insert(payload);
                
                showToast("Saved!", "success"); loadDecks();
            } catch(e){ showToast("Error Saving", "error"); } finally { setLoading(btn, false); }
        }

        // --- AUTH ---
        async function handleAuthAction(btn){ 
            setLoading(btn, true);
            const e=document.getElementById('email').value, p=document.getElementById('password').value;
            const { data, error } = await sb.auth.signInWithPassword({email:e,password:p});
            if(error) {
                const sup = await sb.auth.signUp({email:e,password:p});
                if(sup.data.session) finalizeLogin(sup.data.session); else showToast("Check email to confirm signup.", "success");
            } else finalizeLogin(data.session);
            setLoading(btn, false);
        }
        function finalizeLogin(s){ session=s; document.getElementById('auth-screen').classList.add('hidden'); document.getElementById('app').classList.remove('hidden'); document.getElementById('user-email').innerText=s.user.email; loadData(); }
        async function handleLogout(){ await sb.auth.signOut(); window.location.reload(); }

        // --- OTHERS ---
        function filterVault() {
            const q = document.getElementById('vaultSearch').value.toLowerCase();
            const f = cardsCache.filter(c => c.quantity>0 && c.name.toLowerCase().includes(q));
            document.getElementById('collection-grid').innerHTML = f.map(c => `<div class="grid-card animate-in" onclick="openCodex('${c.set_code}','${c.collector_number}')"><img src="${getCardImage(c)}" loading="lazy"></div>`).join('');
        }
        function loadOracle() {
            const f = cardsCache.filter(c => c.quantity===0);
            document.getElementById('oracle-grid').innerHTML = f.map(c => `<div class="grid-card"><img src="${getCardImage(c)}"></div>`).join('');
        }
        function showRitualEditor(keep) { 
            document.getElementById('deck-library').classList.add('hidden'); 
            document.getElementById('deck-workspace').classList.remove('hidden'); 
            document.getElementById('detail-mode').classList.add('hidden'); 
            document.getElementById('editor-mode').classList.remove('hidden');
            if(!keep) { document.getElementById('deckName').value=''; document.getElementById('deckMain').value=''; window.currentDeckStructuredList=null; }
            initEditorListeners();
        }
        function initEditorListeners() { document.getElementById('deckMain').addEventListener('input', () => setTimeout(updateLiveEditorStats, 500)); }
        function updateLiveEditorStats() {
            const txt = document.getElementById('deckMain').value; const lines = txt.split('\n');
            const data = {0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0}; let total=0;
            lines.forEach(l => { const m = l.match(/^(\d+)\s+(.+)/); if(m) { total+=parseInt(m[1]); } }); // Simple count
            document.getElementById('editor-card-count').innerText = total; // Full chart logic in validate
        }
        function closeDeck() { document.getElementById('deck-workspace').classList.add('hidden'); document.getElementById('deck-library').classList.remove('hidden'); }
        function clearDeckEditor() { document.getElementById('deckMain').value = ''; }
        function viewRitualDetails(id) { 
            const d = window.myDecks.find(x => x.id == id);
            currentViewedDeckId = id;
            document.getElementById('deckName').value = d.name;
            document.getElementById('deckMain').value = d.card_list;
            window.currentDeckStructuredList = d.structured_list;
            validateDeck(); // Re-run validation logic to populate UI
        }
        function openCodex(set, num) {
            document.getElementById('codex-modal').classList.remove('hidden');
            fetch(`https://api.scryfall.com/cards/${set}/${num}`).then(r=>r.json()).then(d=>{
                document.getElementById('codex-img').src=getCardImage(d);
                document.getElementById('codex-title').innerText=d.name;
                document.getElementById('codex-type').innerText=d.type_line;
                document.getElementById('codex-text').innerText=d.oracle_text;
                let h=''; if(d.legalities) for(const[k,v] of Object.entries(d.legalities)) if(['standard','commander'].includes(k)) h+=`<div>${k}: ${v}</div>`;
                document.getElementById('codex-legality').innerHTML=h;
                window.scryfallLink=d.scryfall_uri;
            })
        }
        // Battlefield logic (Simulated for brevity in this monolith, full features in prev versions)
        function initBattlefield() { 
            document.getElementById('view-decks').classList.add('hidden'); document.getElementById('view-battlefield').classList.remove('hidden');
            gameState.lib = [...currentDeckCache]; // Simple Copy
            renderBF();
        }
        function renderBF() { 
            document.getElementById('bf-lib-count').innerText = gameState.lib.length;
            document.getElementById('bf-hand').innerHTML = gameState.hand.map(c=>`<div class="bf-card"><img src="${getCardImage(c)}"></div>`).join('');
        }
        function drawCard() { if(gameState.lib.length) gameState.hand.push(gameState.lib.pop()); renderBF(); }
        function exitBattlefield() { document.getElementById('view-battlefield').classList.add('hidden'); document.getElementById('view-decks').classList.remove('hidden'); }
        function allowDrop(e) { e.preventDefault(); }
        function drop(e, zone) { e.preventDefault(); }
        function openLandCalculator() { document.getElementById('land-modal').classList.remove('hidden'); }
        function copyMissing() {
            const text = Array.from(document.querySelectorAll('.is-missing')).map(el => {
                return `${el.dataset.qty} ${el.dataset.name}`;
            }).join('\n');
            navigator.clipboard.writeText(text); showToast("Copied!");
        }

        // --- INIT ---
        sb.auth.getSession().then(({ data: { session: s } }) => { if(s) finalizeLogin(s); });
    </script>
</body>
</html>

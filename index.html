<!DOCTYPE html>
<html>
<head>
<base target="_top">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MTG Manager (Hybrid)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root { --primary: #6200ea; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --green: #10b981; --red: #ef4444; --border: #e2e8f0; }
  body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); }
  .container { max-width: 900px; margin: 0 auto; }
  
  /* TABS */
  .tabs { display: flex; background: var(--card); padding: 5px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
  .tab { flex: 1; text-align: center; padding: 12px; cursor: pointer; border-radius: 8px; font-weight: 600; color: #64748b; transition: 0.2s; }
  .tab.active { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(98, 0, 234, 0.3); }
  .view { display: none; } .view.active { display: block; }

  /* CARDS */
  .card-box { background: var(--card); padding: 24px; border-radius: 16px; margin-bottom: 20px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
  .main-grid { display: grid; grid-template-columns: 1fr 300px; gap: 30px; }
  @media (max-width: 700px) { .main-grid { grid-template-columns: 1fr; } }

  /* INPUTS */
  .input-group { margin-bottom: 16px; }
  label { display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; margin-bottom: 6px; color: #64748b; letter-spacing: 0.5px; }
  input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; box-sizing: border-box; background: #fff; font-family: 'Inter', sans-serif; }
  input:focus, select:focus, textarea:focus { outline: 2px solid var(--primary); border-color: transparent; }
  textarea { resize: vertical; min-height: 150px; }

  /* BUTTONS */
  .btn-primary { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 15px; }
  .btn-primary:active { transform: translateY(1px); }
  .action-row { display: flex; gap: 10px; margin-bottom: 15px; }
  .action-btn { flex: 1; padding: 10px; border-radius: 8px; cursor: pointer; border: 1px solid var(--border); background: white; font-weight: 600; color: #475569; font-size: 13px; text-align: center; }
  .action-btn:hover { background: #f8fafc; }
  .view-toggle-btn { background: #fff; border: 1px solid var(--border); padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; color: #64748b; margin-left: 10px; }

  /* TOGGLES */
  .finish-toggle { display: flex; background: #f1f5f9; border-radius: 8px; padding: 3px; border: 1px solid var(--border); }
  .finish-option { flex: 1; text-align: center; }
  .finish-option input { display: none; }
  .finish-label { display: block; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; color: #64748b; transition: all 0.2s; }
  .finish-option input:checked + .finish-label { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(98, 0, 234, 0.3); }
  .finish-option input[value="true"]:checked + .finish-label { color: #9333ea; }

  /* LIST VIEW */
  .list-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
  .list-item img { width: 40px; height: 56px; border-radius: 4px; margin-right: 12px; object-fit: cover; border: 1px solid #eee; }
  .list-details { flex-grow: 1; min-width: 0; }
  .list-name { font-weight: 600; font-size: 14px; color: #0f172a; }
  .list-meta { font-size: 11px; color: #64748b; margin-top: 2px; }
  .list-value { font-weight: 700; color: #059669; text-align: right; min-width: 70px; font-size: 14px; }
  .delete-btn { padding: 4px 8px; margin-left: 10px; background: #fee2e2; border-radius: 6px; color: #dc2626; border: none; cursor: pointer; font-size: 12px; }

  /* GRID VIEW */
  .collection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
  .grid-card { position: relative; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s; background: #000; aspect-ratio: 2.5/3.5; }
  .grid-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px rgba(0,0,0,0.15); }
  .grid-card img { width: 100%; height: 100%; object-fit: cover; display: block; }
  .grid-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.9), rgba(0,0,0,0)); padding: 10px; color: white; transform: translateY(100%); transition: transform 0.2s; display: flex; flex-direction: column; }
  .grid-card:hover .grid-overlay { transform: translateY(0); }
  .grid-price { font-weight: 700; color: #4ade80; font-size: 14px; }
  .grid-meta { font-size: 10px; color: #cbd5e1; display:flex; justify-content:space-between; }
  .grid-del { position: absolute; top: 5px; right: 5px; background: rgba(220, 38, 38, 0.8); color: white; border: none; border-radius: 4px; padding: 2px 6px; cursor: pointer; display: none; font-size: 10px; }
  .grid-card:hover .grid-del { display: block; }

  /* DECK CHECK VISUALS */
  .deck-dashboard { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
  .progress-container { background: #f1f5f9; border-radius: 10px; height: 20px; width: 100%; margin: 15px 0; overflow: hidden; }
  .progress-bar { height: 100%; background: linear-gradient(90deg, #10b981, #059669); width: 0%; transition: width 1s ease-in-out; }
  .dash-stats { display: flex; justify-content: space-between; font-size: 14px; color: #475569; font-weight: 600; }
  .copy-btn { background: #fff; border: 1px solid #cbd5e1; padding: 5px 10px; border-radius: 6px; font-size: 12px; cursor: pointer; color: #334155; }
  .copy-btn:hover { background: #f8fafc; border-color: #94a3b8; }
  
  .deck-section-title { font-size: 16px; font-weight: 700; margin: 30px 0 15px 0; padding-bottom: 5px; border-bottom: 2px solid #e2e8f0; }
  /* Missing Card Specifics */
  .missing-card { filter: grayscale(100%); opacity: 0.8; }
  .missing-card:hover { filter: grayscale(0%); opacity: 1; }
  .missing-badge-overlay { position: absolute; top: 5px; left: 5px; background: #ef4444; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; }

  /* SEARCH & STATS */
  #suggestions { position: absolute; background: white; width: 100%; border: 1px solid #e2e8f0; z-index: 99; max-height: 200px; overflow-y: auto; display: none; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-top: 4px; }
  .s-item { padding: 10px 12px; cursor: pointer; font-size: 14px; border-bottom: 1px solid #f1f5f9; }
  .s-item:hover { background: #f8fafc; color: var(--primary); }
  #cardPreview { width: 100%; height: auto; border-radius: 12px; display:none; border: 1px solid var(--border); }
  .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
  .stat-card { background: #f8fafc; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid var(--border); }
  .stat-num { font-size: 20px; font-weight: 800; color: var(--primary); }
  .stat-label { font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; }
  .top-card-row { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 13px; }

  /* CHARTS */
  .chart-container { position: relative; height: 250px; width: 100%; margin-bottom: 30px; }

  /* FOOTER STYLES */
  #version-footer { 
      font-size: 10px; 
      color: #94a3b8; 
      text-align: right; 
      margin-top: 15px; 
      padding-top: 10px;
      border-top: 1px solid #e2e8f0;
  }

</style>
</head>
<body>

<div class="container">
  <div class="tabs">
    <div class="tab active" onclick="nav('add')">Add Cards</div>
    <div class="tab" onclick="nav('collection')">My Collection</div>
    <div class="tab" onclick="nav('deckcheck')">Deck Check</div>
    <div class="tab" onclick="nav('analytics')">Analytics</div>
  </div>

  <div id="view-add" class="view active">
    <div class="main-grid">
      <div class="card-box">
        <h3>Add New Card</h3>
        <div class="input-group">
          <label>Card Name</label>
          <div style="display:flex; gap:5px; align-items:center;">
            <input type="text" id="search" placeholder="Start typing (e.g. Sol Ring)..." autocomplete="off" style="flex-grow:1;">
            <button type="button" class="action-btn" style="flex:0 0 40px; padding: 12px 0; font-size: 14px;" onclick="copyCardName()" id="copyNameBtn" disabled>üìã</button>
          </div>
          <div id="suggestions"></div>
        </div>
        <div class="input-group" id="verGrp" style="display:none;">
          <label>Version</label><select id="versionSelect" onchange="updateUI()"></select>
        </div>
        <form id="addForm" onsubmit="event.preventDefault(); submitForm(this)">
          <div style="display:flex; gap:10px;">
             <div class="input-group" style="flex:1"><label>Set</label><input name="setCode" id="setCode" readonly style="background:#f1f5f9;color:#64748b;"></div>
             <div class="input-group" style="flex:1"><label>#</label><input name="colNum" id="colNum" readonly style="background:#f1f5f9;color:#64748b;"></div>
          </div>
          <div class="input-group">
            <label>Finish</label>
            <div class="finish-toggle">
              <div class="finish-option"><input type="radio" id="foil-off" name="isFoil" value="false" checked onchange="calculateTotalValue(); saveFinishSetting();"><label for="foil-off" class="finish-label">Normal</label></div>
              <div class="finish-option"><input type="radio" id="foil-on" name="isFoil" value="true" onchange="calculateTotalValue(); saveFinishSetting();"><label for="foil-on" class="finish-label">Foil ‚ú®</label></div>
            </div>
          </div>
          <div class="input-group"><label>Currency</label><select id="currencySelect" onchange="updateUI()"><option value="CAD" selected>üá®üá¶ CAD (C$)</option><option value="USD">üá∫üá∏ USD ($)</option><option value="EUR">üá™üá∫ EUR (‚Ç¨)</option></select></div>
          
          <div class="input-group">
            <label for="locationInput">Location</label>
            <input list="locationOptions" id="locationInput" name="cardLocation" placeholder="Select or type new location">
            <datalist id="locationOptions">
              </datalist>
          </div>
          <div class="input-group">
            <label>Quantity</label>
            <div style="display:flex; gap:5px; align-items:center;">
              <input type="number" name="quantity" id="quantityInput" value="1" min="1" oninput="calculateTotalValue()" style="flex-grow:1;">
              
              <button type="button" class="action-btn" style="flex:0 0 30px; padding: 12px 0;" onclick="setQuantity(1)">C</button>
              <button type="button" class="action-btn" style="flex:0 0 35px; padding: 12px 0;" onclick="setQuantity(4)">4x</button>
              <button type="button" class="action-btn" style="flex:0 0 35px; padding: 12px 0;" onclick="setQuantity(10)">10x</button>
            </div>
          </div>
          <input type="hidden" name="cardName" id="cardNameInput"><input type="hidden" name="cardPrice" id="cardPriceInput"> 
          <div style="margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;"><span style="font-size:12px; font-weight:700; color:#64748b;">TOTAL VALUE</span><span id="totalValue" style="font-size:18px; font-weight:800; color:#0f172a;">$0.00</span></div>
          <button class="btn-primary" id="subBtn">Add to Collection</button>
        </form>
      </div>
      <div class="card-box" style="text-align:center;">
           <div style="font-size:11px; font-weight:bold; color:#64748b; margin-bottom:5px; text-transform:uppercase;">Market Price</div>
           <div id="bigPrice" style="font-size:28px; font-weight:800; color:#059669; margin-bottom:15px;">--</div>
           <img id="cardPreview" src="">
      </div>
    </div>
  </div>

  <div id="view-collection" class="view">
    <div class="card-box" style="background:#f8fafc; border:1px dashed #cbd5e1;">
        <h3 style="font-size:16px;">üì• Bulk Import (Disabled)</h3>
        <p style="font-size:12px; color:#64748b; margin-bottom:10px;">Bulk Import functionality requires the PapaParse library, which is not supported by the simplified Apps Script API.</p>
        <form id="importForm" onsubmit="alert('Bulk Import is disabled in Hybrid Mode.'); return false;"><div style="display:flex; gap:10px;">
            <input type="file" name="csvFile" id="csvFile" accept=".csv" style="flex:1; font-size:12px;" disabled>
            <button type="submit" id="importButton" class="action-btn" style="flex:0 0 auto;" disabled>Import CSV</button>
        </div></form>
    </div>
    <div class="card-box">
      <div style="display:flex; gap:10px; margin-bottom:15px;">
        <input type="text" id="collectionSearch" placeholder="Filter by Name/Set..." oninput="filterCollection()" style="flex:1;">
        <select id="locationFilter" onchange="filterCollection()" style="flex:1;">
            <option value="">All Locations</option>
            </select>
        <button id="viewToggle" class="view-toggle-btn" onclick="toggleViewMode()">Show Grid ‚ñ¶</button>
      </div>
      <div class="action-row"><button class="action-btn" onclick="updatePrices(this)">üîÑ Update Prices</button><button class="action-btn" onclick="exportCSV(this)" disabled>‚¨áÔ∏è Export CSV</button></div>
      <div id="collectionList">Loading...</div>
    </div>
  </div>

  <div id="view-deckcheck" class="view">
    <div class="main-grid">
      <div class="card-box">
         <h3>üìã Deck Check</h3>
         <p style="font-size:12px; color:#64748b;">Paste your decklist (e.g. "1 Sol Ring [C19]"). We'll check what you own.</p>
         <div class="input-group">
            <textarea id="deckInput" placeholder="1 Sol Ring [C19]&#10;1 Command Tower&#10;4 Brainstorm [2XM]..."></textarea>
         </div>
         <button class="btn-primary" onclick="runDeckCheck(this)">Check Deck</button>
      </div>
      <div class="card-box">
         <div id="deckResults">
            <div style="text-align:center; color:#94a3b8; padding:20px;">Results will appear here...</div>
         </div>
      </div>
    </div>
  </div>

  <div id="view-analytics" class="view">
    <div class="card-box">
      <div class="stat-grid">
        <div class="stat-card"><div class="stat-num" id="stat-count">0</div><div class="stat-label">Total Cards</div></div>
        <div class="stat-card"><div class="stat-num" id="stat-value">$0.00</div><div class="stat-label">Total Value</div></div>
      </div>
      
      <h3 style="margin-top:20px;">Color Distribution</h3>
      <div class="chart-container">
          <canvas id="colorChart"></canvas>
      </div>
      
      <h3 style="margin-top:20px;">Rarity Breakdown</h3>
      <div class="chart-container">
          <canvas id="rarityChart"></canvas>
      </div>

    </div>
    <div class="card-box"><h3>Daily Movers</h3><div id="moversList"></div></div>
    <div class="card-box"><h3>Top Cards</h3><div id="topCardsList"></div></div>
  </div>

  <div id="version-footer"></div>

</div>

<script>
// --- VERSION INFO ---
const APP_VERSION_HTML = "V1.5 (Connection Fix)";
const APP_VERSION_GS = "V36.0 (Robust API)";
// --- END VERSION INFO ---

// --- CRITICAL: YOUR API ENDPOINT ---
// Pre-filled with your working URL
const API_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwd77Efgh_YW6NAsK54LI9CmQLdzBzV2FlylHBTgRKApElhCuT0GKJpUZIASNewmCNrSw/exec';
// --- END CRITICAL SETUP ---

let rawCollectionData = [], currentCardData = null, debounceTimer;
let viewMode = 'list';
let charts = { color: null, rarity: null }; // Store chart instances

/**
 * Universal API Caller Function (using modern fetch)
 * FIXED: Sends Action in BOTH URL and BODY to ensure connection.
 */
async function callAPI(action, data = {}) {
    if (!API_ENDPOINT.includes('script.google.com')) {
        alert("CRITICAL ERROR: API Endpoint is invalid.");
        return { success: false, error: "API Endpoint not configured." };
    }
    
    // BELT AND SUSPENDERS: Send action in BOTH spots
    // 1. In the URL (The Belt)
    const separator = API_ENDPOINT.includes('?') ? '&' : '?';
    const url = `${API_ENDPOINT}${separator}action=${action}`;
    
    // 2. In the Body (The Suspenders)
    const payload = { ...data, action: action };
    
    try {
        const response = await fetch(url, {
            method: 'POST',
            mode: 'cors',
            headers: {
                'Content-Type': 'text/plain',
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const text = await response.text();
        const apiResponse = JSON.parse(text);

        if (apiResponse.success === false) {
            alert(`Server Error in ${action}: ${apiResponse.error}`);
            console.error(`Server Error in ${action}:`, apiResponse.error);
        }
        
        return apiResponse;

    } catch (error) {
        console.error(`Fetch error for ${action}:`, error);
        return { success: false, error: error.message };
    }
}


function init() {
    loadFinishSetting();
    loadLocations(); 
    calculateTotalValue();
    document.getElementById('version-footer').innerHTML = `HTML: ${APP_VERSION_HTML} | GS: ${APP_VERSION_GS}`;
}


function nav(t) {
  document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
  document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
  document.querySelector(`.tab[onclick="nav('${t}')"]`).classList.add('active');
  document.getElementById(`view-${t}`).classList.add('active');
  if(t==='collection') loadCollection();
  if(t==='analytics') loadAnalytics();
}


function copyCardName() {
    const name = document.getElementById('search').value;
    if (name) {
        navigator.clipboard.writeText(name).then(() => {
            alert(`Copied "${name}" to clipboard.`);
        }).catch(err => {
            console.error('Failed to copy text: ', err);
            alert('Copy failed. Please copy the text manually.');
        });
    }
}


function saveFinishSetting() {
    const isFoil = document.getElementById('foil-on').checked;
    localStorage.setItem('mtgManager_LastFinish', isFoil ? 'Foil' : 'Normal');
}

function loadFinishSetting() {
    const lastFinish = localStorage.getItem('mtgManager_LastFinish');
    if (lastFinish) { 
        document.getElementById('foil-on').checked = true;
    } else {
        document.getElementById('foil-off').checked = true;
    }
}


// --- API Rewrites ---

async function loadLocations() {
    const response = await callAPI('getUniqueLocations');
    if (response.success) {
      populateLocationDatalist(response.data);
    }
}

function populateLocationDatalist(locations) {
  const datalist = document.getElementById('locationOptions');
  datalist.innerHTML = ''; 
  locations.forEach(loc => {
    const option = document.createElement('option');
    option.value = loc;
    datalist.appendChild(option);
  });
}


function populateCollectionFilter(locations) {
    const selector = document.getElementById('locationFilter');
    selector.innerHTML = '<option value="">All Locations</option>';

    locations.forEach(loc => {
        if (loc && loc.trim() !== "") {
            const option = document.createElement('option');
            option.value = loc;
            option.text = loc;
            selector.appendChild(option);
        }
    });
}


function setQuantity(amount) {
    const qtyInput = document.getElementById('quantityInput');
    qtyInput.value = amount;
    calculateTotalValue();
}


async function runDeckCheck(btn) {
    const text = document.getElementById('deckInput').value;
    if(!text) return;
    btn.disabled = true;
    btn.innerText = "Checking...";
    
    const response = await callAPI('checkDeckList', { deckText: text });

    btn.disabled = false;
    btn.innerText = "Check Deck";

    if (response.success) {
        renderDeckCheck(response.data);
    }
}


function renderDeckCheck(res) {
    const div = document.getElementById('deckResults');
    div.innerHTML = '';

    const totalReq = res.found.length + res.missing.length;
    if (totalReq === 0) {
        div.innerHTML = "<div style='text-align:center; padding:20px; color:#94a3b8;'>No cards found.</div>";
        return;
    }

    const percentage = Math.round((res.found.length / totalReq) * 100);
    
    // DASHBOARD
    div.innerHTML += `
    <div class="deck-dashboard">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0; font-size:18px;">Deck Status: ${percentage}% Complete</h3>
            <button class="copy-btn" onclick="copyMissing()">üìã Copy Missing</button>
        </div>
        <div class="progress-container">
            <div class="progress-bar" style="width: ${percentage}%"></div>
        </div>
        <div class="dash-stats">
            <span style="color:#166534">‚úÖ Own: ${res.found.length} cards</span>
            <span style="color:#991b1b">‚ùå Need: ${res.missing.length} cards</span>
        </div>
    </div>`;

    // 1. MISSING SECTION (RED PILE)
    if(res.missing.length > 0) {
        div.innerHTML += `<div class="deck-section-title" style="color:#991b1b; border-color:#fecaca;">üõí Missing Cards</div>`;
        let missingGrid = `<div class="collection-grid">`;
        res.missing.forEach(item => {
            let searchName = item.name.replace(/\[.*\]|\(.*\)/g, '').trim(); 
            const imgUrl = `https://api.scryfall.com/cards/named?exact=${encodeURIComponent(searchName)}&format=image`;
            
            missingGrid += `
            <div class="grid-card missing-card" onclick="window.open('https://scryfall.com/search?q=${encodeURIComponent(item.name)}','_blank')">
                <div class="missing-badge-overlay">Need ${item.req}</div>
                <img src="${imgUrl}" loading="lazy">
                <div class="grid-overlay">
                    <div class="grid-price">Buy</div>
                    <div class="grid-meta"><span>${item.name}</span></div>
                </div>
            </div>`;
        });
        missingGrid += `</div>`;
        div.innerHTML += missingGrid;
    }

    // 2. FOUND SECTION (GREEN PILE)
    if(res.found.length > 0) {
        div.innerHTML += `<div class="deck-section-title" style="color:#166534; border-color:#bbf7d0;">‚úÖ In Collection</div>`;
        let foundGrid = `<div class="collection-grid">`;
        res.found.forEach(item => {
            let locSummary = item.locations.map(loc => {
                if (loc.location.includes("Deck")) {
                    return `‚Äî ${loc.location} ‚Äî (${loc.qty}x)`;
                }
                return `${loc.location} (${loc.qty}x)`;
            }).join(' | ');
            
            let locs = item.locations.map(l => `${l.set} (${l.location})`).join("\n");
            
            foundGrid += `
            <div class="grid-card" title="${locs}">
                <div class="missing-badge-overlay" style="background:#166534;">Have ${item.have}</div>
                <img src="${item.image}" loading="lazy">
                <div class="grid-overlay">
                    <div class="grid-price">‚úÖ Owned</div>
                    <div class="grid-meta" style="flex-direction: column;">
                        <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%;">${item.name}</span>
                        <span style="font-size: 9px; color: #a1a1aa; margin-top: 2px;">${locSummary}</span>
                    </div>
                </div>
            </div>`;
        });
        foundGrid += `</div>`;
        div.innerHTML += foundGrid;
    }
    
    window.missingCardsList = res.missing.map(m => `${m.req} ${m.name}`).join("\n");
}

function copyMissing() {
    if(!window.missingCardsList) { alert("Nothing to copy!"); return; }
    
    navigator.clipboard.writeText(window.missingCardsList).then(() => {
        alert("Shopping list copied! The list uses the format: [Quantity] [Card Name].");
    });
}


// EXISTING LOGIC
const search = document.getElementById('search');
const suggs = document.getElementById('suggestions');
search.addEventListener('input', function(e) {
  const q = e.target.value;
  clearTimeout(debounceTimer);
  if(q.length < 3) { suggs.style.display='none'; return; }
  debounceTimer = setTimeout(async function() {
    fetch('https://api.scryfall.com/cards/autocomplete?q=' + encodeURIComponent(q))
      .then(r => r.json()).then(json => {
         if(json.data) {
            suggs.innerHTML = '';
            json.data.forEach(n => {
               const d = document.createElement('div');
               d.className='s-item'; d.innerText=n;
               d.onclick = function() { selectCard(n); };
               suggs.appendChild(d);
            });
            suggs.style.display='block';
         }
      });
  }, 300);
});

async function selectCard(name) {
  search.value = name; suggs.style.display='none';
  document.getElementById('bigPrice').innerText = 'Loading...';
  document.getElementById('verGrp').style.display='block';
  document.getElementById('versionSelect').innerHTML = '<option>Loading...</option>';
  
  const response = await callAPI('getCardVersionsEncoded', { name: name });

  if (response.success) {
    versionsRx(response.data);
  }
}

function versionsRx(json) {
  const vers = JSON.parse(json);
  const sel = document.getElementById('versionSelect');
  sel.innerHTML = '';
  
  if (vers.length === 0) {
    sel.innerHTML = '<option>No versions found</option>';
    document.getElementById('copyNameBtn').disabled = false;
    updateUI();
    return;
  }

  let cheapestPrice = Infinity;
  let bestVersionIndex = 0;
  const commonSetCodes = ["CMD", "CMA", "C13", "C14", "C15", "C16", "C17", "C18", "C19", "C20", "C21", "C22", "C23", "C24", "CC1", "CC2", "KMC", "CMR", "CLB", "2X2", "2XM", "CMT"];

  vers.forEach((v, index) => {
     const opt = document.createElement('option');
     opt.value = JSON.stringify(v);
     const sName = v.setName ? v.setName : v.set;
     opt.text = `${sName} (${v.set}) #${v.code} (${v.year})`;
     sel.add(opt);
     
     const normalPrice = v.prices.USD.normal || Infinity;
     
     if (commonSetCodes.includes(v.set.toUpperCase())) {
         bestVersionIndex = index;
     } 
     else if (normalPrice < cheapestPrice) {
         cheapestPrice = normalPrice;
         bestVersionIndex = index;
     }
  });
  
  sel.selectedIndex = bestVersionIndex;
  document.getElementById('copyNameBtn').disabled = false;

  updateUI();
}


function updateUI() {
  const sel = document.getElementById('versionSelect');
  if(sel.value) currentCardData = JSON.parse(sel.value);
  document.getElementById('setCode').value = currentCardData.set;
  document.getElementById('colNum').value = currentCardData.code;
  const img = document.getElementById('cardPreview');
  if(currentCardData.image) { img.src = currentCardData.image; img.style.display='block'; }
  calculateTotalValue();
}

function calculateTotalValue() {
  const qty = parseInt(document.getElementById('quantityInput').value)||1;
  const isFoil = document.getElementById('foil-on').checked;
  const currency = document.getElementById('currencySelect').value;
  let p = 0, sym = "$";
  if (currentCardData && currentCardData.prices) {
      if(currency==='EUR') { p = isFoil ? currentCardData.prices.EUR.foil : currentCardData.prices.EUR.normal; sym="‚Ç¨"; } 
      else if(currency==='CAD') { p = isFoil ? currentCardData.prices.CAD.foil : currentCardData.prices.CAD.normal; sym="C$"; } 
      else { p = isFoil ? currentCardData.prices.USD.foil : currentCardData.prices.USD.normal; }
  }
  document.getElementById('cardPriceInput').value = p;
  document.getElementById('bigPrice').innerText = sym + (p||0).toFixed(2);
  document.getElementById('totalValue').innerText = sym + ((p||0)*qty).toFixed(2);
}

async function submitForm(f) {
  document.getElementById('subBtn').disabled=true;
  
  const formData = {
      setCode: document.getElementById('setCode').value,
      colNum: document.getElementById('colNum').value,
      quantity: document.getElementById('quantityInput').value,
      isFoil: document.getElementById('foil-on').checked,
      cardLocation: document.getElementById('locationInput').value,
      cardName: document.getElementById('search').value,
      cardPrice: document.getElementById('cardPriceInput').value
  };

  const response = await callAPI('processForm', formData);

  document.getElementById('subBtn').disabled=false;

  if (response.success) {
      alert("Added!");
      f.reset();
      document.getElementById('search').value='';
      document.getElementById('bigPrice').innerText='--';
      document.getElementById('totalValue').innerText='$0.00';
      document.getElementById('cardPreview').style.display='none';
      document.getElementById('verGrp').style.display='none';
      currentCardData = null;
      document.getElementById('copyNameBtn').disabled = true;

      loadLocations();
  }
}

function exportCSV(btn) {
    alert("CSV export is not yet implemented in the Hybrid Client API.");
}

async function loadCollection() {
  document.getElementById('collectionList').innerText = 'Loading...';

  const response = await callAPI('getCollectionData');
  
  if (response.success) {
    rawCollectionData = response.data;
    filterCollection();
    
    const locResponse = await callAPI('getUniqueLocations');
    if (locResponse.success) {
        populateCollectionFilter(locResponse.data);
    }
  } else {
    document.getElementById('collectionList').innerText = 'Error loading collection.';
  }
}

function toggleViewMode() {
    viewMode = (viewMode === 'list') ? 'grid' : 'list';
    document.getElementById('viewToggle').innerText = (viewMode === 'list') ? "Show Grid ‚ñ¶" : "Show List ‚ò∞";
    filterCollection();
}

function filterCollection() {
  const q = document.getElementById('collectionSearch').value.toLowerCase();
  const selectedLocation = document.getElementById('locationFilter').value;
  
  const list = rawCollectionData.filter(c => 
     (c.Name.toLowerCase().includes(q) || c.SetCode.toLowerCase().includes(q) || (c.Location||"").toLowerCase().includes(q))
     && (selectedLocation === "" || c.Location === selectedLocation)
  );
  
  const div = document.getElementById('collectionList');
  div.innerHTML = '';
  
  if (viewMode === 'grid') {
      div.className = 'collection-grid';
      list.forEach(c => {
         const safeSet = c.SetCode.replace(/'/g, "\\'");
         const safeCode = c.Code.replace(/'/g, "\\'");
         div.innerHTML += `
         <div class="grid-card">
            <button class="grid-del" onclick="del('${safeSet}','${safeCode}',${c.Finish==='Foil'})">√ó</button>
            <img src="${c.ImageURL}" loading="lazy">
            <div class="grid-overlay">
                <div class="grid-price">$${c.TotalValue}</div>
                <div class="grid-meta"><span>${c.Finish==='Foil'?'‚ú®':''} x${c.Quantity}</span><span>${c.Location.substring(0,8)}...</span></div>
            </div>
         </div>`;
      });
  } else {
      div.className = '';
      list.forEach(c => {
         const safeSet = c.SetCode.replace(/'/g, "\\'");
         const safeCode = c.Code.replace(/'/g, "\\'");
         div.innerHTML += `
         <div class="list-item">
            <img src="${c.ImageURL}">
            <div class="list-details"><div class="list-name">${c.Name}</div><div class="list-meta">${c.SetCode} #${c.Code} ‚Ä¢ ${c.Location}</div></div>
            <div class="list-value">$${c.TotalValue} <button class="delete-btn" onclick="del('${safeSet}','${safeCode}',${c.Finish==='Foil'})">x</button></div>
         </div>`;
      });
  }
}

async function del(s,c,f) {
   if(confirm("Delete this card?")) {
       const response = await callAPI('deleteCardRow', { s: s, c: c, f: f });
       if (response.success) {
           loadCollection();
       } else {
           alert("Failed to delete card.");
       }
   }
}

async function updatePrices(btn) {
    btn.disabled = true;
    btn.innerText = "Updating...";
    
    const response = await callAPI('refreshCollectionPrices');

    btn.disabled = false;
    btn.innerText = "üîÑ Update Prices";

    if (response.success) {
        alert(`Prices updated! Updated ${response.data.updatedCount} rows.`);
        loadCollection();
    } else {
        alert("Failed to update prices.");
    }
}

async function loadAnalytics() { 
    const response = await callAPI('getAnalyticsData');

    if (response.success) {
        renderAnalytics(response.data);
    } else {
        document.getElementById('stat-count').innerText = '--';
        document.getElementById('stat-value').innerText = '--';
        document.getElementById('moversList').innerHTML = 'Error loading data.';
        document.getElementById('topCardsList').innerHTML = 'Error loading data.';
    }
}

function renderAnalytics(data) {
   if(!data) return;
   
   // 1. STATS
   document.getElementById('stat-count').innerText = data.totalCards;
   document.getElementById('stat-value').innerText = "$" + data.totalValue;
   
   // 2. MOVERS LIST
   const mov = document.getElementById('moversList');
   mov.innerHTML = '';
   if(data.biggestMovers.length===0) mov.innerHTML="<div style='text-align:center;color:#888'>No Movers</div>";
   data.biggestMovers.forEach(c => {
      const col = c.change>=0?'#10b981':'#ef4444';
      const s = c.change>=0?'+':'';
      mov.innerHTML += `<div class="top-card-row"><div style="flex:1">${c.name}</div><div style="font-weight:bold;color:${col}">${s}$${c.change.toFixed(2)}</div></div>`;
   });
   
   // 3. TOP CARDS LIST
   const topCardsList = document.getElementById('topCardsList');
   topCardsList.innerHTML = '';
   data.topCards.forEach(c => {
      topCardsList.innerHTML += `<div class="top-card-row"><div style="flex:1">${c.name}</div><div style="font-weight:bold;color:#059669">$${c.price}</div></div>`;
   });

   // 4. CHARTS
   // A. Color Distribution
   const ctxColor = document.getElementById('colorChart').getContext('2d');
   if (charts.color) charts.color.destroy();
   charts.color = new Chart(ctxColor, {
       type: 'doughnut',
       data: {
           labels: ['White', 'Blue', 'Black', 'Red', 'Green', 'Multi', 'Colorless'],
           datasets: [{
               data: [
                   data.colors.W, data.colors.U, data.colors.B, data.colors.R, 
                   data.colors.G, data.colors.Multi, data.colors.Colorless
               ],
               backgroundColor: [
                   '#f0f2c9', '#b3ceea', '#aeb2b7', '#eaa6a5', '#b6d7a8', '#dcc689', '#d7d7d7'
               ]
           }]
       },
       options: { responsive: true, maintainAspectRatio: false }
   });

   // B. Rarity Breakdown
   const ctxRarity = document.getElementById('rarityChart').getContext('2d');
   if (charts.rarity) charts.rarity.destroy();
   charts.rarity = new Chart(ctxRarity, {
       type: 'bar',
       data: {
           labels: ['Common', 'Uncommon', 'Rare', 'Mythic'],
           datasets: [{
               label: 'Count',
               data: [
                   data.rarity.common, data.rarity.uncommon, 
                   data.rarity.rare, data.rarity.mythic
               ],
               backgroundColor: ['#0f172a', '#94a3b8', '#d4af37', '#ef4444']
           }]
       },
       options: { 
           responsive: true, 
           maintainAspectRatio: false,
           scales: { y: { beginAtZero: true } }
       }
   });
}

window.onload = function() {
    init();
};
</script>
</body>
</html>
